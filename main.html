<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dominik Filliger &amp; Noah Leuenberger">

<title>AML Mini-Challenge - Credit Card Affinity Modelling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="main_files/libs/clipboard/clipboard.min.js"></script>
<script src="main_files/libs/quarto-html/quarto.js"></script>
<script src="main_files/libs/quarto-html/popper.min.js"></script>
<script src="main_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="main_files/libs/quarto-html/anchor.min.js"></script>
<link href="main_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="main_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="main_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="main_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="main_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script type="text/javascript">
window.PlotlyConfig = {MathJaxConfig: 'local'};
if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}
if (typeof require !== 'undefined') {
require.undef("plotly");
requirejs.config({
    paths: {
        'plotly': ['https://cdn.plot.ly/plotly-2.32.0.min']
    }
});
require(['plotly'], function(Plotly) {
    window._Plotly = Plotly;
});
}
</script>



</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#helper-functions" id="toc-helper-functions" class="nav-link" data-scroll-target="#helper-functions">Helper Functions</a></li>
  </ul></li>
  <li><a href="#data-import-wrangling" id="toc-data-import-wrangling" class="nav-link" data-scroll-target="#data-import-wrangling">Data Import &amp; Wrangling</a>
  <ul class="collapse">
  <li><a href="#accounts" id="toc-accounts" class="nav-link" data-scroll-target="#accounts">Accounts</a></li>
  <li><a href="#clients" id="toc-clients" class="nav-link" data-scroll-target="#clients">Clients</a></li>
  <li><a href="#dispositions" id="toc-dispositions" class="nav-link" data-scroll-target="#dispositions">Dispositions</a></li>
  <li><a href="#orders" id="toc-orders" class="nav-link" data-scroll-target="#orders">Orders</a></li>
  <li><a href="#transactions" id="toc-transactions" class="nav-link" data-scroll-target="#transactions">Transactions</a></li>
  <li><a href="#loans" id="toc-loans" class="nav-link" data-scroll-target="#loans">Loans</a></li>
  <li><a href="#credit-cards" id="toc-credit-cards" class="nav-link" data-scroll-target="#credit-cards">Credit Cards</a></li>
  <li><a href="#demographic-data" id="toc-demographic-data" class="nav-link" data-scroll-target="#demographic-data">Demographic data</a></li>
  </ul></li>
  <li><a href="#relationships" id="toc-relationships" class="nav-link" data-scroll-target="#relationships">Relationships</a></li>
  <li><a href="#non-transactional-data" id="toc-non-transactional-data" class="nav-link" data-scroll-target="#non-transactional-data">Non-transactional Data</a>
  <ul class="collapse">
  <li><a href="#eda" id="toc-eda" class="nav-link" data-scroll-target="#eda">EDA</a>
  <ul class="collapse">
  <li><a href="#card-holders" id="toc-card-holders" class="nav-link" data-scroll-target="#card-holders">Card Holders</a></li>
  <li><a href="#time-factors-on-card-status" id="toc-time-factors-on-card-status" class="nav-link" data-scroll-target="#time-factors-on-card-status">Time factors on Card Status</a></li>
  <li><a href="#demographics" id="toc-demographics" class="nav-link" data-scroll-target="#demographics">Demographics</a></li>
  <li><a href="#impact-of-loans-debt" id="toc-impact-of-loans-debt" class="nav-link" data-scroll-target="#impact-of-loans-debt">Impact of Loans / Debt</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#transactional-data" id="toc-transactional-data" class="nav-link" data-scroll-target="#transactional-data">Transactional Data</a>
  <ul class="collapse">
  <li><a href="#set-artificial-issue-date-for-non-card-holders" id="toc-set-artificial-issue-date-for-non-card-holders" class="nav-link" data-scroll-target="#set-artificial-issue-date-for-non-card-holders">Set artificial issue date for non-card holders</a>
  <ul class="collapse">
  <li><a href="#match-by-similar-transaction-activity" id="toc-match-by-similar-transaction-activity" class="nav-link" data-scroll-target="#match-by-similar-transaction-activity">Match by similar transaction activity</a></li>
  <li><a href="#focus-on-contextual-engagement" id="toc-focus-on-contextual-engagement" class="nav-link" data-scroll-target="#focus-on-contextual-engagement">Focus on Contextual Engagement</a></li>
  <li><a href="#mechanism-of-matching" id="toc-mechanism-of-matching" class="nav-link" data-scroll-target="#mechanism-of-matching">Mechanism of Matching</a></li>
  <li><a href="#eligibility-and-selection" id="toc-eligibility-and-selection" class="nav-link" data-scroll-target="#eligibility-and-selection">Eligibility and Selection</a></li>
  <li><a href="#objective-of-the-process" id="toc-objective-of-the-process" class="nav-link" data-scroll-target="#objective-of-the-process">Objective of the Process</a></li>
  <li><a href="#construction-of-the-activity-matrix" id="toc-construction-of-the-activity-matrix" class="nav-link" data-scroll-target="#construction-of-the-activity-matrix">Construction of the Activity Matrix</a></li>
  </ul></li>
  <li><a href="#aggregate-transactions-on-a-monthly-basis" id="toc-aggregate-transactions-on-a-monthly-basis" class="nav-link" data-scroll-target="#aggregate-transactions-on-a-monthly-basis">Aggregate Transactions on a Monthly Basis</a>
  <ul class="collapse">
  <li><a href="#monthly-balance-difference-and-volume" id="toc-monthly-balance-difference-and-volume" class="nav-link" data-scroll-target="#monthly-balance-difference-and-volume">Monthly Balance Difference and Volume</a></li>
  <li><a href="#monthly-transactions-balance-and-volume-plot-explanation" id="toc-monthly-transactions-balance-and-volume-plot-explanation" class="nav-link" data-scroll-target="#monthly-transactions-balance-and-volume-plot-explanation">Monthly Transactions, Balance, and Volume Plot Explanation</a></li>
  <li><a href="#delieverable-closer-look-at-account-14-and-18" id="toc-delieverable-closer-look-at-account-14-and-18" class="nav-link" data-scroll-target="#delieverable-closer-look-at-account-14-and-18">Delieverable: Closer Look at account 14 and 18</a></li>
  </ul></li>
  <li><a href="#rolling-window-aggregations-for-card-holders" id="toc-rolling-window-aggregations-for-card-holders" class="nav-link" data-scroll-target="#rolling-window-aggregations-for-card-holders">Rolling Window Aggregations for Card Holders</a></li>
  </ul></li>
  <li><a href="#merge-everything-together" id="toc-merge-everything-together" class="nav-link" data-scroll-target="#merge-everything-together">Merge everything together</a></li>
  <li><a href="#model-construction" id="toc-model-construction" class="nav-link" data-scroll-target="#model-construction">Model Construction</a></li>
  <li><a href="#model-engineering" id="toc-model-engineering" class="nav-link" data-scroll-target="#model-engineering">Model Engineering</a></li>
  <li><a href="#model-comparison-selection" id="toc-model-comparison-selection" class="nav-link" data-scroll-target="#model-comparison-selection">Model Comparison &amp; Selection</a></li>
  <li><a href="#workbench---remove-later" id="toc-workbench---remove-later" class="nav-link" data-scroll-target="#workbench---remove-later">WORKBENCH - remove later</a>
  <ul class="collapse">
  <li><a href="#some-older-input" id="toc-some-older-input" class="nav-link" data-scroll-target="#some-older-input">Some older input</a></li>
  <li><a href="#jitt-05.03.24" id="toc-jitt-05.03.24" class="nav-link" data-scroll-target="#jitt-05.03.24">JITT 05.03.24</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">AML Mini-Challenge - Credit Card Affinity Modelling</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dominik Filliger &amp; Noah Leuenberger </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p>Dominik Filliger &amp; Noah Leuenberger</p>
</blockquote>
<p>The task can be found <a href="https://spaces.technik.fhnw.ch/storage/uploads/spaces/82/exercises/20240218__AML_Trainingscenter_MiniChallenge_Kreditkarten_Aufgabenstellung-1708412668.pdf">here</a>.</p>
<section id="setup" class="level1">
<h1>Setup</h1>
<div id="c3539235" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>sns.set_theme()</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.style.use('seaborn-white')</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.style.use('ggplot')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="helper-functions" class="level2">
<h2 class="anchored" data-anchor-id="helper-functions">Helper Functions</h2>
<div id="25a6afc5" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_categorical_variables(df, categorical_columns, fill_na_value<span class="op">=</span><span class="st">'NA'</span>):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Plots count plots for categorical variables in a DataFrame, filling NA values with a specified string.</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">    - df: pandas.DataFrame containing the data.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - categorical_vars: list of strings, names of the categorical variables in df to plot.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">    - fill_na_value: string, the value to use for filling NA values in the categorical variables.</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill NA values in the specified categorical variables</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> categorical_columns:</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> df[var].isna().<span class="bu">any</span>():</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>            df[var] <span class="op">=</span> df[var].fillna(fill_na_value)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="bu">float</span>(<span class="bu">len</span>(df))</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="bu">len</span>(categorical_columns), figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="bu">len</span>(categorical_columns) <span class="op">*</span> <span class="fl">4.5</span>))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(categorical_columns) <span class="op">==</span> <span class="dv">1</span>:  <span class="co"># If there's only one categorical variable, wrap axes in a list</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        axes <span class="op">=</span> [axes]</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, var <span class="kw">in</span> <span class="bu">enumerate</span>(categorical_columns):</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> sns.countplot(x<span class="op">=</span>var, data<span class="op">=</span>df, ax<span class="op">=</span>axes[i], order<span class="op">=</span>df[var].value_counts().index)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        axes[i].set_title(<span class="ss">f'Distribution of </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        axes[i].set_ylabel(<span class="st">'Count'</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        axes[i].set_xlabel(var)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> ax.patches:</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            height <span class="op">=</span> p.get_height()</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>            ax.text(p.get_x() <span class="op">+</span> p.get_width() <span class="op">/</span> <span class="fl">2.</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>                    height <span class="op">+</span> <span class="dv">3</span>,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'</span><span class="sc">{:1.2f}</span><span class="st">%'</span>.<span class="bu">format</span>((height <span class="op">/</span> total) <span class="op">*</span> <span class="dv">100</span>),</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">"center"</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_numerical_distributions(df, numerical_columns, kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">30</span>):</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Plots the distribution of all numerical variables in a DataFrame.</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="co">    - df: pandas.DataFrame containing the data.</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the number of rows needed for subplots based on the number of numerical variables</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    nrows <span class="op">=</span> <span class="bu">len</span>(numerical_columns)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create subplots</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(nrows<span class="op">=</span>nrows, ncols<span class="op">=</span><span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span> <span class="op">*</span> nrows))</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> nrows <span class="op">==</span> <span class="dv">1</span>:  <span class="co"># If there's only one numerical variable, wrap axes in a list</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        axes <span class="op">=</span> [axes]</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, var <span class="kw">in</span> <span class="bu">enumerate</span>(numerical_columns):</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>        sns.histplot(df[var], ax<span class="op">=</span>axes[i], kde<span class="op">=</span>kde, bins<span class="op">=</span>bins)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>        axes[i].set_title(<span class="ss">f'Distribution of </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>        axes[i].set_xlabel(var)</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>        axes[i].set_ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_date_monthly_counts(df, date_column, title):</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a><span class="co">    Plots the monthly counts of a date column in a DataFrame.</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="co">    - df: pandas.DataFrame containing the data.</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a><span class="co">    - date_column: string, name of the date column in df to plot.</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a><span class="co">    - title: string, title of the plot.</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    df[date_column] <span class="op">=</span> pd.to_datetime(df[date_column])</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'month'</span>] <span class="op">=</span> df[date_column].dt.to_period(<span class="st">'M'</span>)</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    monthly_counts <span class="op">=</span> df[<span class="st">'month'</span>].value_counts().sort_index()</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    monthly_counts.plot(kind<span class="op">=</span><span class="st">'bar'</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Month'</span>)</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Count'</span>)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_percentage_labels(ax, hue_order):</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> ax.patches:</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> p.get_height()</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>        width <span class="op">=</span> p.get_width()</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> p.get_x()</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> p.get_y()</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>        label_text <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>height<span class="sc">:.1f}</span><span class="ss">%'</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>        label_x <span class="op">=</span> x <span class="op">+</span> width <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>        label_y <span class="op">=</span> y <span class="op">+</span> height <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>        ax.text(label_x, label_y, label_text, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>, color<span class="op">=</span><span class="st">'white'</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="aab54a60" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> OrderedDict</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data_reduction <span class="op">=</span> OrderedDict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="data-import-wrangling" class="level1">
<h1>Data Import &amp; Wrangling</h1>
<div id="3f1963d7" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remap_values(df, column, mapping):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># assert that all values in the column are in the mapping except for NaN</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> df[column].dropna().isin(mapping.keys()).<span class="bu">all</span>()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    df[column] <span class="op">=</span> df[column].<span class="bu">map</span>(mapping, na_action<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> map_empty_to_nan(df, column):</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df[column].dtype <span class="op">!=</span> <span class="st">'object'</span>:</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    df[column] <span class="op">=</span> df[column].replace(<span class="vs">r'^\s*$'</span>, np.nan, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_csv(file_path, sep<span class="op">=</span><span class="st">";"</span>, dtypes<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(file_path, sep<span class="op">=</span>sep, dtype<span class="op">=</span>dtypes)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> map_empty_to_nan(df, col)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="accounts" class="level2">
<h2 class="anchored" data-anchor-id="accounts">Accounts</h2>
<div id="6a0d1eaf" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>accounts_df <span class="op">=</span> read_csv(<span class="st">"data/account.csv"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Translated frequency from Czech to English</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># according to https://sorry.vse.cz/~berka/challenge/PAST/index.html</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>accounts_df <span class="op">=</span> remap_values(accounts_df, <span class="st">'frequency'</span>, {</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"POPLATEK MESICNE"</span>: <span class="st">"MONTHLY_ISSUANCE"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"POPLATEK TYDNE"</span>: <span class="st">"WEEKLY_ISSUANCE"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"POPLATEK PO OBRATU"</span>: <span class="st">"ISSUANCE_AFTER_TRANSACTION"</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>accounts_df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(accounts_df[<span class="st">'date'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%y%m</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>accounts_df.rename(columns<span class="op">=</span>{<span class="st">'date'</span>: <span class="st">'account_created'</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'frequency'</span>: <span class="st">'account_frequency'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>data_reduction[<span class="st">"Total number of accounts"</span>] <span class="op">=</span> <span class="bu">len</span>(accounts_df)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>accounts_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 4500 entries, 0 to 4499
Data columns (total 4 columns):
 #   Column             Non-Null Count  Dtype         
---  ------             --------------  -----         
 0   account_id         4500 non-null   int64         
 1   district_id        4500 non-null   int64         
 2   account_frequency  4500 non-null   object        
 3   account_created    4500 non-null   datetime64[ns]
dtypes: datetime64[ns](1), int64(2), object(1)
memory usage: 140.8+ KB</code></pre>
</div>
</div>
<div id="12bcf3b4" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># todo add some basic eda here</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>accounts_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">district_id</th>
<th data-quarto-table-cell-role="th">account_frequency</th>
<th data-quarto-table-cell-role="th">account_created</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>576</td>
<td>55</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3818</td>
<td>74</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>704</td>
<td>55</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2378</td>
<td>16</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2632</td>
<td>24</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-02</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="8a600b0b" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>accounts_df.nunique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>account_id           4500
district_id            77
account_frequency       3
account_created      1535
dtype: int64</code></pre>
</div>
</div>
<div id="8d614798" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>plot_categorical_variables(accounts_df, [<span class="st">'account_frequency'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-9-output-1.png" width="1329" height="414" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="028e4284" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>plot_numerical_distributions(accounts_df, [<span class="st">'account_created'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-10-output-1.png" width="753" height="463" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="clients" class="level2">
<h2 class="anchored" data-anchor-id="clients">Clients</h2>
<div id="ab92dc63" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>clients_df <span class="op">=</span> read_csv(<span class="st">"data/client.csv"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_birth_number(birth_number):</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    birth_number_str <span class="op">=</span> <span class="bu">str</span>(birth_number)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract year, month, and day from birth number from string</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># according to https://sorry.vse.cz/~berka/challenge/PAST/index.html</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    year <span class="op">=</span> <span class="bu">int</span>(birth_number_str[:<span class="dv">2</span>])</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    month <span class="op">=</span> <span class="bu">int</span>(birth_number_str[<span class="dv">2</span>:<span class="dv">4</span>])</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    day <span class="op">=</span> <span class="bu">int</span>(birth_number_str[<span class="dv">4</span>:<span class="dv">6</span>])</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine sex based on month and adjust month for female clients</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># according to https://sorry.vse.cz/~berka/challenge/PAST/index.html</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> month <span class="op">&gt;</span> <span class="dv">50</span>:</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        sex <span class="op">=</span> <span class="st">"Female"</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        month <span class="op">-=</span> <span class="dv">50</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        sex <span class="op">=</span> <span class="st">"Male"</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate date</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="dv">1</span> <span class="op">&lt;=</span> month <span class="op">&lt;=</span> <span class="dv">12</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="dv">1</span> <span class="op">&lt;=</span> day <span class="op">&lt;=</span> <span class="dv">31</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="dv">0</span> <span class="op">&lt;=</span> year <span class="op">&lt;=</span> <span class="dv">99</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> month <span class="kw">in</span> [<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">11</span>]:</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="dv">1</span> <span class="op">&lt;=</span> day <span class="op">&lt;=</span> <span class="dv">30</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> month <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="dv">1</span> <span class="op">&lt;=</span> day <span class="op">&lt;=</span> <span class="dv">29</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="dv">1</span> <span class="op">&lt;=</span> day <span class="op">&lt;=</span> <span class="dv">31</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assuming all dates are in the 1900s</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    birth_date <span class="op">=</span> datetime(<span class="dv">1900</span> <span class="op">+</span> year, month, day)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series([sex, birth_date])</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>clients_df[[<span class="st">'sex'</span>, <span class="st">'birth_date'</span>]] <span class="op">=</span> clients_df[<span class="st">'birth_number'</span>].<span class="bu">apply</span>(parse_birth_number)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate 'age' assuming the reference year is 1999</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>clients_df[<span class="st">'age'</span>] <span class="op">=</span> clients_df[<span class="st">'birth_date'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1999</span> <span class="op">-</span> x.year)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop 'birth_number' column as it is no longer needed</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>clients_df <span class="op">=</span> clients_df.drop(columns<span class="op">=</span>[<span class="st">'birth_number'</span>])</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>clients_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 5369 entries, 0 to 5368
Data columns (total 5 columns):
 #   Column       Non-Null Count  Dtype         
---  ------       --------------  -----         
 0   client_id    5369 non-null   int64         
 1   district_id  5369 non-null   int64         
 2   sex          5369 non-null   object        
 3   birth_date   5369 non-null   datetime64[ns]
 4   age          5369 non-null   int64         
dtypes: datetime64[ns](1), int64(3), object(1)
memory usage: 209.9+ KB</code></pre>
</div>
</div>
<div id="d6ac1cc4" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># todo add some basic eda here</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>clients_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">client_id</th>
<th data-quarto-table-cell-role="th">district_id</th>
<th data-quarto-table-cell-role="th">sex</th>
<th data-quarto-table-cell-role="th">birth_date</th>
<th data-quarto-table-cell-role="th">age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>18</td>
<td>Female</td>
<td>1970-12-13</td>
<td>29</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>1</td>
<td>Male</td>
<td>1945-02-04</td>
<td>54</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>1</td>
<td>Female</td>
<td>1940-10-09</td>
<td>59</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>5</td>
<td>Male</td>
<td>1956-12-01</td>
<td>43</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>5</td>
<td>Female</td>
<td>1960-07-03</td>
<td>39</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="3e21e922" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>clients_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">client_id</th>
<th data-quarto-table-cell-role="th">district_id</th>
<th data-quarto-table-cell-role="th">birth_date</th>
<th data-quarto-table-cell-role="th">age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>5369.000000</td>
<td>5369.000000</td>
<td>5369</td>
<td>5369.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>3359.011920</td>
<td>37.310114</td>
<td>1953-09-12 09:32:21.143602176</td>
<td>45.801639</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1911-08-20 00:00:00</td>
<td>12.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25%</td>
<td>1418.000000</td>
<td>14.000000</td>
<td>1940-11-25 00:00:00</td>
<td>31.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50%</td>
<td>2839.000000</td>
<td>38.000000</td>
<td>1954-05-06 00:00:00</td>
<td>45.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75%</td>
<td>4257.000000</td>
<td>60.000000</td>
<td>1968-06-09 00:00:00</td>
<td>59.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">max</td>
<td>13998.000000</td>
<td>77.000000</td>
<td>1987-09-27 00:00:00</td>
<td>88.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>2832.911984</td>
<td>25.043690</td>
<td>NaN</td>
<td>17.282283</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="67309c09" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>plot_numerical_distributions(clients_df, [<span class="st">'birth_date'</span>, <span class="st">'age'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-14-output-1.png" width="752" height="944" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dispositions" class="level2">
<h2 class="anchored" data-anchor-id="dispositions">Dispositions</h2>
<div id="1bde32f2" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dispositions_df <span class="op">=</span> read_csv(<span class="st">"data/disp.csv"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>dispositions_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 5369 entries, 0 to 5368
Data columns (total 4 columns):
 #   Column      Non-Null Count  Dtype 
---  ------      --------------  ----- 
 0   disp_id     5369 non-null   int64 
 1   client_id   5369 non-null   int64 
 2   account_id  5369 non-null   int64 
 3   type        5369 non-null   object
dtypes: int64(3), object(1)
memory usage: 167.9+ KB</code></pre>
</div>
</div>
<div id="fa1b70a8" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dispositions_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">disp_id</th>
<th data-quarto-table-cell-role="th">client_id</th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>OWNER</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>2</td>
<td>2</td>
<td>OWNER</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>3</td>
<td>2</td>
<td>DISPONENT</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>4</td>
<td>3</td>
<td>OWNER</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>5</td>
<td>3</td>
<td>DISPONENT</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="439416bf" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dispositions_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">disp_id</th>
<th data-quarto-table-cell-role="th">client_id</th>
<th data-quarto-table-cell-role="th">account_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>5369.000000</td>
<td>5369.000000</td>
<td>5369.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>3337.097970</td>
<td>3359.011920</td>
<td>2767.496927</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>2770.418826</td>
<td>2832.911984</td>
<td>2307.843630</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>1418.000000</td>
<td>1418.000000</td>
<td>1178.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2839.000000</td>
<td>2839.000000</td>
<td>2349.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>4257.000000</td>
<td>4257.000000</td>
<td>3526.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>13690.000000</td>
<td>13998.000000</td>
<td>11382.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="8717682d" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plot_categorical_variables(dispositions_df, [<span class="st">'type'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-18-output-1.png" width="1329" height="416" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As the goal of this model is to address accounts and not client directly we will focus on the clients which own an account and focus solely on them.</p>
<div id="94fe4046" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>dispositions_df <span class="op">=</span> dispositions_df[dispositions_df[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'OWNER'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="orders" class="level2">
<h2 class="anchored" data-anchor-id="orders">Orders</h2>
<div id="e244c826" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>orders_df <span class="op">=</span> read_csv(<span class="st">"data/order.csv"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Translated from Czech to English</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># according to https://sorry.vse.cz/~berka/challenge/PAST/index.html</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>orders_df <span class="op">=</span> remap_values(orders_df, <span class="st">'k_symbol'</span>, {</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"POJISTNE"</span>: <span class="st">"Insurance_Payment"</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SIPO"</span>: <span class="st">"Household"</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"LEASING"</span>: <span class="st">"Leasing"</span>,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"UVER"</span>: <span class="st">"Loan_Payment"</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>orders_df[<span class="st">'account_to'</span>] <span class="op">=</span> orders_df[<span class="st">'account_to'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>orders_df <span class="op">=</span> orders_df.rename(columns<span class="op">=</span>{<span class="st">'amount'</span>: <span class="st">'debited_amount'</span>})</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>orders_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 6471 entries, 0 to 6470
Data columns (total 6 columns):
 #   Column          Non-Null Count  Dtype   
---  ------          --------------  -----   
 0   order_id        6471 non-null   int64   
 1   account_id      6471 non-null   int64   
 2   bank_to         6471 non-null   object  
 3   account_to      6471 non-null   category
 4   debited_amount  6471 non-null   float64 
 5   k_symbol        5092 non-null   object  
dtypes: category(1), float64(1), int64(2), object(2)
memory usage: 573.9+ KB</code></pre>
</div>
</div>
<div id="8787c077" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>orders_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">order_id</th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">bank_to</th>
<th data-quarto-table-cell-role="th">account_to</th>
<th data-quarto-table-cell-role="th">debited_amount</th>
<th data-quarto-table-cell-role="th">k_symbol</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>29401</td>
<td>1</td>
<td>YZ</td>
<td>87144583</td>
<td>2452.0</td>
<td>Household</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>29402</td>
<td>2</td>
<td>ST</td>
<td>89597016</td>
<td>3372.7</td>
<td>Loan_Payment</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>29403</td>
<td>2</td>
<td>QR</td>
<td>13943797</td>
<td>7266.0</td>
<td>Household</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>29404</td>
<td>3</td>
<td>WX</td>
<td>83084338</td>
<td>1135.0</td>
<td>Household</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>29405</td>
<td>3</td>
<td>CD</td>
<td>24485939</td>
<td>327.0</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="630f4b96" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>orders_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">order_id</th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">debited_amount</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>6471.000000</td>
<td>6471.000000</td>
<td>6471.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>33778.197497</td>
<td>2962.302890</td>
<td>3280.635698</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>3737.681949</td>
<td>2518.503228</td>
<td>2714.475335</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>29401.000000</td>
<td>1.000000</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>31187.500000</td>
<td>1223.000000</td>
<td>1241.500000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>32988.000000</td>
<td>2433.000000</td>
<td>2596.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>34785.500000</td>
<td>3645.500000</td>
<td>4613.500000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>46338.000000</td>
<td>11362.000000</td>
<td>14882.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="2520443b" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>orders_df.nunique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>order_id          6471
account_id        3758
bank_to             13
account_to        6446
debited_amount    4412
k_symbol             4
dtype: int64</code></pre>
</div>
</div>
<p>There appear to be as many order ids as there are rows.</p>
<div id="61a93f5e" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>plot_categorical_variables(orders_df, [<span class="st">'k_symbol'</span>, <span class="st">'bank_to'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-24-output-1.png" width="1329" height="847" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="769adb6e" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>plot_numerical_distributions(orders_df, [<span class="st">'debited_amount'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-25-output-1.png" width="753" height="463" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="transactions" class="level2">
<h2 class="anchored" data-anchor-id="transactions">Transactions</h2>
<div id="1411d3f3" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># column 8 is the 'bank' column which contains NaNs and must be read as string</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>transactions_df <span class="op">=</span> read_csv(<span class="st">"data/trans.csv"</span>, dtypes<span class="op">=</span>{<span class="dv">8</span>: <span class="bu">str</span>})</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>transactions_df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(transactions_df[<span class="st">'date'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%y%m</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Translated type, operations and characteristics from Czech to English</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># according to https://sorry.vse.cz/~berka/challenge/PAST/index.html</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>transactions_df <span class="op">=</span> remap_values(transactions_df, <span class="st">'type'</span>, {</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"VYBER"</span>: <span class="st">"Withdrawal"</span>, <span class="co"># Also withdrawal as it is against the documentation present in the dataset</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PRIJEM"</span>: <span class="st">"Credit"</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"VYDAJ"</span>: <span class="st">"Withdrawal"</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>transactions_df <span class="op">=</span> remap_values(transactions_df, <span class="st">'operation'</span>, {</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"VYBER KARTOU"</span>: <span class="st">"Credit Card Withdrawal"</span>,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"VKLAD"</span>: <span class="st">"Credit in Cash"</span>,</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PREVOD Z UCTU"</span>: <span class="st">"Collection from Another Bank"</span>,</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"VYBER"</span>: <span class="st">"Withdrawal in Cash"</span>,</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PREVOD NA UCET"</span>: <span class="st">"Remittance to Another Bank"</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>transactions_df <span class="op">=</span> remap_values(transactions_df, <span class="st">'k_symbol'</span>, {</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"POJISTNE"</span>: <span class="st">"Insurance Payment"</span>,</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SLUZBY"</span>: <span class="st">"Payment on Statement"</span>,</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"UROK"</span>: <span class="st">"Interest Credited"</span>,</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SANKC. UROK"</span>: <span class="st">"Sanction Interest"</span>,</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SIPO"</span>: <span class="st">"Household"</span>,</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DUCHOD"</span>: <span class="st">"Old-age Pension"</span>,</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"UVER"</span>: <span class="st">"Loan Payment"</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the amount to negative for withdrawals and positive for credits</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>transactions_df[<span class="st">'amount'</span>] <span class="op">=</span> np.where(transactions_df[<span class="st">'type'</span>] <span class="op">==</span> <span class="st">"Credit"</span>, transactions_df[<span class="st">'amount'</span>], <span class="op">-</span>transactions_df[<span class="st">'amount'</span>])</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>transactions_df.rename(columns<span class="op">=</span>{<span class="st">'type'</span>: <span class="st">'transaction_type'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>transactions_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1056320 entries, 0 to 1056319
Data columns (total 10 columns):
 #   Column            Non-Null Count    Dtype         
---  ------            --------------    -----         
 0   trans_id          1056320 non-null  int64         
 1   account_id        1056320 non-null  int64         
 2   date              1056320 non-null  datetime64[ns]
 3   transaction_type  1056320 non-null  object        
 4   operation         873206 non-null   object        
 5   amount            1056320 non-null  float64       
 6   balance           1056320 non-null  float64       
 7   k_symbol          521006 non-null   object        
 8   bank              273508 non-null   object        
 9   account           295389 non-null   float64       
dtypes: datetime64[ns](1), float64(3), int64(2), object(4)
memory usage: 80.6+ MB</code></pre>
</div>
</div>
<div id="2fc4a88b" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>transactions_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">trans_id</th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">transaction_type</th>
<th data-quarto-table-cell-role="th">operation</th>
<th data-quarto-table-cell-role="th">amount</th>
<th data-quarto-table-cell-role="th">balance</th>
<th data-quarto-table-cell-role="th">k_symbol</th>
<th data-quarto-table-cell-role="th">bank</th>
<th data-quarto-table-cell-role="th">account</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>695247</td>
<td>2378</td>
<td>1993-01-01</td>
<td>Credit</td>
<td>Credit in Cash</td>
<td>700.0</td>
<td>700.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>171812</td>
<td>576</td>
<td>1993-01-01</td>
<td>Credit</td>
<td>Credit in Cash</td>
<td>900.0</td>
<td>900.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>207264</td>
<td>704</td>
<td>1993-01-01</td>
<td>Credit</td>
<td>Credit in Cash</td>
<td>1000.0</td>
<td>1000.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1117247</td>
<td>3818</td>
<td>1993-01-01</td>
<td>Credit</td>
<td>Credit in Cash</td>
<td>600.0</td>
<td>600.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>579373</td>
<td>1972</td>
<td>1993-01-02</td>
<td>Credit</td>
<td>Credit in Cash</td>
<td>400.0</td>
<td>400.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="c86b84ee" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>transactions_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">trans_id</th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">amount</th>
<th data-quarto-table-cell-role="th">balance</th>
<th data-quarto-table-cell-role="th">account</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>1.056320e+06</td>
<td>1.056320e+06</td>
<td>1056320</td>
<td>1.056320e+06</td>
<td>1.056320e+06</td>
<td>2.953890e+05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>1.335311e+06</td>
<td>2.936867e+03</td>
<td>1997-01-04 07:29:27.037261952</td>
<td>1.866397e+02</td>
<td>3.851833e+04</td>
<td>4.567092e+07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000e+00</td>
<td>1.000000e+00</td>
<td>1993-01-01 00:00:00</td>
<td>-8.740000e+04</td>
<td>-4.112570e+04</td>
<td>0.000000e+00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25%</td>
<td>4.302628e+05</td>
<td>1.204000e+03</td>
<td>1996-01-16 00:00:00</td>
<td>-3.019000e+03</td>
<td>2.240250e+04</td>
<td>1.782858e+07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50%</td>
<td>8.585065e+05</td>
<td>2.434000e+03</td>
<td>1997-04-10 00:00:00</td>
<td>-1.460000e+01</td>
<td>3.314340e+04</td>
<td>4.575095e+07</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75%</td>
<td>2.060979e+06</td>
<td>3.660000e+03</td>
<td>1998-02-28 00:00:00</td>
<td>2.000000e+02</td>
<td>4.960362e+04</td>
<td>7.201341e+07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">max</td>
<td>3.682987e+06</td>
<td>1.138200e+04</td>
<td>1998-12-31 00:00:00</td>
<td>7.481200e+04</td>
<td>2.096370e+05</td>
<td>9.999420e+07</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>1.227487e+06</td>
<td>2.477345e+03</td>
<td>NaN</td>
<td>1.121353e+04</td>
<td>2.211787e+04</td>
<td>3.066340e+07</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="cbe330d4" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>plot_categorical_variables(transactions_df, [<span class="st">'transaction_type'</span>, <span class="st">'operation'</span>, <span class="st">'k_symbol'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-29-output-1.png" width="1329" height="1279" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="e31b08e7" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>plot_numerical_distributions(transactions_df, [<span class="st">'date'</span>, <span class="st">'amount'</span>, <span class="st">'balance'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-30-output-1.png" width="752" height="1424" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looking at the distributions of the transaction table we can see that the count of transactions per year increase over time. So we can conclude that the bank has a growing client base.</p>
<p>However, the other plots are not very useful. For one the transaction amount seems to be very sparse, ranging from values between -80000 and 80000.</p>
<p>The balance distribution also showcases that there are accounts with a negative balance after a transaction, which would only make sense if debt is also included in this value.</p>
<p>According to description of the field balance: balance after transaction</p>
<div id="4f7fa356" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting a list of unique years from the dataset</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>transactions_df[<span class="st">'year'</span>] <span class="op">=</span> transactions_df[<span class="st">'date'</span>].dt.year</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>transactions_df[<span class="st">'month'</span>] <span class="op">=</span> transactions_df[<span class="st">'date'</span>].dt.month</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>months <span class="op">=</span> [<span class="st">'Jan'</span>, <span class="st">'Feb'</span>, <span class="st">'Mar'</span>, <span class="st">'Apr'</span>, <span class="st">'May'</span>, <span class="st">'Jun'</span>, <span class="st">'Jul'</span>, <span class="st">'Aug'</span>, <span class="st">'Sep'</span>, <span class="st">'Oct'</span>, <span class="st">'Nov'</span>, <span class="st">'Dec'</span>]</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>years <span class="op">=</span> <span class="bu">sorted</span>(transactions_df[<span class="st">'year'</span>].unique())</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a figure with subplots for each year: one row for each year with two plots (box plot and bar chart)</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="bu">len</span>(years) <span class="op">*</span> <span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">6</span> <span class="op">*</span> <span class="bu">len</span>(years)), sharex<span class="op">=</span><span class="va">True</span>, gridspec_kw<span class="op">=</span>{<span class="st">'height_ratios'</span>: [<span class="dv">3</span>, <span class="dv">1</span>] <span class="op">*</span> <span class="bu">len</span>(years)})</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, year <span class="kw">in</span> <span class="bu">enumerate</span>(years):</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter transactions for the current year</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    yearly_transactions <span class="op">=</span> transactions_df[transactions_df[<span class="st">'year'</span>] <span class="op">==</span> year]</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparing data for the box plot: a list of amounts for each month for the current year</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    amounts_per_month_yearly <span class="op">=</span> [yearly_transactions[yearly_transactions[<span class="st">'month'</span>] <span class="op">==</span> month][<span class="st">'amount'</span>] <span class="cf">for</span> month <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>)]</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparing data for the bar chart for the current year</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    monthly_summary_yearly <span class="op">=</span> yearly_transactions.groupby(<span class="st">'month'</span>).agg(TotalAmount<span class="op">=</span>(<span class="st">'amount'</span>, <span class="st">'sum'</span>), TransactionCount<span class="op">=</span>(<span class="st">'amount'</span>, <span class="st">'count'</span>)).reset_index()</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Box plot for transaction amounts by month for the current year</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    axs[i<span class="op">*</span><span class="dv">2</span>].boxplot(amounts_per_month_yearly, patch_artist<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now with seaborn</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sns.boxplot(data=yearly_transactions, x='month', y='amount', ax=axs[i*2])</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    axs[i<span class="op">*</span><span class="dv">2</span>].set_title(<span class="ss">f'Transaction Amounts Per Month in </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss"> (Box Plot)'</span>)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    axs[i<span class="op">*</span><span class="dv">2</span>].set_yscale(<span class="st">'symlog'</span>)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    axs[i<span class="op">*</span><span class="dv">2</span>].set_ylabel(<span class="st">'Transaction Amounts (log scale)'</span>)</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    axs[i<span class="op">*</span><span class="dv">2</span>].grid(<span class="va">True</span>, which<span class="op">=</span><span class="st">'both'</span>)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bar chart for transaction count by month for the current year</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    axs[i<span class="op">*</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>].bar(monthly_summary_yearly[<span class="st">'month'</span>], monthly_summary_yearly[<span class="st">'TransactionCount'</span>], color<span class="op">=</span><span class="st">'tab:red'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    axs[i<span class="op">*</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>].set_ylabel(<span class="st">'Transaction Count'</span>)</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    axs[i<span class="op">*</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span>].grid(<span class="va">True</span>, which<span class="op">=</span><span class="st">'both'</span>)</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting x-ticks and labels for the last bar chart (shared x-axis for all)</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>axs[<span class="op">-</span><span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>))</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>axs[<span class="op">-</span><span class="dv">1</span>].set_xticklabels(months)</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>axs[<span class="op">-</span><span class="dv">1</span>].set_xlabel(<span class="st">'Month'</span>)</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-31-output-1.png" width="1425" height="3440" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="dcdb1552" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Importing required libraries for visualization</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming 'transactions' DataFrame already contains 'year' and 'month' columns</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co"># and is ready for visualization</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting a list of unique years and defining month labels</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>years <span class="op">=</span> <span class="bu">sorted</span>(transactions_df[<span class="st">'year'</span>].unique())</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>months <span class="op">=</span> [<span class="st">'Jan'</span>, <span class="st">'Feb'</span>, <span class="st">'Mar'</span>, <span class="st">'Apr'</span>, <span class="st">'May'</span>, <span class="st">'Jun'</span>, <span class="st">'Jul'</span>, <span class="st">'Aug'</span>, <span class="st">'Sep'</span>, <span class="st">'Oct'</span>, <span class="st">'Nov'</span>, <span class="st">'Dec'</span>]</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjusting the figure layout to place visualizations for each year next to each other</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="bu">len</span>(years), figsize<span class="op">=</span>(<span class="dv">40</span> <span class="op">*</span> <span class="bu">len</span>(years) <span class="op">/</span> <span class="dv">2</span>, <span class="dv">30</span>), sharey<span class="op">=</span><span class="st">'row'</span>, gridspec_kw<span class="op">=</span>{<span class="st">'height_ratios'</span>: [<span class="dv">3</span>, <span class="dv">1</span>]})</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, year <span class="kw">in</span> <span class="bu">enumerate</span>(years):</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter transactions for the current year</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    yearly_transactions <span class="op">=</span> transactions_df[transactions_df[<span class="st">'year'</span>] <span class="op">==</span> year]</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparing data for the box plot: a list of amounts for each month for the current year</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    amounts_per_month_yearly <span class="op">=</span> [yearly_transactions[yearly_transactions[<span class="st">'month'</span>] <span class="op">==</span> month][<span class="st">'amount'</span>] <span class="cf">for</span> month <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>)]</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparing data for the bar chart for the current year</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    monthly_summary_yearly <span class="op">=</span> yearly_transactions.groupby(<span class="st">'month'</span>).agg(TotalAmount<span class="op">=</span>(<span class="st">'amount'</span>, <span class="st">'sum'</span>), TransactionCount<span class="op">=</span>(<span class="st">'amount'</span>, <span class="st">'count'</span>)).reset_index()</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Selecting the appropriate axes for multiple or single year scenarios</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    ax_box <span class="op">=</span> axs[<span class="dv">0</span>, i] <span class="cf">if</span> <span class="bu">len</span>(years) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> axs[<span class="dv">0</span>]</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    ax_bar <span class="op">=</span> axs[<span class="dv">1</span>, i] <span class="cf">if</span> <span class="bu">len</span>(years) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> axs[<span class="dv">1</span>]</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    ax_box.boxplot(amounts_per_month_yearly, patch_artist<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    ax_box.set_title(<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss"> (Box Plot)'</span>)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    ax_box.set_yscale(<span class="st">'symlog'</span>)</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    ax_box.set_ylabel(<span class="st">'Transaction Amounts (log scale)'</span>)</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    ax_box.grid(<span class="va">True</span>, which<span class="op">=</span><span class="st">'both'</span>)</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    ax_bar.bar(monthly_summary_yearly[<span class="st">'month'</span>], monthly_summary_yearly[<span class="st">'TransactionCount'</span>], color<span class="op">=</span><span class="st">'tab:red'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>    ax_bar.set_ylabel(<span class="st">'Transaction Count'</span>)</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>    ax_bar.grid(<span class="va">True</span>, which<span class="op">=</span><span class="st">'both'</span>)</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setting common x-ticks and labels for all axes</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    ax_bar.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>))</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    ax_bar.set_xticklabels(months)</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting a common x-label for the entire figure</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.04</span>, <span class="st">'Month'</span>, ha<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-32-output-1.png" width="11505" height="2864" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="0e1cd6be" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>negative_balances <span class="op">=</span> transactions_df[transactions_df[<span class="st">'balance'</span>] <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>plot_numerical_distributions(negative_balances, [<span class="st">'balance'</span>, <span class="st">'amount'</span>])</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of transactions with negative balance: </span><span class="sc">{</span><span class="bu">len</span>(negative_balances)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-33-output-1.png" width="753" height="944" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of transactions with negative balance: 2999</code></pre>
</div>
</div>
<p>There appear to be 2999 transactions which have a negative balance, therefore after the transaction the account balance was negative. This implies that these accounts are in some kind of debt.</p>
</section>
<section id="loans" class="level2">
<h2 class="anchored" data-anchor-id="loans">Loans</h2>
<div id="7869fdcd" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>loans_df <span class="op">=</span> read_csv(<span class="st">"data/loan.csv"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>loans_df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(loans_df[<span class="st">'date'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%y%m</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>loans_df[<span class="st">'status'</span>] <span class="op">=</span> loans_df[<span class="st">'status'</span>].<span class="bu">map</span>({</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A"</span>: <span class="st">"Contract finished, no problems"</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B"</span>: <span class="st">"Contract finished, loan not paid"</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C"</span>: <span class="st">"Contract running, OK thus-far"</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"D"</span>: <span class="st">"Contract running, client in debt"</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>loans_df.rename(columns<span class="op">=</span>{</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: <span class="st">'granted_date'</span>,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'amount'</span>: <span class="st">'amount'</span>,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'duration'</span>: <span class="st">'duration'</span>,</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'payments'</span>: <span class="st">'monthly_payments'</span>,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'status'</span>: <span class="st">'status'</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>loans_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 682 entries, 0 to 681
Data columns (total 7 columns):
 #   Column            Non-Null Count  Dtype         
---  ------            --------------  -----         
 0   loan_id           682 non-null    int64         
 1   account_id        682 non-null    int64         
 2   granted_date      682 non-null    datetime64[ns]
 3   amount            682 non-null    int64         
 4   duration          682 non-null    int64         
 5   monthly_payments  682 non-null    float64       
 6   status            682 non-null    object        
dtypes: datetime64[ns](1), float64(1), int64(4), object(1)
memory usage: 37.4+ KB</code></pre>
</div>
</div>
<div id="907218fe" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># todo add some basic eda here</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>loans_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_id</th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">granted_date</th>
<th data-quarto-table-cell-role="th">amount</th>
<th data-quarto-table-cell-role="th">duration</th>
<th data-quarto-table-cell-role="th">monthly_payments</th>
<th data-quarto-table-cell-role="th">status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>5314</td>
<td>1787</td>
<td>1993-07-05</td>
<td>96396</td>
<td>12</td>
<td>8033.0</td>
<td>Contract finished, loan not paid</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>5316</td>
<td>1801</td>
<td>1993-07-11</td>
<td>165960</td>
<td>36</td>
<td>4610.0</td>
<td>Contract finished, no problems</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>6863</td>
<td>9188</td>
<td>1993-07-28</td>
<td>127080</td>
<td>60</td>
<td>2118.0</td>
<td>Contract finished, no problems</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>5325</td>
<td>1843</td>
<td>1993-08-03</td>
<td>105804</td>
<td>36</td>
<td>2939.0</td>
<td>Contract finished, no problems</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>7240</td>
<td>11013</td>
<td>1993-09-06</td>
<td>274740</td>
<td>60</td>
<td>4579.0</td>
<td>Contract finished, no problems</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="7a33fee5" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>loans_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_id</th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">granted_date</th>
<th data-quarto-table-cell-role="th">amount</th>
<th data-quarto-table-cell-role="th">duration</th>
<th data-quarto-table-cell-role="th">monthly_payments</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>682.000000</td>
<td>682.000000</td>
<td>682</td>
<td>682.000000</td>
<td>682.000000</td>
<td>682.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>6172.466276</td>
<td>5824.162757</td>
<td>1996-09-29 05:35:43.108504448</td>
<td>151410.175953</td>
<td>36.492669</td>
<td>4190.664223</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">min</td>
<td>4959.000000</td>
<td>2.000000</td>
<td>1993-07-05 00:00:00</td>
<td>4980.000000</td>
<td>12.000000</td>
<td>304.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25%</td>
<td>5577.500000</td>
<td>2967.000000</td>
<td>1995-07-04 12:00:00</td>
<td>66732.000000</td>
<td>24.000000</td>
<td>2477.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50%</td>
<td>6176.500000</td>
<td>5738.500000</td>
<td>1997-02-06 12:00:00</td>
<td>116928.000000</td>
<td>36.000000</td>
<td>3934.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75%</td>
<td>6752.500000</td>
<td>8686.000000</td>
<td>1997-12-12 12:00:00</td>
<td>210654.000000</td>
<td>48.000000</td>
<td>5813.500000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">max</td>
<td>7308.000000</td>
<td>11362.000000</td>
<td>1998-12-08 00:00:00</td>
<td>590820.000000</td>
<td>60.000000</td>
<td>9910.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>682.579279</td>
<td>3283.512681</td>
<td>NaN</td>
<td>113372.406310</td>
<td>17.075219</td>
<td>2215.830344</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="c9f11abf" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>loans_df.nunique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>loan_id             682
account_id          682
granted_date        559
amount              645
duration              5
monthly_payments    577
status                4
dtype: int64</code></pre>
</div>
</div>
<p>It seems as if one account can have at max one loan.</p>
<div id="0351fb99" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>plot_categorical_variables(loans_df, [<span class="st">'duration'</span>, <span class="st">'status'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-38-output-1.png" width="1329" height="848" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The distribution of durations seems to be even.</p>
<div id="cdf32218" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>plot_numerical_distributions(loans_df, [<span class="st">'granted_date'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-39-output-1.png" width="753" height="463" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="credit-cards" class="level2">
<h2 class="anchored" data-anchor-id="credit-cards">Credit Cards</h2>
<div id="04358304" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>cards_df <span class="op">=</span> read_csv(<span class="st">"data/card.csv"</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>cards_df[<span class="st">'issued'</span>] <span class="op">=</span> pd.to_datetime(cards_df[<span class="st">'issued'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%y%m</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>).dt.date</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>cards_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 892 entries, 0 to 891
Data columns (total 4 columns):
 #   Column   Non-Null Count  Dtype 
---  ------   --------------  ----- 
 0   card_id  892 non-null    int64 
 1   disp_id  892 non-null    int64 
 2   type     892 non-null    object
 3   issued   892 non-null    object
dtypes: int64(2), object(2)
memory usage: 28.0+ KB</code></pre>
</div>
</div>
<div id="3d8ff8d1" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>cards_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">card_id</th>
<th data-quarto-table-cell-role="th">disp_id</th>
<th data-quarto-table-cell-role="th">type</th>
<th data-quarto-table-cell-role="th">issued</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1005</td>
<td>9285</td>
<td>classic</td>
<td>1993-11-07</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>104</td>
<td>588</td>
<td>classic</td>
<td>1994-01-19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>747</td>
<td>4915</td>
<td>classic</td>
<td>1994-02-05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>70</td>
<td>439</td>
<td>classic</td>
<td>1994-02-08</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>577</td>
<td>3687</td>
<td>classic</td>
<td>1994-02-15</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="562a2cd4" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>cards_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">card_id</th>
<th data-quarto-table-cell-role="th">disp_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>892.000000</td>
<td>892.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>480.855381</td>
<td>3511.862108</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>306.933982</td>
<td>2984.373626</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>9.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>229.750000</td>
<td>1387.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>456.500000</td>
<td>2938.500000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>684.250000</td>
<td>4459.500000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>1247.000000</td>
<td>13660.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="2607d83f" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>plot_categorical_variables(cards_df, [<span class="st">'type'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-43-output-1.png" width="1329" height="416" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b00f4c7c" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>plot_numerical_distributions(cards_df, [<span class="st">'issued'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-44-output-1.png" width="753" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="demographic-data" class="level2">
<h2 class="anchored" data-anchor-id="demographic-data">Demographic data</h2>
<div id="b679ee93" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>districts_df <span class="op">=</span> read_csv(<span class="st">"data/district.csv"</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># according to https://sorry.vse.cz/~berka/challenge/PAST/index.html</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>districts_df.rename(columns<span class="op">=</span>{</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A1'</span>: <span class="st">'district_id'</span>,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A2'</span>: <span class="st">'district_name'</span>,</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A3'</span>: <span class="st">'region'</span>,</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A4'</span>: <span class="st">'inhabitants'</span>,</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A5'</span>: <span class="st">'small_municipalities'</span>,</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A6'</span>: <span class="st">'medium_municipalities'</span>,</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A7'</span>: <span class="st">'large_municipalities'</span>,</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A8'</span>: <span class="st">'huge_municipalities'</span>,</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A9'</span>: <span class="st">'cities'</span>,</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A10'</span>: <span class="st">'ratio_urban_inhabitants'</span>,</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A11'</span>: <span class="st">'average_salary'</span>,</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A12'</span>: <span class="st">'unemployment_rate_1995'</span>,</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A13'</span>: <span class="st">'unemployment_rate_1996'</span>,</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A14'</span>: <span class="st">'entrepreneurs_per_1000_inhabitants'</span>,</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A15'</span>: <span class="st">'crimes_committed_1995'</span>,</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'A16'</span>: <span class="st">'crimes_committed_1996'</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'unemployment_rate_1995'</span>, <span class="st">'unemployment_rate_1996'</span>, <span class="st">'crimes_committed_1995'</span>, <span class="st">'crimes_committed_1996'</span>]:</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    districts_df[col] <span class="op">=</span> pd.to_numeric(districts_df[col], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>districts_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 77 entries, 0 to 76
Data columns (total 16 columns):
 #   Column                              Non-Null Count  Dtype  
---  ------                              --------------  -----  
 0   district_id                         77 non-null     int64  
 1   district_name                       77 non-null     object 
 2   region                              77 non-null     object 
 3   inhabitants                         77 non-null     int64  
 4   small_municipalities                77 non-null     int64  
 5   medium_municipalities               77 non-null     int64  
 6   large_municipalities                77 non-null     int64  
 7   huge_municipalities                 77 non-null     int64  
 8   cities                              77 non-null     int64  
 9   ratio_urban_inhabitants             77 non-null     float64
 10  average_salary                      77 non-null     int64  
 11  unemployment_rate_1995              76 non-null     float64
 12  unemployment_rate_1996              77 non-null     float64
 13  entrepreneurs_per_1000_inhabitants  77 non-null     int64  
 14  crimes_committed_1995               76 non-null     float64
 15  crimes_committed_1996               77 non-null     int64  
dtypes: float64(4), int64(10), object(2)
memory usage: 9.8+ KB</code></pre>
</div>
</div>
<p>It appears as if there is 1 null value for unemployment rate in 1995 and crimes committed in 1995.</p>
<div id="fc88e969" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># todo add some basic eda here</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>districts_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">district_id</th>
<th data-quarto-table-cell-role="th">district_name</th>
<th data-quarto-table-cell-role="th">region</th>
<th data-quarto-table-cell-role="th">inhabitants</th>
<th data-quarto-table-cell-role="th">small_municipalities</th>
<th data-quarto-table-cell-role="th">medium_municipalities</th>
<th data-quarto-table-cell-role="th">large_municipalities</th>
<th data-quarto-table-cell-role="th">huge_municipalities</th>
<th data-quarto-table-cell-role="th">cities</th>
<th data-quarto-table-cell-role="th">ratio_urban_inhabitants</th>
<th data-quarto-table-cell-role="th">average_salary</th>
<th data-quarto-table-cell-role="th">unemployment_rate_1995</th>
<th data-quarto-table-cell-role="th">unemployment_rate_1996</th>
<th data-quarto-table-cell-role="th">entrepreneurs_per_1000_inhabitants</th>
<th data-quarto-table-cell-role="th">crimes_committed_1995</th>
<th data-quarto-table-cell-role="th">crimes_committed_1996</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>Hl.m. Praha</td>
<td>Prague</td>
<td>1204953</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>100.0</td>
<td>12541</td>
<td>0.29</td>
<td>0.43</td>
<td>167</td>
<td>85677.0</td>
<td>99107</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>Benesov</td>
<td>central Bohemia</td>
<td>88884</td>
<td>80</td>
<td>26</td>
<td>6</td>
<td>2</td>
<td>5</td>
<td>46.7</td>
<td>8507</td>
<td>1.67</td>
<td>1.85</td>
<td>132</td>
<td>2159.0</td>
<td>2674</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>Beroun</td>
<td>central Bohemia</td>
<td>75232</td>
<td>55</td>
<td>26</td>
<td>4</td>
<td>1</td>
<td>5</td>
<td>41.7</td>
<td>8980</td>
<td>1.95</td>
<td>2.21</td>
<td>111</td>
<td>2824.0</td>
<td>2813</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>Kladno</td>
<td>central Bohemia</td>
<td>149893</td>
<td>63</td>
<td>29</td>
<td>6</td>
<td>2</td>
<td>6</td>
<td>67.4</td>
<td>9753</td>
<td>4.64</td>
<td>5.05</td>
<td>109</td>
<td>5244.0</td>
<td>5892</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>Kolin</td>
<td>central Bohemia</td>
<td>95616</td>
<td>65</td>
<td>30</td>
<td>4</td>
<td>1</td>
<td>6</td>
<td>51.4</td>
<td>9307</td>
<td>3.85</td>
<td>4.43</td>
<td>118</td>
<td>2616.0</td>
<td>3040</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="60550fde" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>districts_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">district_id</th>
<th data-quarto-table-cell-role="th">inhabitants</th>
<th data-quarto-table-cell-role="th">small_municipalities</th>
<th data-quarto-table-cell-role="th">medium_municipalities</th>
<th data-quarto-table-cell-role="th">large_municipalities</th>
<th data-quarto-table-cell-role="th">huge_municipalities</th>
<th data-quarto-table-cell-role="th">cities</th>
<th data-quarto-table-cell-role="th">ratio_urban_inhabitants</th>
<th data-quarto-table-cell-role="th">average_salary</th>
<th data-quarto-table-cell-role="th">unemployment_rate_1995</th>
<th data-quarto-table-cell-role="th">unemployment_rate_1996</th>
<th data-quarto-table-cell-role="th">entrepreneurs_per_1000_inhabitants</th>
<th data-quarto-table-cell-role="th">crimes_committed_1995</th>
<th data-quarto-table-cell-role="th">crimes_committed_1996</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>77.000000</td>
<td>7.700000e+01</td>
<td>77.000000</td>
<td>77.000000</td>
<td>77.000000</td>
<td>77.000000</td>
<td>77.000000</td>
<td>77.000000</td>
<td>77.000000</td>
<td>76.000000</td>
<td>77.000000</td>
<td>77.000000</td>
<td>76.000000</td>
<td>77.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>39.000000</td>
<td>1.338849e+05</td>
<td>48.623377</td>
<td>24.324675</td>
<td>6.272727</td>
<td>1.727273</td>
<td>6.259740</td>
<td>63.035065</td>
<td>9031.675325</td>
<td>3.119342</td>
<td>3.787013</td>
<td>116.129870</td>
<td>4850.315789</td>
<td>5030.831169</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>22.371857</td>
<td>1.369135e+05</td>
<td>32.741829</td>
<td>12.780991</td>
<td>4.015222</td>
<td>1.008338</td>
<td>2.435497</td>
<td>16.221727</td>
<td>790.202347</td>
<td>1.665568</td>
<td>1.908480</td>
<td>16.608773</td>
<td>9888.951933</td>
<td>11270.796786</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>4.282100e+04</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>33.900000</td>
<td>8110.000000</td>
<td>0.290000</td>
<td>0.430000</td>
<td>81.000000</td>
<td>818.000000</td>
<td>888.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>20.000000</td>
<td>8.585200e+04</td>
<td>22.000000</td>
<td>16.000000</td>
<td>4.000000</td>
<td>1.000000</td>
<td>5.000000</td>
<td>51.900000</td>
<td>8512.000000</td>
<td>1.787500</td>
<td>2.310000</td>
<td>105.000000</td>
<td>2029.750000</td>
<td>2122.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>39.000000</td>
<td>1.088710e+05</td>
<td>49.000000</td>
<td>25.000000</td>
<td>6.000000</td>
<td>2.000000</td>
<td>6.000000</td>
<td>59.800000</td>
<td>8814.000000</td>
<td>2.825000</td>
<td>3.600000</td>
<td>113.000000</td>
<td>2932.000000</td>
<td>3040.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>58.000000</td>
<td>1.390120e+05</td>
<td>71.000000</td>
<td>32.000000</td>
<td>8.000000</td>
<td>2.000000</td>
<td>8.000000</td>
<td>73.500000</td>
<td>9317.000000</td>
<td>3.890000</td>
<td>4.790000</td>
<td>126.000000</td>
<td>4525.500000</td>
<td>4595.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>77.000000</td>
<td>1.204953e+06</td>
<td>151.000000</td>
<td>70.000000</td>
<td>20.000000</td>
<td>5.000000</td>
<td>11.000000</td>
<td>100.000000</td>
<td>12541.000000</td>
<td>7.340000</td>
<td>9.400000</td>
<td>167.000000</td>
<td>85677.000000</td>
<td>99107.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="5d99cb60" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>districts_df.nunique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>district_id                           77
district_name                         77
region                                 8
inhabitants                           77
small_municipalities                  53
medium_municipalities                 36
large_municipalities                  17
huge_municipalities                    6
cities                                11
ratio_urban_inhabitants               70
average_salary                        76
unemployment_rate_1995                70
unemployment_rate_1996                73
entrepreneurs_per_1000_inhabitants    44
crimes_committed_1995                 75
crimes_committed_1996                 76
dtype: int64</code></pre>
</div>
</div>
<div id="ede36ad9" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>plot_numerical_distributions(districts_df, [<span class="st">'crimes_committed_1995'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-49-output-1.png" width="753" height="463" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="417b2d1b" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>plot_categorical_variables(districts_df, [<span class="st">'region'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-50-output-1.png" width="1329" height="409" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We need to differentiate between the domicile of the client and account, as they can be different.</p>
</section>
</section>
<section id="relationships" class="level1">
<h1>Relationships</h1>
<p>Following the documentation of the dataset, there are multiple relationships that need to be validated. https://sorry.vse.cz/~berka/challenge/PAST/index.html</p>
<p>The ERD according to the descriptions on https://sorry.vse.cz/~berka/challenge/PAST/index.html</p>
<p><a href="https://mermaid.live/edit#pako:eNqtV1Fv4jgQ_itWXu6l7SZ0gQatTsqGdhddCxVQrXSqFJnEgLWJnbOd7bGl__3GTgA3JGyvWh7ajPPNZ898nrHz7MQ8Ic7AIWJI8Urg7JEh-AVhOHkYz9FzaeqfVIKyFcJxzAumIpqg-7_QoxOUNhoNH50jcEL1Q2zQNxo9rAZq8AQrUv45EIaCYEU5Q0MYb-BeCvJPQVi8AZ-RlAVmMUE3u8Gdw0v5L7wdXTeGE6eUWNGExmxa3YIKtY5YkS2IAOBnbbYt7S1hVwsbjmb3k9loPpqMG1YHRPl-bUCSc0lNThqzfYjlpjWWYxVvfqmi2uRamMkTI-LDgySiFsNkOryeNqyei4SI_fIn2voNq1lg9j1SHGBTEtPcxPgZxk7w1tAVve2wTDlWCGdmWkg1WVBFEhRkdWDF_D2Sm2zBU8De402mWcM1FjhWRNCfZt_WkjSfBuNZELYIrQRmcp-qubaAq1XptyXMriqbsmXXVjJD3SVUffhG1ToR-AmnDVCeE1EW52vmO2gmJ9JqQ49TW4IXODWVDCVWPQVLSCqyfE_rYU_SpkltOxkVhYLt_YudZAFrm6hS-XYSNMkLkbG9urdg_C5ZDdcXiFjv1rqutewb7HHaKbxMir2cBjWs7GO2vNztEpB3nKl1ukFVAciGgKTCqpA71pmx6p05mA6b-jIWyaErg9F6wOR2lz3dIHc7XNPN4fkoqxTOEUjkbsbSstN66Nrz6SicN7fsfe-_P3HkVXCGM2KDxmA3wARZlfJMzUNdP8YjvowoW2PoW7iUZ8wvEF-i0WGw2SsrGIXOiFNIHJHRE9S9zRSlKuq6rtb7FRB9QjD8PkpwhJ4ceb7vH_PCy3P95n3UHbfk9hu59dtz_93kKxV5wNCQjD_NeDNrXEL2ioTGPi4tU3LaoRAL3S5eqfmgx2wx0VTDG8r9B7TmFYkkdE-h70ZBOYBmZuDYoWAky1NuajiCNZDI7-oJrWE9F0F_-N03efdavHvN6QGEILkgjBRCRnCwmBzXwr-2QQhAyGvPN88yqqAhRrGgGeho4gnNcz2IU14926tndYBaD9huz8_58_7KPDDtLsa6I4_2lVpHVxfSgSlpSROY5ADeUVVY-46oHQIpeUzNBPqU3nlVlP_PyYZpz-227Mja5SuWLSsqb3wa8wUk0bK3Ie1rTxlsDNfCZvS2PD4Hpv8y9BW2ssY5Z05GRIZpAt8ppuE-OmpNdJ_U0IQscZGaI-0FoLhQfLZhsTNQoiBnTpHrzl593DiDJU4ljOaY_c15tgPpGw8Xd-WnkPkiMhBn8Oz86wyuOhf9bsf96Lndvuu5ff_M2TgDz-1ddK763qXvel237131X86cn4bUvbi67PU6Xt_z3Y--e9ntv_wHEyE3kA"><img src="https://mermaid.ink/img/pako:eNqtV1Fv4jgQ_itWXu6l7SZ0gQatTsqGdhddCxVQrXSqFJnEgLWJnbOd7bGl__3GTgA3JGyvWh7ajPPNZ898nrHz7MQ8Ic7AIWJI8Urg7JEh-AVhOHkYz9FzaeqfVIKyFcJxzAumIpqg-7_QoxOUNhoNH50jcEL1Q2zQNxo9rAZq8AQrUv45EIaCYEU5Q0MYb-BeCvJPQVi8AZ-RlAVmMUE3u8Gdw0v5L7wdXTeGE6eUWNGExmxa3YIKtY5YkS2IAOBnbbYt7S1hVwsbjmb3k9loPpqMG1YHRPl-bUCSc0lNThqzfYjlpjWWYxVvfqmi2uRamMkTI-LDgySiFsNkOryeNqyei4SI_fIn2voNq1lg9j1SHGBTEtPcxPgZxk7w1tAVve2wTDlWCGdmWkg1WVBFEhRkdWDF_D2Sm2zBU8De402mWcM1FjhWRNCfZt_WkjSfBuNZELYIrQRmcp-qubaAq1XptyXMriqbsmXXVjJD3SVUffhG1ToR-AmnDVCeE1EW52vmO2gmJ9JqQ49TW4IXODWVDCVWPQVLSCqyfE_rYU_SpkltOxkVhYLt_YudZAFrm6hS-XYSNMkLkbG9urdg_C5ZDdcXiFjv1rqutewb7HHaKbxMir2cBjWs7GO2vNztEpB3nKl1ukFVAciGgKTCqpA71pmx6p05mA6b-jIWyaErg9F6wOR2lz3dIHc7XNPN4fkoqxTOEUjkbsbSstN66Nrz6SicN7fsfe-_P3HkVXCGM2KDxmA3wARZlfJMzUNdP8YjvowoW2PoW7iUZ8wvEF-i0WGw2SsrGIXOiFNIHJHRE9S9zRSlKuq6rtb7FRB9QjD8PkpwhJ4ceb7vH_PCy3P95n3UHbfk9hu59dtz_93kKxV5wNCQjD_NeDNrXEL2ioTGPi4tU3LaoRAL3S5eqfmgx2wx0VTDG8r9B7TmFYkkdE-h70ZBOYBmZuDYoWAky1NuajiCNZDI7-oJrWE9F0F_-N03efdavHvN6QGEILkgjBRCRnCwmBzXwr-2QQhAyGvPN88yqqAhRrGgGeho4gnNcz2IU14926tndYBaD9huz8_58_7KPDDtLsa6I4_2lVpHVxfSgSlpSROY5ADeUVVY-46oHQIpeUzNBPqU3nlVlP_PyYZpz-227Mja5SuWLSsqb3wa8wUk0bK3Ie1rTxlsDNfCZvS2PD4Hpv8y9BW2ssY5Z05GRIZpAt8ppuE-OmpNdJ_U0IQscZGaI-0FoLhQfLZhsTNQoiBnTpHrzl593DiDJU4ljOaY_c15tgPpGw8Xd-WnkPkiMhBn8Oz86wyuOhf9bsf96Lndvuu5ff_M2TgDz-1ddK763qXvel237131X86cn4bUvbi67PU6Xt_z3Y--e9ntv_wHEyE3kA?type=png.png" class="img-fluid"></a></p>
<p>This ERD shows how the data appears in the dataset:</p>
<p><a href="https://mermaid.live/edit#pako:eNqtV99P2zAQ_lesvOyFbjCJSq2mSSHlRzRoUVq0F6TITdzWIrEz2xnqgP99ZydNTeIUhOgD5JzvPvvufJ-dJy_hKfHGHhETitcC5_cMwc8PgtnddIGeKlP_pBKUrRFOEl4yFdMU3f5C955f2Sic3HsdcEr1Q2LQFxo9qQda8BQrUv3ZEwaCYEU5QxMYd3CvBPlTEpZswSeUssQsIehiN7hzeKn-BdfhuTOcJKPEiiYwpmt1SyrUJmZlviQCgGfa7Fvae8KuFzYJ57ezebgIZ1PH6oCoaNYGJAWX1OTEme19LBe9sXSrePFmFdW20IWZPTIivt1JIloxzKLJeeRYPRcpEc3yZ9r6hNUsMXuIFQdYRBJamBjPYOwAbwtd09sOq4xjhXBupoVUkyVVJEV-3gbWzA-x3OZLngH2Fm9zzRpssMCJIoL-M_u2laRF5E_nftBTaCUwk02qFtoCrt5Kvy9hdlfZlD27ti4z9F1K1bffVG1SgR9x5oDygoiqOV8z34CYHEirDe2mtgIvcWY6GVqsfvJXkFRk-R6uhz1JX01a28lUUSjY3m_sJAvY2kR1la9nvqu8EBlrqnsNxmeV1XBdQsR6t7br2sq-wXbTTuFlWjblNKhJbXfZimq3S0DecKY22RbVDSAdAUmFVSl3rHNjtZXZjyYuXcYi3asyGL0HTGGr7GGB3O1wTbeA505WKZwjkMjdjJVlp3Wv2osoDBZuyW60__bAkVfDGc6JDZqC7YAJsq7KE5mHdv0Yj_kqpmyDQbdwVZ4p_4r4CoX7QbdXXjIKyogzSByR8SP0vc0UZyo-PT7W9X4FRD8QDH-MEhxBk-OT0WjU5YWXA_3mY9TfjyvukZNbvx2MPky-VvEJMDiS8dOMu1mTCtJUJDB2t7VMy2mHUiy1XLyq5p0es4uJIg13tPtfkOY1iSWop9B3I78aQHMz0HUoGcmLjJsejmENJB6d6gmtYT0XQV9Gp-_yHvZ4D93pAYQghSCMlELGcLCYHLfCP7dBCEDopD_fPM-pAkGME0FzqKOJJzDP7SAOeQ1tr6GlAC0NeH4eDPhTc2UeG7lLsFbksOnUNrq-kI5NS0uawiR78I6qxtp3RO3gS8kTaibQp_TOq6bUTs_P73WyYbWnUWTtcoVlz4qqG5_GXEJJdNn7kPa1pwo2gWuhEw1Tm-NzbPSXoSvYyhrnHXk5ETmmKXynGMG999SGaJ3U0JSscJmZI-0FoLhUfL5liTdWoiRHXlloZa8_brzxCmcSRvUVh4ub6tsn4WxF197LfwBRISI"><img src="https://mermaid.ink/img/pako:eNqtV99P2zAQ_lesvOyFbjCJSq2mSSHlRzRoUVq0F6TITdzWIrEz2xnqgP99ZydNTeIUhOgD5JzvPvvufJ-dJy_hKfHGHhETitcC5_cMwc8PgtnddIGeKlP_pBKUrRFOEl4yFdMU3f5C955f2Sic3HsdcEr1Q2LQFxo9qQda8BQrUv3ZEwaCYEU5QxMYd3CvBPlTEpZswSeUssQsIehiN7hzeKn-BdfhuTOcJKPEiiYwpmt1SyrUJmZlviQCgGfa7Fvae8KuFzYJ57ezebgIZ1PH6oCoaNYGJAWX1OTEme19LBe9sXSrePFmFdW20IWZPTIivt1JIloxzKLJeeRYPRcpEc3yZ9r6hNUsMXuIFQdYRBJamBjPYOwAbwtd09sOq4xjhXBupoVUkyVVJEV-3gbWzA-x3OZLngH2Fm9zzRpssMCJIoL-M_u2laRF5E_nftBTaCUwk02qFtoCrt5Kvy9hdlfZlD27ti4z9F1K1bffVG1SgR9x5oDygoiqOV8z34CYHEirDe2mtgIvcWY6GVqsfvJXkFRk-R6uhz1JX01a28lUUSjY3m_sJAvY2kR1la9nvqu8EBlrqnsNxmeV1XBdQsR6t7br2sq-wXbTTuFlWjblNKhJbXfZimq3S0DecKY22RbVDSAdAUmFVSl3rHNjtZXZjyYuXcYi3asyGL0HTGGr7GGB3O1wTbeA505WKZwjkMjdjJVlp3Wv2osoDBZuyW60__bAkVfDGc6JDZqC7YAJsq7KE5mHdv0Yj_kqpmyDQbdwVZ4p_4r4CoX7QbdXXjIKyogzSByR8SP0vc0UZyo-PT7W9X4FRD8QDH-MEhxBk-OT0WjU5YWXA_3mY9TfjyvukZNbvx2MPky-VvEJMDiS8dOMu1mTCtJUJDB2t7VMy2mHUiy1XLyq5p0es4uJIg13tPtfkOY1iSWop9B3I78aQHMz0HUoGcmLjJsejmENJB6d6gmtYT0XQV9Gp-_yHvZ4D93pAYQghSCMlELGcLCYHLfCP7dBCEDopD_fPM-pAkGME0FzqKOJJzDP7SAOeQ1tr6GlAC0NeH4eDPhTc2UeG7lLsFbksOnUNrq-kI5NS0uawiR78I6qxtp3RO3gS8kTaibQp_TOq6bUTs_P73WyYbWnUWTtcoVlz4qqG5_GXEJJdNn7kPa1pwo2gWuhEw1Tm-NzbPSXoSvYyhrnHXk5ETmmKXynGMG999SGaJ3U0JSscJmZI-0FoLhUfL5liTdWoiRHXlloZa8_brzxCmcSRvUVh4ub6tsn4WxF197LfwBRISI?type=png.png" class="img-fluid"></a></p>
<div id="14dc1ee3" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify 1:1 relationships between CLIENT, LOAN and DISPOSITION</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> dispositions_df[<span class="st">'client_id'</span>].is_unique, <span class="st">"Each client_id should appear exactly once in the DISPOSITION DataFrame."</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> loans_df[<span class="st">'account_id'</span>].is_unique, <span class="st">"Each account_id should appear exactly once in the LOAN DataFrame."</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify 1:M relationships between ACCOUNT and DISPOSITION</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="co">#assert dispositions['account_id'].is_unique == False, "An account_id should appear more than once in the DISPOSITION DataFrame."</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> dispositions_df[<span class="st">'account_id'</span>].is_unique <span class="op">==</span> <span class="va">True</span>, <span class="st">"An account_id should appear once in the DISPOSITION DataFrame."</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> check if in accordance to decision to remove disponents from dispositions</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify each district_id in ACCOUNT and CLIENT exists in DISTRICT</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">set</span>(accounts_df[<span class="st">'district_id'</span>]).issubset(</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>(districts_df[<span class="st">'district_id'</span>])), <span class="st">"All district_ids in ACCOUNT should exist in DISTRICT."</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">set</span>(clients_df[<span class="st">'district_id'</span>]).issubset(</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>(districts_df[<span class="st">'district_id'</span>])), <span class="st">"All district_ids in CLIENT should exist in DISTRICT."</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify each account_id in DISPOSITION, ORDER, TRANSACTION, and LOAN exists in ACCOUNT</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">set</span>(dispositions_df[<span class="st">'account_id'</span>]).issubset(</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>(accounts_df[<span class="st">'account_id'</span>])), <span class="st">"All account_ids in DISPOSITION should exist in ACCOUNT."</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">set</span>(orders_df[<span class="st">'account_id'</span>]).issubset(</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>(accounts_df[<span class="st">'account_id'</span>])), <span class="st">"All account_ids in ORDER should exist in ACCOUNT."</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">set</span>(transactions_df[<span class="st">'account_id'</span>]).issubset(</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>(accounts_df[<span class="st">'account_id'</span>])), <span class="st">"All account_ids in TRANSACTION should exist in ACCOUNT."</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">set</span>(loans_df[<span class="st">'account_id'</span>]).issubset(</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>(accounts_df[<span class="st">'account_id'</span>])), <span class="st">"All account_ids in LOAN should exist in ACCOUNT."</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify each client_id in DISPOSITION exists in CLIENT</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">set</span>(dispositions_df[<span class="st">'client_id'</span>]).issubset(</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>(clients_df[<span class="st">'client_id'</span>])), <span class="st">"All client_ids in DISPOSITION should exist in CLIENT."</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify each disp_id in CARD exists in DISPOSITION</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">set</span>(cards_df[<span class="st">'disp_id'</span>]).issubset(<span class="bu">set</span>(dispositions_df[<span class="st">'disp_id'</span>])), <span class="st">"All disp_ids in CARD should exist in DISPOSITION."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="non-transactional-data" class="level1">
<h1>Non-transactional Data</h1>
<div id="e87417f0" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>orders_pivot_df <span class="op">=</span> orders_df.pivot_table(index<span class="op">=</span><span class="st">'account_id'</span>,</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>                                        columns<span class="op">=</span><span class="st">'k_symbol'</span>,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>                                        values<span class="op">=</span><span class="st">'debited_amount'</span>,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                                        aggfunc<span class="op">=</span><span class="st">'sum'</span>,</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>                                        fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>orders_pivot_df.columns <span class="op">=</span> [<span class="ss">f'k_symbol_debited_sum_</span><span class="sc">{</span>col<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> col <span class="kw">in</span> orders_pivot_df.columns]</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: find something better than this</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>orders_pivot_df <span class="op">=</span> orders_pivot_df.reset_index() <span class="co"># Use created index as account_id</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>orders_pivot_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">k_symbol_debited_sum_household</th>
<th data-quarto-table-cell-role="th">k_symbol_debited_sum_insurance_payment</th>
<th data-quarto-table-cell-role="th">k_symbol_debited_sum_leasing</th>
<th data-quarto-table-cell-role="th">k_symbol_debited_sum_loan_payment</th>
<th data-quarto-table-cell-role="th">k_symbol_debited_sum_na</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2452.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>7266.0</td>
<td>0.0</td>
<td>0.0</td>
<td>3372.7</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>1135.0</td>
<td>3539.0</td>
<td>0.0</td>
<td>0.0</td>
<td>327.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>3363.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>2668.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="931704ba" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> merge_non_transactional_data(clients, districts, dispositions, accounts, orders, loans, cards):</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename district_id for clarity in clients and accounts DataFrames</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    clients <span class="op">=</span> clients.rename(columns<span class="op">=</span>{<span class="st">'district_id'</span>: <span class="st">'client_district_id'</span>})</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    accounts <span class="op">=</span> accounts.rename(columns<span class="op">=</span>{<span class="st">'district_id'</span>: <span class="st">'account_district_id'</span>})</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare districts dataframe for merge with prefix for clients and accounts</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    districts_client_prefixed <span class="op">=</span> districts.add_prefix(<span class="st">'client_'</span>)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    districts_account_prefixed <span class="op">=</span> districts.add_prefix(<span class="st">'account_'</span>)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge district information for clients and accounts with prefixed columns</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    clients_with_districts <span class="op">=</span> pd.merge(clients, districts_client_prefixed, left_on<span class="op">=</span><span class="st">'client_district_id'</span>, right_on<span class="op">=</span><span class="st">'client_district_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    accounts_with_districts <span class="op">=</span> pd.merge(accounts, districts_account_prefixed, left_on<span class="op">=</span><span class="st">'account_district_id'</span>, right_on<span class="op">=</span><span class="st">'account_district_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge cards with dispositions and prefix card-related columns to avoid confusion</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    cards_prefixed <span class="op">=</span> cards.add_prefix(<span class="st">'card_'</span>)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    dispositions_with_cards <span class="op">=</span> pd.merge(dispositions, cards_prefixed, left_on<span class="op">=</span><span class="st">'disp_id'</span>, right_on<span class="op">=</span><span class="st">'card_disp_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge clients (with district info) with dispositions and cards</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assuming dispositions might have columns that overlap with clients, prefix those if necessary</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    clients_dispositions_cards <span class="op">=</span> pd.merge(dispositions_with_cards, clients_with_districts, on<span class="op">=</span><span class="st">'client_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge the above with accounts (with district info) on account_id</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>    accounts_clients_cards <span class="op">=</span> pd.merge(accounts_with_districts, clients_dispositions_cards, on<span class="op">=</span><span class="st">'account_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge orders DataFrame, assuming orders might contain columns that could overlap, prefix as needed</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>    orders_prefixed <span class="op">=</span> orders.add_prefix(<span class="st">'order_'</span>)</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>    comprehensive_df_with_orders <span class="op">=</span> pd.merge(accounts_clients_cards, orders_prefixed, left_on<span class="op">=</span><span class="st">'account_id'</span>, right_on<span class="op">=</span><span class="st">'order_account_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge loans with the comprehensive dataframe (now including orders) on account_id</span></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prefix loan-related columns to maintain clarity</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>    loans_prefixed <span class="op">=</span> loans.add_prefix(<span class="st">'loan_'</span>)</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>    final_df <span class="op">=</span> pd.merge(comprehensive_df_with_orders, loans_prefixed, left_on<span class="op">=</span><span class="st">'account_id'</span>, right_on<span class="op">=</span><span class="st">'loan_account_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>    final_df[<span class="st">'account_created'</span>] <span class="op">=</span> pd.to_datetime(final_df[<span class="st">'account_created'</span>])</span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>    final_df[<span class="st">'card_issued'</span>] <span class="op">=</span> pd.to_datetime(final_df[<span class="st">'card_issued'</span>])</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>    final_df[<span class="st">'has_card'</span>] <span class="op">=</span> final_df[<span class="st">'card_issued'</span>].notna()</span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_df</span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a>non_transactional_df <span class="op">=</span> merge_non_transactional_data(clients_df, districts_df, dispositions_df, accounts_df, orders_pivot_df, loans_df, cards_df)</span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>non_transactional_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 4500 entries, 0 to 4499
Data columns (total 59 columns):
 #   Column                                        Non-Null Count  Dtype         
---  ------                                        --------------  -----         
 0   account_id                                    4500 non-null   int64         
 1   account_district_id                           4500 non-null   int64         
 2   account_frequency                             4500 non-null   object        
 3   account_created                               4500 non-null   datetime64[ns]
 4   account_district_name                         4500 non-null   object        
 5   account_region                                4500 non-null   object        
 6   account_inhabitants                           4500 non-null   int64         
 7   account_small_municipalities                  4500 non-null   int64         
 8   account_medium_municipalities                 4500 non-null   int64         
 9   account_large_municipalities                  4500 non-null   int64         
 10  account_huge_municipalities                   4500 non-null   int64         
 11  account_cities                                4500 non-null   int64         
 12  account_ratio_urban_inhabitants               4500 non-null   float64       
 13  account_average_salary                        4500 non-null   int64         
 14  account_unemployment_rate_1995                4452 non-null   float64       
 15  account_unemployment_rate_1996                4500 non-null   float64       
 16  account_entrepreneurs_per_1000_inhabitants    4500 non-null   int64         
 17  account_crimes_committed_1995                 4452 non-null   float64       
 18  account_crimes_committed_1996                 4500 non-null   int64         
 19  disp_id                                       4500 non-null   int64         
 20  client_id                                     4500 non-null   int64         
 21  type                                          4500 non-null   object        
 22  card_card_id                                  892 non-null    float64       
 23  card_disp_id                                  892 non-null    float64       
 24  card_type                                     892 non-null    object        
 25  card_issued                                   892 non-null    datetime64[ns]
 26  client_district_id                            4500 non-null   int64         
 27  sex                                           4500 non-null   object        
 28  birth_date                                    4500 non-null   datetime64[ns]
 29  age                                           4500 non-null   int64         
 30  client_district_name                          4500 non-null   object        
 31  client_region                                 4500 non-null   object        
 32  client_inhabitants                            4500 non-null   int64         
 33  client_small_municipalities                   4500 non-null   int64         
 34  client_medium_municipalities                  4500 non-null   int64         
 35  client_large_municipalities                   4500 non-null   int64         
 36  client_huge_municipalities                    4500 non-null   int64         
 37  client_cities                                 4500 non-null   int64         
 38  client_ratio_urban_inhabitants                4500 non-null   float64       
 39  client_average_salary                         4500 non-null   int64         
 40  client_unemployment_rate_1995                 4448 non-null   float64       
 41  client_unemployment_rate_1996                 4500 non-null   float64       
 42  client_entrepreneurs_per_1000_inhabitants     4500 non-null   int64         
 43  client_crimes_committed_1995                  4448 non-null   float64       
 44  client_crimes_committed_1996                  4500 non-null   int64         
 45  order_account_id                              3758 non-null   float64       
 46  order_k_symbol_debited_sum_household          3758 non-null   float64       
 47  order_k_symbol_debited_sum_insurance_payment  3758 non-null   float64       
 48  order_k_symbol_debited_sum_leasing            3758 non-null   float64       
 49  order_k_symbol_debited_sum_loan_payment       3758 non-null   float64       
 50  order_k_symbol_debited_sum_na                 3758 non-null   float64       
 51  loan_loan_id                                  682 non-null    float64       
 52  loan_account_id                               682 non-null    float64       
 53  loan_granted_date                             682 non-null    datetime64[ns]
 54  loan_amount                                   682 non-null    float64       
 55  loan_duration                                 682 non-null    float64       
 56  loan_monthly_payments                         682 non-null    float64       
 57  loan_status                                   682 non-null    object        
 58  has_card                                      4500 non-null   bool          
dtypes: bool(1), datetime64[ns](4), float64(21), int64(24), object(9)
memory usage: 2.0+ MB</code></pre>
</div>
</div>
<div id="db4f4516" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>non_transactional_df.to_csv(<span class="st">"./data/non_transactional.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="eda" class="level2">
<h2 class="anchored" data-anchor-id="eda">EDA</h2>
<section id="card-holders" class="level3">
<h3 class="anchored" data-anchor-id="card-holders">Card Holders</h3>
<div id="5308d262" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Number of Clients by Card Type'</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>[<span class="st">'No Card'</span>, <span class="st">'Classic/Gold Card Holders'</span>, <span class="st">'Junior Card Holders'</span>], y<span class="op">=</span>[non_transactional_df[<span class="st">'card_type'</span>].isna().<span class="bu">sum</span>(), non_transactional_df[<span class="st">'card_type'</span>].isin([<span class="st">'gold'</span>, <span class="st">'classic'</span>]).<span class="bu">sum</span>(), non_transactional_df[<span class="st">'card_type'</span>].eq(<span class="st">'junior'</span>).<span class="bu">sum</span>()])</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ensure that the number of clients is shown on the bars</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>([non_transactional_df[<span class="st">'card_type'</span>].isna().<span class="bu">sum</span>(), non_transactional_df[<span class="st">'card_type'</span>].isin([<span class="st">'gold'</span>, <span class="st">'classic'</span>]).<span class="bu">sum</span>(), non_transactional_df[<span class="st">'card_type'</span>].eq(<span class="st">'junior'</span>).<span class="bu">sum</span>()]):</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    plt.text(i, v <span class="op">+</span> <span class="dv">10</span>, <span class="bu">str</span>(v), ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-55-output-1.png" width="813" height="509" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looking at the distribution of card holders in general we can see that the most clients are not in a possession of a credit card.</p>
<div id="f0655e08" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f'Distribution of Age for Junior Card Holders</span><span class="ch">\n</span><span class="ss"> total count = </span><span class="sc">{</span><span class="bu">len</span>(non_transactional_df[non_transactional_df[<span class="st">"card_type"</span>] <span class="op">==</span> <span class="st">"junior"</span>])<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(non_transactional_df[non_transactional_df[<span class="st">'card_type'</span>] <span class="op">==</span> <span class="st">'junior'</span>][<span class="st">'age'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Age of Client (presumably in 1999)'</span>)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-56-output-1.png" width="815" height="548" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looking at the age distribution of Junior Card holders paints a picture on this group, however only looking at the current age may be misleading as we need to understand how old they were when the card was issued to determine if they could have been eligble for a Classic/Gold card (at least 18 when the card was issued).</p>
<div id="308ddcc2" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>non_transactional_df[<span class="st">'card_issued'</span>] <span class="op">=</span> pd.to_datetime(non_transactional_df[<span class="st">'card_issued'</span>])</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>non_transactional_df[<span class="st">'age_at_card_issuance'</span>] <span class="op">=</span> non_transactional_df[<span class="st">'card_issued'</span>] <span class="op">-</span> non_transactional_df[<span class="st">'birth_date'</span>]</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>non_transactional_df[<span class="st">'age_at_card_issuance'</span>] <span class="op">=</span> non_transactional_df[<span class="st">'age_at_card_issuance'</span>].dt.days <span class="op">//</span> <span class="dv">365</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f'Distribution of Age at Card Issuance for Junior Card Holders</span><span class="ch">\n</span><span class="ss"> total count = </span><span class="sc">{</span><span class="bu">len</span>(non_transactional_df[non_transactional_df[<span class="st">"card_type"</span>] <span class="op">==</span> <span class="st">"junior"</span>])<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>sns.histplot(non_transactional_df[non_transactional_df[<span class="st">'card_type'</span>] <span class="op">==</span> <span class="st">'junior'</span>][<span class="st">'age_at_card_issuance'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Age at Card Issuance'</span>)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-57-output-1.png" width="815" height="548" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here we can see that roughly 1/3 of the Junior Card holders were not of legal age (assuming legal age is 18) when receiving their Junior Card.</p>
<div id="03c167df" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f'Distribution of Age at Card Issuance for All Card Types</span><span class="ch">\n</span><span class="ss"> total count = </span><span class="sc">{</span><span class="bu">len</span>(non_transactional_df)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(non_transactional_df[non_transactional_df[<span class="st">'card_type'</span>] <span class="op">==</span> <span class="st">'junior'</span>][<span class="st">'age_at_card_issuance'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'blue'</span>, label<span class="op">=</span><span class="st">'Junior Card Holders'</span>)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>sns.histplot(non_transactional_df[non_transactional_df[<span class="st">'card_type'</span>] <span class="op">!=</span> <span class="st">'junior'</span>][<span class="st">'age_at_card_issuance'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'Non-Junior Card Holders'</span>)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Age at Card Issuance'</span>)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-58-output-1.png" width="815" height="548" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Comparing the age at issue date between Junior and non-Junior (Classic/Gold) card holders shows that there is no overlap between the two groups, which makes intutively sense.</p>
<p>Therefore removing the subset of Junior Cards seems as valid as there is no reason to believe that there are Junior Cards issued wrongly, the subset being relatively small compared to the remaining issued cards and the fact that our target is specifically Classic/Gold Card owners.</p>
<div id="c1b558b3" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>before_len <span class="op">=</span> <span class="bu">len</span>(non_transactional_df)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>non_transactional_df <span class="op">=</span> non_transactional_df[non_transactional_df[<span class="st">'card_type'</span>] <span class="op">!=</span> <span class="st">'junior'</span>]</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>data_reduction[<span class="st">"Junior Card Holders"</span>] <span class="op">=</span> <span class="op">-</span>(before_len <span class="op">-</span> <span class="bu">len</span>(non_transactional_df))</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> before_len</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looking at the age distribution of Junior card holders and their occurence in comparison it seems valid to remove them as they are not the target group and make up a small subset of the complete dataset.</p>
</section>
<section id="time-factors-on-card-status" class="level3">
<h3 class="anchored" data-anchor-id="time-factors-on-card-status">Time factors on Card Status</h3>
<p>The time between creating an account and issuing a card may also be important when filtering customers based on their history. We should avoid filtering out potentially interesting periods and understand how the timespans between account creation and card issuance are distributed.</p>
<div id="44f3b0a8" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>non_transactional_w_cards_df <span class="op">=</span> non_transactional_df[non_transactional_df[<span class="st">'card_issued'</span>].notna() <span class="op">&amp;</span> non_transactional_df[<span class="st">'account_created'</span>].notna()]</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>non_transactional_w_cards_df[<span class="st">'duration_days'</span>] <span class="op">=</span> (non_transactional_w_cards_df[<span class="st">'card_issued'</span>] <span class="op">-</span> non_transactional_w_cards_df[<span class="st">'account_created'</span>]).dt.days</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>sns.histplot(non_transactional_w_cards_df[<span class="st">'duration_days'</span>], bins<span class="op">=</span><span class="dv">50</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, kde<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Distribution of Duration Between Account Creation and Card Issuance'</span>)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Duration in Days'</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Frequency'</span>)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1880/3937256510.py:2: SettingWithCopyWarning:


A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-60-output-2.png" width="1137" height="752" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The histogram displays a distribution with multiple peaks, indicating that there are several typical time frames for card issuance after account creation. The highest peak occurs within the first 250 days, suggesting that a significant number of cards are issued during this period. The frequency decreases as duration increases, with noticeable peaks that may correspond to specific processing batch cycles or policy changes over time. The distribution also has a long tail, suggesting that in some cases, card issuance can take a very long time.</p>
<p>Analyzing the length of time a client has been with the bank in relation to their account creation date and card ownership can provide valuable insights for a banks customer relationship management and product targeting strategies. Long-standing clients may exhibit different banking behaviors, such as product adoption and loyalty patterns, compared to newer clients.</p>
<div id="9de8df73" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>max_account_creation_date <span class="op">=</span> non_transactional_df[<span class="st">'card_issued'</span>].<span class="bu">max</span>()</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>non_transactional_df[<span class="st">'client_tenure_years_relative'</span>] <span class="op">=</span> (max_account_creation_date <span class="op">-</span> non_transactional_df[<span class="st">'account_created'</span>]).dt.days <span class="op">/</span> <span class="fl">365.25</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.histplot(</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>non_transactional_df, </span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'client_tenure_years_relative'</span>, </span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">'has_card'</span>, </span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    multiple<span class="op">=</span><span class="st">'stack'</span>, </span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    binwidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    stat<span class="op">=</span><span class="st">"percent"</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the function to add labels</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>add_percentage_labels(ax, non_transactional_df[<span class="st">'has_card'</span>].unique())</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional plot formatting</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Client Tenure Relative to Latest Card Issued Date and Card Ownership'</span>)</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Client Tenure (Years, Relative to Latest Card Issuance)'</span>)</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Percentage of Clients'</span>)</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the plot</span></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-61-output-1.png" width="945" height="560" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The bar chart shows the tenure of clients in years, categorized by whether they own a credit card (True) or not (False). Each bar represents the percentage of clients within a specific tenure range, allowing for comparison of the distribution of card ownership among clients with different lengths of association with the bank.</p>
</section>
<section id="demographics" class="level3">
<h3 class="anchored" data-anchor-id="demographics">Demographics</h3>
<p>Using the available demographic data, we can investigate the potential correlation between demographic data and card status. The average salary may indicate a difference between cardholders and non-cardholders, as it is reasonable to assume that cardholders have a higher average salary than non-cardholders.</p>
<div id="f105348f" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">'has_card'</span>, y<span class="op">=</span><span class="st">'client_average_salary'</span>, data<span class="op">=</span>non_transactional_df)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Average Salary in Client's Region by Card Ownership"</span>)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Has Card'</span>)</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Average Salary'</span>)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>plt.xticks([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="st">'No Card Owner'</span>, <span class="st">'Card Owner'</span>])</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-62-output-1.png" width="945" height="560" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The box plot compares the average salaries of clients who own a credit card with those who do not. Both groups have a substantial overlap in salary ranges, suggesting that while there might be a trend for card owners to have higher salaries, the difference is not significant. The median salary for card owners is slightly higher than that for non-card owners, as indicated by the median line within the respective boxes.</p>
<p>Both distributions have outliers on the higher end, indicating that some individuals have salaries significantly above the average in both groups. However, these outliers do not dominate the general trend.</p>
<p>It should also be noted that this plot assumes that the average salary of the regions clients remained constant over the years, which is unlikely to be true.</p>
<p>The group of bar charts represents the distribution of credit card ownership across various demographics, showing the percentage of clients with and without cards within different age groups, sexes, and regions.</p>
<div id="29ef823f" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>non_transactional_df[<span class="st">'age_group'</span>] <span class="op">=</span> pd.cut(non_transactional_df[<span class="st">'age'</span>], bins<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">25</span>, <span class="dv">40</span>, <span class="dv">55</span>, <span class="dv">70</span>, <span class="dv">100</span>], labels<span class="op">=</span>[<span class="st">'&lt;25'</span>, <span class="st">'25-40'</span>, <span class="st">'40-55'</span>, <span class="st">'55-70'</span>, <span class="st">'&gt;70'</span>])</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">15</span>))</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Age Group</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>age_group_counts <span class="op">=</span> non_transactional_df.groupby([<span class="st">'age_group'</span>, <span class="st">'has_card'</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>age_group_percentages <span class="op">=</span> (age_group_counts.T <span class="op">/</span> age_group_counts.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)).T <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>age_group_plot <span class="op">=</span> age_group_percentages.plot(kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>plt.gca())</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>age_group_plot.set_title(<span class="st">'Card Ownership by Age Group'</span>)</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>age_group_plot.set_ylabel(<span class="st">'Percentage'</span>)</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>add_percentage_labels(age_group_plot, non_transactional_df[<span class="st">'has_card'</span>].unique())</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Sex</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>sex_counts <span class="op">=</span> non_transactional_df.groupby([<span class="st">'sex'</span>, <span class="st">'has_card'</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>sex_percentages <span class="op">=</span> (sex_counts.T <span class="op">/</span> sex_counts.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)).T <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>sex_plot <span class="op">=</span> sex_percentages.plot(kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>plt.gca())</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>sex_plot.set_title(<span class="st">'Card Ownership by Sex'</span>)</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>sex_plot.set_ylabel(<span class="st">'Percentage'</span>)</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>add_percentage_labels(sex_plot, non_transactional_df[<span class="st">'has_card'</span>].unique())</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Client Region</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>region_counts <span class="op">=</span> non_transactional_df.groupby([<span class="st">'client_region'</span>, <span class="st">'has_card'</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>region_percentages <span class="op">=</span> (region_counts.T <span class="op">/</span> region_counts.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)).T <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>region_plot <span class="op">=</span> region_percentages.plot(kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>plt.gca())</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>region_plot.set_title(<span class="st">'Card Ownership by Client Region'</span>)</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>region_plot.set_ylabel(<span class="st">'Percentage'</span>)</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>region_plot.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>add_percentage_labels(region_plot, non_transactional_df[<span class="st">'has_card'</span>].unique())</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1880/1112744898.py:7: FutureWarning:

The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-63-output-2.png" width="1425" height="1424" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Card Ownership by Age Group:</strong> The bar chart displays the proportion of cardholders in different age groups. The percentage of cardholders is lowest in the age group of over 70, followed by the age group of 55-70, indicating that card ownership is more prevalent among younger demographics.</p>
<p><strong>Card Ownership by Sex:</strong> The bar chart shows the breakdown of card ownership by sex. The data reveals that the percentage of cardholders is comparable between both sexes, and no significant difference is present.</p>
<p><strong>Card Ownership by Region</strong> The bar chart at the bottom illustrates card ownership across different regions, showing a relatively consistent pattern among most regions.</p>
</section>
<section id="impact-of-loans-debt" class="level3">
<h3 class="anchored" data-anchor-id="impact-of-loans-debt">Impact of Loans / Debt</h3>
<div id="0db4503e" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>simplified_loan_status_mapping <span class="op">=</span> {</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Contract finished, no problems"</span>: <span class="st">"Finished"</span>,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Contract finished, loan not paid"</span>: <span class="st">"Not Paid"</span>,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Contract running, OK thus-far"</span>: <span class="st">"Running"</span>,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Contract running, client in debt"</span>: <span class="st">"In Debt"</span>,</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No Loan"</span>: <span class="st">"No Loan"</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>non_transactional_df[<span class="st">'loan_status_simplified'</span>] <span class="op">=</span> non_transactional_df[<span class="st">'loan_status'</span>].<span class="bu">map</span>(simplified_loan_status_mapping)</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="co">## this variable wants to kill itself</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>loan_status_simplified_card_ownership_counts <span class="op">=</span> non_transactional_df.groupby([<span class="st">'loan_status_simplified'</span>, <span class="st">'has_card'</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>loan_status_simplified_card_ownership_percentages <span class="op">=</span> (loan_status_simplified_card_ownership_counts.T <span class="op">/</span> loan_status_simplified_card_ownership_counts.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)).T <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>loan_status_simplified_card_ownership_percentages.plot(kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Interaction Between Simplified Loan Status and Card Ownership'</span>)</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Simplified Loan Status'</span>)</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Percentage of Clients'</span>)</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">'Has Card'</span>, labels<span class="op">=</span>[<span class="st">'No Card'</span>, <span class="st">'Has Card'</span>])</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-64-output-1.png" width="945" height="561" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="transactional-data" class="level1">
<h1>Transactional Data</h1>
<section id="set-artificial-issue-date-for-non-card-holders" class="level2">
<h2 class="anchored" data-anchor-id="set-artificial-issue-date-for-non-card-holders">Set artificial issue date for non-card holders</h2>
<div id="67579557" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_months_since_account_to_card(df):</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'months_since_account_to_card'</span>] <span class="op">=</span> df.<span class="bu">apply</span>(</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> row: (row[<span class="st">'card_issued'</span>].to_period(<span class="st">'M'</span>) <span class="op">-</span> row[<span class="st">'account_created'</span>].to_period(<span class="st">'M'</span>)).n</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notnull(row[<span class="st">'card_issued'</span>]) <span class="kw">and</span> pd.notnull(row[<span class="st">'account_created'</span>]) <span class="cf">else</span> np.nan, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter_clients_without_sufficient_history(non_transactional_df, min_history_months<span class="op">=</span><span class="dv">25</span>):</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'months_since_account_to_card'</span> <span class="kw">not</span> <span class="kw">in</span> non_transactional_df.columns:</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Warning: months_since_account_to_card column not found. Calculating history length."</span>)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>        non_transactional_df <span class="op">=</span> add_months_since_account_to_card(non_transactional_df)</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    count_before <span class="op">=</span> <span class="bu">len</span>(non_transactional_df)</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    filtered_df <span class="op">=</span> non_transactional_df[non_transactional_df[<span class="st">'months_since_account_to_card'</span>].isnull() <span class="op">|</span> (non_transactional_df[<span class="st">'months_since_account_to_card'</span>] <span class="op">&gt;=</span> min_history_months)]</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Filtered out </span><span class="sc">{</span>count_before <span class="op">-</span> <span class="bu">len</span>(filtered_df)<span class="sc">}</span><span class="ss"> records with less than </span><span class="sc">{</span>min_history_months<span class="sc">}</span><span class="ss"> months of history. Percentage: </span><span class="sc">{</span>(count_before <span class="op">-</span> <span class="bu">len</span>(filtered_df)) <span class="op">/</span> count_before <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%."</span>)</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> filtered_df</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>before_len <span class="op">=</span> <span class="bu">len</span>(non_transactional_df)</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>non_transactional_w_sufficient_history_df <span class="op">=</span> filter_clients_without_sufficient_history(non_transactional_df)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>data_reduction[<span class="st">"Clients without sufficient history"</span>] <span class="op">=</span> <span class="op">-</span>(before_len <span class="op">-</span> <span class="bu">len</span>(non_transactional_w_sufficient_history_df))</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> before_len</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: months_since_account_to_card column not found. Calculating history length.
Filtered out 419 records with less than 25 months of history. Percentage: 9.62%.</code></pre>
</div>
</div>
<div id="3198cdd9" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>non_transactional_w_card_df <span class="op">=</span> non_transactional_w_sufficient_history_df.dropna(subset<span class="op">=</span>[<span class="st">'card_issued'</span>]).copy()</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>sns.histplot(non_transactional_w_card_df[<span class="st">'months_since_account_to_card'</span>], kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Distribution of Months from Account Creation to Card Issuance'</span>)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Months'</span>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Count'</span>)</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-66-output-1.png" width="1137" height="752" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="match-by-similar-transaction-activity" class="level3">
<h3 class="anchored" data-anchor-id="match-by-similar-transaction-activity">Match by similar transaction activity</h3>
<p>The following approaches are in discussion: - Looking at the distributions above extract the amount of history a buyer most likely has at the issue data of the card - For each non buyer, find a buyer which was active in a similar time window (Jaccard similarity on the Year-Month sets)</p>
<section id="new-idea" class="level4">
<h4 class="anchored" data-anchor-id="new-idea">NEW IDEA</h4>
<p>Instead of looking at the full activity of a buyer, we only look at the pre-purchase activity as there is reason to believe that clients may change their patterns after purchasing date and therefore add unwanted bias.</p>
<p><img src="./docs/IMG_BBEF82A6C6B5-1.jpeg" class="img-fluid"></p>
</section>
</section>
<section id="focus-on-contextual-engagement" class="level3">
<h3 class="anchored" data-anchor-id="focus-on-contextual-engagement">Focus on Contextual Engagement</h3>
<p>Our approach to setting artificial card issue date for non-cardholders goes beyond simple feature matching. We concentrate on the periods during which clients engage with the bank in the form of transactions. This method assumes that clients active during similar periods might be influenced by the same economic and societal conditions, providing a more nuanced foundation for establishing connections between current cardholders and potential new ones.</p>
<p>The process emphasizes matching based on the timing of activity, rather than a wide array of characteristics. By identifying when both existing cardholders and non-cardholders interacted with the bank, we can infer a level of behavioral alignment that extends beyond mere transactional data. This alignment suggests a shared response to external conditions.</p>
</section>
<section id="mechanism-of-matching" class="level3">
<h3 class="anchored" data-anchor-id="mechanism-of-matching">Mechanism of Matching</h3>
<p>Our matching utilizes the Jaccard similarity index to compare activity patterns:</p>
<ul>
<li><strong>Activity Comparison</strong>: We compare a vector representing an existing cardholders monthly activity against a matrix of non-cardholders activity patterns. Here we only consider the activity from the first transaction period across all customers to the card issue date.</li>
<li><strong>Use of Jaccard Index</strong>: This metric helps us quantify the resemblance between the activity patterns, focusing on the occurrence of activity rather than its volume, to identify meaningful parallels.</li>
</ul>
</section>
<section id="eligibility-and-selection" class="level3">
<h3 class="anchored" data-anchor-id="eligibility-and-selection">Eligibility and Selection</h3>
<p>Potential matches are subjected to specific criteria to ensure alignment for later model construction:</p>
<ol type="1">
<li><strong>Account History</strong>: Non-cardholders must have an established history of interaction, with at least 25 months of history between account creation and card issuance (12 months = period as a new customer + 13 months = one year of history + 1 month lag).</li>
<li><strong>Period of Activity</strong>: The analysis considers activities up to the card issuance date of the cardholder, aligning potential non-cardholders based on their response to similar conditions.</li>
<li><strong>Selection Process</strong>: From the non-cardholders with high similarity scores, one is randomly selected from the top-N candidates to maintain fairness in the matching process.</li>
</ol>
</section>
<section id="objective-of-the-process" class="level3">
<h3 class="anchored" data-anchor-id="objective-of-the-process">Objective of the Process</h3>
<p>This matching strategy is designed to identify potential cardholders whose historical interaction patterns suggest a fit with card holders. The focus on specific periods of engagement, backed by eligibility criteria and a fair selection process, ensures that new additions to our cardholder base share a commonality that goes beyond surface-level similarities without searching a direct twin for each card holder.</p>
</section>
<section id="construction-of-the-activity-matrix" class="level3">
<h3 class="anchored" data-anchor-id="construction-of-the-activity-matrix">Construction of the Activity Matrix</h3>
<p>The activity matrix serves as the foundation of our matching process, mapping out the engagement of clients with our services over time. It is constructed from transaction data, organizing client interactions into a structured format that highlights periods of activity.</p>
<ol type="1">
<li><p><strong>Data Aggregation</strong>: We start with transaction data, which records each clients interactions across various months. This data includes every transaction made by both current cardholders and potential non-cardholders.</p></li>
<li><p><strong>Temporal Transformation</strong>: Each transaction is associated with a specific date. These dates are then transformed into monthly periods, consolidating daily transactions into a monthly view of activity. This step simplifies the data, focusing on the presence of activity within each month rather than the specific dates or frequencies of transactions.</p></li>
<li><p><strong>Matrix Structure</strong>: The transformed data is arranged into a matrix format. Rows represent individual clients, identified by their account IDs. Columns correspond to monthly periods, spanning the entire range of months covered by the transaction data.</p></li>
<li><p><strong>Activity Indication</strong>: In the matrix, a cell value is set to indicate the presence of activity for a given client in a given month. If a client made one or more transactions in a month, the corresponding cell is marked to reflect this activity. The absence of transactions for a client in a month leaves the cell unmarked.</p></li>
<li><p><strong>Binary Representation</strong>: The final step involves converting the activity indicators into a binary format. Active months are represented by a 1, indicating the presence of transactions, while inactive months are denoted by a 0, indicating no transactions.</p></li>
</ol>
<p>The heatmap provided offers a visual representation of the activity matrix for clients, depicting the levels of engagement over various periods.</p>
<ul>
<li><p><strong>Diagonal Trend</strong>: There is a distinct diagonal pattern, indicating that newer accounts (those created more recently) have fewer periods of activity. This makes sense as these accounts have not had the opportunity to transact over the earlier periods displayed on the heatmap.</p></li>
<li><p><strong>Darker Areas (Purple)</strong>: These represent periods of inactivity where clients did not engage. The darker the shade, the less activity occurred in that particular period for the corresponding set of accounts.</p></li>
<li><p><strong>Brighter Areas (Yellow)</strong>: In contrast, the brighter areas denote periods of activity. A brighter shade implies more clients were active during that period.</p></li>
<li><p><strong>Account Creation Date</strong>: Clients are sorted by their account creation date. Those who joined earlier are at the top, while more recent clients appear toward the bottom of the heatmap.</p></li>
</ul>
<div id="672d47ab" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_activity_matrix(transactions):</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create an activity matrix from transaction data.</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co">    The function transforms transaction data into a binary matrix that indicates</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co">    whether an account was active in a given month.</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - transactions (pd.DataFrame): A DataFrame containing the transaction data.</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - pd.DataFrame: An activity matrix with accounts as rows and months as columns.</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>    transactions[<span class="st">'month_year'</span>] <span class="op">=</span> transactions[<span class="st">'date'</span>].dt.to_period(<span class="st">'M'</span>)</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>    transactions[<span class="st">'active'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>    activity_matrix <span class="op">=</span> transactions.pivot_table(index<span class="op">=</span><span class="st">'account_id'</span>, </span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>                                    columns<span class="op">=</span><span class="st">'month_year'</span>, </span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>                                    values<span class="op">=</span><span class="st">'active'</span>, </span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>                                    fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>    activity_matrix.columns <span class="op">=</span> [<span class="ss">f'active_</span><span class="sc">{</span><span class="bu">str</span>(col)<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> col <span class="kw">in</span> activity_matrix.columns]</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> activity_matrix</span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_activity_matrix(activity_matrix):</span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>    sparse_matrix <span class="op">=</span> activity_matrix.astype(<span class="bu">bool</span>)    </span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>))</span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(sparse_matrix, cmap<span class="op">=</span><span class="st">'viridis'</span>, cbar<span class="op">=</span><span class="va">True</span>, yticklabels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Activity Matrix across all clients sorted by account creation date'</span>)</span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Period'</span>)</span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Accounts'</span>)</span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>activity_matrix <span class="op">=</span> prepare_activity_matrix(transactions_df)</span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>plot_activity_matrix(activity_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-67-output-1.png" width="1378" height="925" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="4da3183d" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> pairwise_distances</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_eligibility_for_matching(non_cardholder, cardholder, verbose<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Determine if a non-cardholder is eligible for matching with a cardholder.</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co">    This function checks whether the card issuance to a cardholder occurred at least</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="co">    25 months after the non-cardholder's account was created.</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - non_cardholder (pd.Series): A data series containing the non-cardholder's details.</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - cardholder (pd.Series): A data series containing the cardholder's details.</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a><span class="co">    - verbose (bool): If True, print detailed eligibility information. Default is False.</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="co">    - bool: True if the non-cardholder is eligible for matching, False otherwise.</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cardholder[<span class="st">'card_issued'</span>] <span class="op">&lt;=</span> non_cardholder[<span class="st">'account_created'</span>]:</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span>    </span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    period_diff <span class="op">=</span> (cardholder[<span class="st">'card_issued'</span>].to_period(<span class="st">'M'</span>) <span class="op">-</span> non_cardholder[<span class="st">'account_created'</span>].to_period(<span class="st">'M'</span>)).n</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Card issued: </span><span class="sc">{</span>cardholder[<span class="st">'card_issued'</span>]<span class="sc">}</span><span class="ss">, Account created: </span><span class="sc">{</span>non_cardholder[<span class="st">'account_created'</span>]<span class="sc">}</span><span class="ss">, Period diff: </span><span class="sc">{</span>period_diff<span class="sc">}</span><span class="ss">, Eligible: </span><span class="sc">{</span>period_diff <span class="op">&gt;=</span> <span class="dv">25</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> period_diff <span class="op">&gt;=</span> <span class="dv">25</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> match_cardholders_with_non_cardholders(non_transactional, transactions, top_n<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a><span class="co">    Match cardholders with non-cardholders based on the similarity of their activity patterns.</span></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a><span class="co">    The function creates an activity matrix, identifies eligible non-cardholders, calculates</span></span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a><span class="co">    the Jaccard similarity to find matches, and randomly selects one match per cardholder</span></span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a><span class="co">    from the top N similar non-cardholders.</span></span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a><span class="co">    - non_transactional (pd.DataFrame): A DataFrame containing non-cardholders.</span></span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a><span class="co">    - transactions (pd.DataFrame): A DataFrame containing transactional data.</span></span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a><span class="co">    - top_n (int): The number of top similar non-cardholders to consider for matching.</span></span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a><span class="co">    - list: A list of tuples with the cardholder and matched non-cardholder client IDs and similarity scores.</span></span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true" tabindex="-1"></a>    with_card <span class="op">=</span> non_transactional[non_transactional[<span class="st">'card_issued'</span>].notna()]</span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true" tabindex="-1"></a>    without_card <span class="op">=</span> non_transactional[non_transactional[<span class="st">'card_issued'</span>].isna()]</span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true" tabindex="-1"></a>    activity_matrix <span class="op">=</span> prepare_activity_matrix(transactions)</span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true" tabindex="-1"></a>    with_card_activity <span class="op">=</span> with_card.join(activity_matrix, on<span class="op">=</span><span class="st">'account_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true" tabindex="-1"></a>    without_card_activity <span class="op">=</span> without_card.join(activity_matrix, on<span class="op">=</span><span class="st">'account_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true" tabindex="-1"></a>    matched_non_cardholders <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true" tabindex="-1"></a>    matches <span class="op">=</span> []</span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, cardholder <span class="kw">in</span> tqdm(with_card_activity.iterrows(), total<span class="op">=</span><span class="bu">len</span>(with_card_activity), desc<span class="op">=</span><span class="st">'Matching cardholders'</span>):</span>
<span id="cb84-57"><a href="#cb84-57" aria-hidden="true" tabindex="-1"></a>        issue_period <span class="op">=</span> cardholder[<span class="st">'card_issued'</span>].to_period(<span class="st">'M'</span>)</span>
<span id="cb84-58"><a href="#cb84-58" aria-hidden="true" tabindex="-1"></a>        eligible_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> activity_matrix <span class="cf">if</span> col.startswith(<span class="st">'active'</span>) <span class="kw">and</span> pd.Period(col.split(<span class="st">'_'</span>)[<span class="dv">1</span>]) <span class="op">&lt;=</span> issue_period]</span>
<span id="cb84-59"><a href="#cb84-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-60"><a href="#cb84-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> eligible_cols:</span>
<span id="cb84-61"><a href="#cb84-61" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"No eligible months found for cardholder client_id </span><span class="sc">{</span>cardholder[<span class="st">'client_id'</span>]<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb84-62"><a href="#cb84-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb84-63"><a href="#cb84-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-64"><a href="#cb84-64" aria-hidden="true" tabindex="-1"></a>        cardholder_vector <span class="op">=</span> cardholder[eligible_cols].fillna(<span class="dv">0</span>).astype(<span class="bu">bool</span>).values.reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb84-65"><a href="#cb84-65" aria-hidden="true" tabindex="-1"></a>        non_cardholder__matrix <span class="op">=</span> without_card_activity[eligible_cols].fillna(<span class="dv">0</span>).astype(<span class="bu">bool</span>).values        </span>
<span id="cb84-66"><a href="#cb84-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> cardholder_vector.shape[<span class="dv">1</span>] <span class="op">==</span> non_cardholder__matrix.shape[<span class="dv">1</span>], <span class="st">"Dimension mismatch between cardholder and applicant activity matrix."</span></span>
<span id="cb84-67"><a href="#cb84-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-68"><a href="#cb84-68" aria-hidden="true" tabindex="-1"></a>        distances <span class="op">=</span> pairwise_distances(cardholder_vector, non_cardholder__matrix, metric<span class="op">=</span><span class="st">'jaccard'</span>).flatten()</span>
<span id="cb84-69"><a href="#cb84-69" aria-hidden="true" tabindex="-1"></a>        eligible_non_cardholders <span class="op">=</span> [i <span class="cf">for</span> i, applicant <span class="kw">in</span> without_card_activity.iterrows()</span>
<span id="cb84-70"><a href="#cb84-70" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">if</span> check_eligibility_for_matching(applicant, cardholder) <span class="kw">and</span> i <span class="kw">not</span> <span class="kw">in</span> matched_non_cardholders]</span>
<span id="cb84-71"><a href="#cb84-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-72"><a href="#cb84-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> eligible_non_cardholders:</span>
<span id="cb84-73"><a href="#cb84-73" aria-hidden="true" tabindex="-1"></a>            select_non_cardholders(distances, eligible_non_cardholders, matches, matched_non_cardholders, cardholder, without_card_activity, top_n)</span>
<span id="cb84-74"><a href="#cb84-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb84-75"><a href="#cb84-75" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"No eligible non-cardholders found for cardholder client_id </span><span class="sc">{</span>cardholder[<span class="st">'client_id'</span>]<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb84-76"><a href="#cb84-76" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb84-77"><a href="#cb84-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> matches</span>
<span id="cb84-78"><a href="#cb84-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-79"><a href="#cb84-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> select_non_cardholders(distances, eligible_non_cardholders, matches, matched_applicants, cardholder, without_card_activity, top_n):</span>
<span id="cb84-80"><a href="#cb84-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb84-81"><a href="#cb84-81" aria-hidden="true" tabindex="-1"></a><span class="co">    Randomly select a non-cardholder match for a cardholder from the top N eligible candidates.</span></span>
<span id="cb84-82"><a href="#cb84-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-83"><a href="#cb84-83" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb84-84"><a href="#cb84-84" aria-hidden="true" tabindex="-1"></a><span class="co">    - distances (np.array): An array of Jaccard distances between a cardholder and non-cardholders.</span></span>
<span id="cb84-85"><a href="#cb84-85" aria-hidden="true" tabindex="-1"></a><span class="co">    - eligible_non_cardholders (list): A list of indices for non-cardholders who are eligible for matching.</span></span>
<span id="cb84-86"><a href="#cb84-86" aria-hidden="true" tabindex="-1"></a><span class="co">    - matches (list): A list to which the match will be appended.</span></span>
<span id="cb84-87"><a href="#cb84-87" aria-hidden="true" tabindex="-1"></a><span class="co">    - matched_applicants (set): A set of indices for non-cardholders who have already been matched.</span></span>
<span id="cb84-88"><a href="#cb84-88" aria-hidden="true" tabindex="-1"></a><span class="co">    - cardholder (pd.Series): The data series of the current cardholder.</span></span>
<span id="cb84-89"><a href="#cb84-89" aria-hidden="true" tabindex="-1"></a><span class="co">    - without_card_activity (pd.DataFrame): A DataFrame of non-cardholders without card issuance.</span></span>
<span id="cb84-90"><a href="#cb84-90" aria-hidden="true" tabindex="-1"></a><span class="co">    - top_n (int): The number of top similar non-cardholders to consider for matching.</span></span>
<span id="cb84-91"><a href="#cb84-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-92"><a href="#cb84-92" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb84-93"><a href="#cb84-93" aria-hidden="true" tabindex="-1"></a><span class="co">    - None: The matches list is updated in place with the selected match.</span></span>
<span id="cb84-94"><a href="#cb84-94" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb84-95"><a href="#cb84-95" aria-hidden="true" tabindex="-1"></a>    eligible_distances <span class="op">=</span> distances[eligible_non_cardholders]</span>
<span id="cb84-96"><a href="#cb84-96" aria-hidden="true" tabindex="-1"></a>    sorted_indices <span class="op">=</span> np.argsort(eligible_distances)[:top_n]</span>
<span id="cb84-97"><a href="#cb84-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-98"><a href="#cb84-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sorted_indices.size <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb84-99"><a href="#cb84-99" aria-hidden="true" tabindex="-1"></a>        selected_index <span class="op">=</span> np.random.choice(sorted_indices)</span>
<span id="cb84-100"><a href="#cb84-100" aria-hidden="true" tabindex="-1"></a>        actual_selected_index <span class="op">=</span> eligible_non_cardholders[selected_index]</span>
<span id="cb84-101"><a href="#cb84-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-102"><a href="#cb84-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> actual_selected_index <span class="kw">not</span> <span class="kw">in</span> matched_applicants:</span>
<span id="cb84-103"><a href="#cb84-103" aria-hidden="true" tabindex="-1"></a>            matched_applicants.add(actual_selected_index)</span>
<span id="cb84-104"><a href="#cb84-104" aria-hidden="true" tabindex="-1"></a>            applicant <span class="op">=</span> without_card_activity.iloc[actual_selected_index]</span>
<span id="cb84-105"><a href="#cb84-105" aria-hidden="true" tabindex="-1"></a>            similarity <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> eligible_distances[selected_index]</span>
<span id="cb84-106"><a href="#cb84-106" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb84-107"><a href="#cb84-107" aria-hidden="true" tabindex="-1"></a>            matches.append((cardholder[<span class="st">'client_id'</span>], applicant[<span class="st">'client_id'</span>], similarity))</span>
<span id="cb84-108"><a href="#cb84-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-109"><a href="#cb84-109" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_artificial_issue_dates(non_transactional_df, matches):</span>
<span id="cb84-110"><a href="#cb84-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb84-111"><a href="#cb84-111" aria-hidden="true" tabindex="-1"></a><span class="co">    Augment the non-transactional DataFrame with artificial card issue dates based on matching results.</span></span>
<span id="cb84-112"><a href="#cb84-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-113"><a href="#cb84-113" aria-hidden="true" tabindex="-1"></a><span class="co">    Each matched non-cardholder is assigned a card issue date corresponding to their matched</span></span>
<span id="cb84-114"><a href="#cb84-114" aria-hidden="true" tabindex="-1"></a><span class="co">    cardholder. The 'has_card' flag for each non-cardholder is updated accordingly.</span></span>
<span id="cb84-115"><a href="#cb84-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-116"><a href="#cb84-116" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb84-117"><a href="#cb84-117" aria-hidden="true" tabindex="-1"></a><span class="co">    - non_transactional_df (pd.DataFrame): The DataFrame of non-cardholders to augment.</span></span>
<span id="cb84-118"><a href="#cb84-118" aria-hidden="true" tabindex="-1"></a><span class="co">    - matches (list): A list of tuples containing the matched cardholder and non-cardholder IDs and similarity scores.</span></span>
<span id="cb84-119"><a href="#cb84-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-120"><a href="#cb84-120" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb84-121"><a href="#cb84-121" aria-hidden="true" tabindex="-1"></a><span class="co">    - pd.DataFrame: The augmented DataFrame with artificial card issue dates.</span></span>
<span id="cb84-122"><a href="#cb84-122" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb84-123"><a href="#cb84-123" aria-hidden="true" tabindex="-1"></a>    augmented_df <span class="op">=</span> non_transactional_df.copy()</span>
<span id="cb84-124"><a href="#cb84-124" aria-hidden="true" tabindex="-1"></a>    augmented_df[<span class="st">'has_card'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb84-125"><a href="#cb84-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-126"><a href="#cb84-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cardholder_id, non_cardholder_id, _ <span class="kw">in</span> matches:</span>
<span id="cb84-127"><a href="#cb84-127" aria-hidden="true" tabindex="-1"></a>        card_issue_date <span class="op">=</span> augmented_df.loc[augmented_df[<span class="st">'client_id'</span>] <span class="op">==</span> cardholder_id, <span class="st">'card_issued'</span>].values[<span class="dv">0</span>]</span>
<span id="cb84-128"><a href="#cb84-128" aria-hidden="true" tabindex="-1"></a>        augmented_df.loc[augmented_df[<span class="st">'client_id'</span>] <span class="op">==</span> non_cardholder_id, [<span class="st">'card_issued'</span>, <span class="st">'has_card'</span>]] <span class="op">=</span> [card_issue_date, <span class="va">False</span>]</span>
<span id="cb84-129"><a href="#cb84-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-130"><a href="#cb84-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> augmented_df</span>
<span id="cb84-131"><a href="#cb84-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-132"><a href="#cb84-132" aria-hidden="true" tabindex="-1"></a>matched_non_card_holders_df <span class="op">=</span> match_cardholders_with_non_cardholders(non_transactional_w_sufficient_history_df, transactions_df)</span>
<span id="cb84-133"><a href="#cb84-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-134"><a href="#cb84-134" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Percentage of clients with card issued: </span><span class="sc">{</span>non_transactional_w_sufficient_history_df[<span class="st">'card_issued'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean() <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb84-135"><a href="#cb84-135" aria-hidden="true" tabindex="-1"></a>matched_non_card_holders_w_issue_date_df <span class="op">=</span> set_artificial_issue_dates(non_transactional_w_sufficient_history_df, matched_non_card_holders_df)</span>
<span id="cb84-136"><a href="#cb84-136" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Percentage of clients with card issued after matching: </span><span class="sc">{</span>matched_non_card_holders_w_issue_date_df[<span class="st">'card_issued'</span>]<span class="sc">.</span>notna()<span class="sc">.</span>mean() <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Matching cardholders:   0%|          | 0/328 [00:00&lt;?, ?it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   0%|          | 1/328 [00:00&lt;01:53,  2.88it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   1%|          | 2/328 [00:00&lt;01:50,  2.94it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   1%|          | 3/328 [00:01&lt;01:50,  2.94it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   1%|          | 4/328 [00:01&lt;01:43,  3.13it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   2%|         | 5/328 [00:01&lt;01:38,  3.26it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   2%|         | 6/328 [00:01&lt;01:41,  3.16it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   2%|         | 7/328 [00:02&lt;01:43,  3.11it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   2%|         | 8/328 [00:02&lt;01:43,  3.08it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   3%|         | 9/328 [00:02&lt;01:32,  3.46it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   3%|         | 10/328 [00:03&lt;01:24,  3.75it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   3%|         | 11/328 [00:03&lt;01:31,  3.47it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   4%|         | 12/328 [00:03&lt;01:35,  3.31it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   4%|         | 13/328 [00:04&lt;01:38,  3.21it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   4%|         | 14/328 [00:04&lt;01:35,  3.28it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   5%|         | 15/328 [00:04&lt;01:38,  3.19it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   5%|         | 16/328 [00:04&lt;01:28,  3.55it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   5%|         | 17/328 [00:05&lt;01:20,  3.86it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   5%|         | 18/328 [00:05&lt;01:17,  4.03it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   6%|         | 19/328 [00:05&lt;01:23,  3.70it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   6%|         | 20/328 [00:05&lt;01:27,  3.52it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   6%|         | 21/328 [00:06&lt;01:32,  3.33it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   7%|         | 22/328 [00:06&lt;01:34,  3.22it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   7%|         | 23/328 [00:06&lt;01:36,  3.15it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   7%|         | 24/328 [00:07&lt;01:38,  3.07it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   8%|         | 25/328 [00:07&lt;01:39,  3.04it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   8%|         | 26/328 [00:08&lt;01:46,  2.82it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   8%|         | 27/328 [00:08&lt;01:36,  3.11it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   9%|         | 28/328 [00:08&lt;01:36,  3.12it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   9%|         | 29/328 [00:08&lt;01:33,  3.18it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   9%|         | 30/328 [00:09&lt;01:36,  3.10it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:   9%|         | 31/328 [00:09&lt;01:33,  3.17it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  10%|         | 32/328 [00:09&lt;01:24,  3.49it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  10%|         | 33/328 [00:10&lt;01:26,  3.41it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  10%|         | 34/328 [00:10&lt;01:27,  3.37it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  11%|         | 35/328 [00:10&lt;01:29,  3.26it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  11%|         | 36/328 [00:10&lt;01:22,  3.53it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  11%|        | 37/328 [00:11&lt;01:27,  3.34it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  12%|        | 38/328 [00:11&lt;01:29,  3.22it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  12%|        | 39/328 [00:11&lt;01:26,  3.35it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  12%|        | 40/328 [00:12&lt;01:27,  3.30it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  12%|        | 41/328 [00:12&lt;01:29,  3.21it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  13%|        | 42/328 [00:12&lt;01:30,  3.17it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  13%|        | 43/328 [00:13&lt;01:31,  3.11it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  13%|        | 44/328 [00:13&lt;01:25,  3.32it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  14%|        | 45/328 [00:13&lt;01:21,  3.48it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  14%|        | 46/328 [00:13&lt;01:17,  3.62it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  14%|        | 47/328 [00:14&lt;01:22,  3.39it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  15%|        | 48/328 [00:14&lt;01:34,  2.96it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  15%|        | 49/328 [00:15&lt;01:34,  2.94it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  15%|        | 50/328 [00:15&lt;01:32,  3.00it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  16%|        | 51/328 [00:15&lt;01:29,  3.10it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  16%|        | 52/328 [00:15&lt;01:22,  3.36it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  16%|        | 53/328 [00:16&lt;01:24,  3.27it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  16%|        | 54/328 [00:16&lt;01:18,  3.50it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  17%|        | 55/328 [00:16&lt;01:20,  3.39it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  17%|        | 56/328 [00:17&lt;01:23,  3.26it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  17%|        | 57/328 [00:17&lt;01:25,  3.16it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  18%|        | 58/328 [00:17&lt;01:23,  3.25it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  18%|        | 59/328 [00:17&lt;01:16,  3.53it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  18%|        | 60/328 [00:18&lt;01:15,  3.53it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  19%|        | 61/328 [00:18&lt;01:12,  3.67it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  19%|        | 62/328 [00:18&lt;01:17,  3.43it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  19%|        | 63/328 [00:19&lt;01:20,  3.29it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  20%|        | 64/328 [00:19&lt;01:22,  3.22it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  20%|        | 65/328 [00:19&lt;01:23,  3.16it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  20%|        | 66/328 [00:20&lt;01:21,  3.21it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  20%|        | 67/328 [00:20&lt;01:23,  3.13it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  21%|        | 68/328 [00:20&lt;01:24,  3.08it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  21%|        | 69/328 [00:21&lt;01:29,  2.89it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  21%|       | 70/328 [00:21&lt;01:25,  3.00it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  22%|       | 71/328 [00:21&lt;01:25,  3.01it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  22%|       | 72/328 [00:22&lt;01:19,  3.23it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  22%|       | 73/328 [00:22&lt;01:21,  3.13it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  23%|       | 74/328 [00:22&lt;01:18,  3.22it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  23%|       | 75/328 [00:23&lt;01:19,  3.19it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  23%|       | 76/328 [00:23&lt;01:20,  3.12it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  23%|       | 77/328 [00:23&lt;01:20,  3.10it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  24%|       | 78/328 [00:24&lt;01:19,  3.13it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  24%|       | 79/328 [00:24&lt;01:21,  3.07it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  24%|       | 80/328 [00:24&lt;01:20,  3.07it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  25%|       | 81/328 [00:24&lt;01:15,  3.26it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  25%|       | 82/328 [00:25&lt;01:15,  3.27it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  25%|       | 83/328 [00:25&lt;01:17,  3.17it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  26%|       | 84/328 [00:25&lt;01:18,  3.11it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  26%|       | 85/328 [00:26&lt;01:16,  3.19it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  26%|       | 86/328 [00:26&lt;01:11,  3.36it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  27%|       | 87/328 [00:26&lt;01:17,  3.11it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  27%|       | 88/328 [00:27&lt;01:10,  3.41it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  27%|       | 89/328 [00:27&lt;01:06,  3.60it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  27%|       | 90/328 [00:27&lt;01:09,  3.42it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  28%|       | 91/328 [00:27&lt;01:12,  3.28it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  28%|       | 92/328 [00:28&lt;01:12,  3.24it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  28%|       | 93/328 [00:28&lt;01:14,  3.15it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  29%|       | 94/328 [00:28&lt;01:15,  3.11it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  29%|       | 95/328 [00:29&lt;01:15,  3.07it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  29%|       | 96/328 [00:29&lt;01:16,  3.04it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  30%|       | 97/328 [00:29&lt;01:15,  3.06it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  30%|       | 98/328 [00:30&lt;01:15,  3.04it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  30%|       | 99/328 [00:30&lt;01:15,  3.02it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  30%|       | 100/328 [00:30&lt;01:08,  3.34it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  31%|       | 101/328 [00:31&lt;01:06,  3.41it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  31%|       | 102/328 [00:31&lt;01:09,  3.26it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  31%|      | 103/328 [00:31&lt;01:11,  3.16it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  32%|      | 104/328 [00:32&lt;01:11,  3.12it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  32%|      | 105/328 [00:32&lt;01:08,  3.24it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  32%|      | 106/328 [00:32&lt;01:10,  3.16it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  33%|      | 107/328 [00:33&lt;01:15,  2.91it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  33%|      | 108/328 [00:33&lt;01:08,  3.23it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  33%|      | 109/328 [00:33&lt;01:02,  3.48it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  34%|      | 110/328 [00:33&lt;01:05,  3.32it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  34%|      | 111/328 [00:34&lt;01:08,  3.18it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  34%|      | 112/328 [00:34&lt;01:07,  3.19it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  34%|      | 113/328 [00:34&lt;01:04,  3.32it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  35%|      | 114/328 [00:35&lt;01:06,  3.22it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  35%|      | 115/328 [00:35&lt;01:07,  3.15it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  35%|      | 116/328 [00:35&lt;01:06,  3.20it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  36%|      | 117/328 [00:36&lt;01:06,  3.17it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  36%|      | 118/328 [00:36&lt;01:01,  3.44it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  36%|      | 119/328 [00:36&lt;01:04,  3.27it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  37%|      | 120/328 [00:37&lt;01:02,  3.34it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  37%|      | 121/328 [00:37&lt;01:05,  3.18it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  37%|      | 122/328 [00:37&lt;01:01,  3.37it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  38%|      | 123/328 [00:37&lt;01:00,  3.37it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  38%|      | 124/328 [00:38&lt;01:00,  3.36it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  38%|      | 125/328 [00:38&lt;01:02,  3.27it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  38%|      | 126/328 [00:38&lt;01:03,  3.17it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  39%|      | 127/328 [00:39&lt;00:59,  3.40it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  39%|      | 128/328 [00:39&lt;00:56,  3.55it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  39%|      | 129/328 [00:39&lt;01:06,  3.01it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  40%|      | 130/328 [00:40&lt;01:04,  3.07it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  40%|      | 131/328 [00:40&lt;01:04,  3.04it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  40%|      | 132/328 [00:40&lt;00:59,  3.31it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  41%|      | 133/328 [00:41&lt;01:00,  3.20it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  41%|      | 134/328 [00:41&lt;01:01,  3.13it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  41%|      | 135/328 [00:41&lt;01:00,  3.20it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  41%|     | 136/328 [00:42&lt;01:01,  3.12it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  42%|     | 137/328 [00:42&lt;01:02,  3.07it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  42%|     | 138/328 [00:42&lt;01:02,  3.03it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  42%|     | 139/328 [00:43&lt;01:02,  3.01it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  43%|     | 140/328 [00:43&lt;01:01,  3.06it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  43%|     | 141/328 [00:43&lt;00:59,  3.15it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  43%|     | 142/328 [00:43&lt;00:57,  3.23it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  44%|     | 143/328 [00:44&lt;00:58,  3.14it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  44%|     | 144/328 [00:44&lt;00:59,  3.08it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  44%|     | 145/328 [00:44&lt;00:56,  3.23it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  45%|     | 146/328 [00:45&lt;00:56,  3.22it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  45%|     | 147/328 [00:45&lt;00:57,  3.15it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  45%|     | 148/328 [00:45&lt;00:55,  3.26it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  45%|     | 149/328 [00:46&lt;00:53,  3.32it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  46%|     | 150/328 [00:46&lt;00:55,  3.21it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  46%|     | 151/328 [00:46&lt;00:59,  3.00it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  46%|     | 152/328 [00:47&lt;00:58,  2.99it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  47%|     | 153/328 [00:47&lt;00:54,  3.20it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  47%|     | 154/328 [00:47&lt;00:54,  3.18it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  47%|     | 155/328 [00:48&lt;00:55,  3.11it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  48%|     | 156/328 [00:48&lt;00:56,  3.06it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  48%|     | 157/328 [00:48&lt;00:56,  3.02it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  48%|     | 158/328 [00:49&lt;00:55,  3.08it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  48%|     | 159/328 [00:49&lt;00:53,  3.18it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  49%|     | 160/328 [00:49&lt;00:51,  3.28it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  49%|     | 161/328 [00:49&lt;00:49,  3.38it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  49%|     | 162/328 [00:50&lt;00:49,  3.36it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  50%|     | 163/328 [00:50&lt;00:47,  3.48it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  50%|     | 164/328 [00:50&lt;00:49,  3.30it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  50%|     | 165/328 [00:51&lt;00:50,  3.20it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  51%|     | 166/328 [00:51&lt;00:51,  3.13it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  51%|     | 167/328 [00:51&lt;00:51,  3.14it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  51%|     | 168/328 [00:52&lt;00:51,  3.11it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  52%|    | 169/328 [00:52&lt;00:52,  3.06it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  52%|    | 170/328 [00:52&lt;00:51,  3.04it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  52%|    | 171/328 [00:53&lt;00:51,  3.05it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  52%|    | 172/328 [00:53&lt;00:55,  2.79it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  53%|    | 173/328 [00:53&lt;00:51,  3.01it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  53%|    | 174/328 [00:54&lt;00:48,  3.16it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  53%|    | 175/328 [00:54&lt;00:49,  3.10it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  54%|    | 176/328 [00:54&lt;00:49,  3.05it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  54%|    | 177/328 [00:55&lt;00:49,  3.03it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  54%|    | 178/328 [00:55&lt;00:49,  3.02it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  55%|    | 179/328 [00:55&lt;00:49,  3.02it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  55%|    | 180/328 [00:56&lt;00:49,  3.01it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  55%|    | 181/328 [00:56&lt;00:46,  3.15it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  55%|    | 182/328 [00:56&lt;00:45,  3.20it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  56%|    | 183/328 [00:57&lt;00:46,  3.12it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  56%|    | 184/328 [00:57&lt;00:46,  3.07it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  56%|    | 185/328 [00:57&lt;00:46,  3.08it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  57%|    | 186/328 [00:58&lt;00:45,  3.11it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  57%|    | 187/328 [00:58&lt;00:46,  3.06it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  57%|    | 188/328 [00:58&lt;00:46,  3.03it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  58%|    | 189/328 [00:59&lt;00:44,  3.13it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  58%|    | 190/328 [00:59&lt;00:49,  2.79it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  58%|    | 191/328 [00:59&lt;00:48,  2.84it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  59%|    | 192/328 [01:00&lt;00:45,  2.96it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  59%|    | 193/328 [01:00&lt;00:44,  3.05it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  59%|    | 194/328 [01:00&lt;00:42,  3.13it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  59%|    | 195/328 [01:01&lt;00:43,  3.07it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  60%|    | 196/328 [01:01&lt;00:42,  3.12it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  60%|    | 197/328 [01:01&lt;00:41,  3.15it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  60%|    | 198/328 [01:02&lt;00:42,  3.09it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  61%|    | 199/328 [01:02&lt;00:41,  3.14it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  61%|    | 200/328 [01:02&lt;00:41,  3.10it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  61%|   | 201/328 [01:02&lt;00:41,  3.05it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  62%|   | 202/328 [01:03&lt;00:40,  3.11it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  62%|   | 203/328 [01:03&lt;00:40,  3.07it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  62%|   | 204/328 [01:03&lt;00:40,  3.03it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  62%|   | 205/328 [01:04&lt;00:40,  3.01it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  63%|   | 206/328 [01:04&lt;00:40,  3.00it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  63%|   | 207/328 [01:04&lt;00:40,  2.99it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  63%|   | 208/328 [01:05&lt;00:38,  3.08it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  64%|   | 209/328 [01:05&lt;00:39,  3.04it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  64%|   | 210/328 [01:06&lt;00:43,  2.74it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  64%|   | 211/328 [01:06&lt;00:41,  2.79it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  65%|   | 212/328 [01:06&lt;00:40,  2.90it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  65%|   | 213/328 [01:07&lt;00:39,  2.91it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  65%|   | 214/328 [01:07&lt;00:39,  2.87it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  66%|   | 215/328 [01:07&lt;00:39,  2.89it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  66%|   | 216/328 [01:08&lt;00:38,  2.91it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  66%|   | 217/328 [01:08&lt;00:37,  2.92it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  66%|   | 218/328 [01:08&lt;00:37,  2.97it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  67%|   | 219/328 [01:09&lt;00:36,  3.01it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  67%|   | 220/328 [01:09&lt;00:36,  2.99it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  67%|   | 221/328 [01:09&lt;00:35,  2.99it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  68%|   | 222/328 [01:10&lt;00:35,  3.02it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  68%|   | 223/328 [01:10&lt;00:34,  3.07it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  68%|   | 224/328 [01:10&lt;00:34,  3.03it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  69%|   | 225/328 [01:11&lt;00:34,  3.00it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  69%|   | 226/328 [01:11&lt;00:34,  2.99it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  69%|   | 227/328 [01:11&lt;00:33,  2.98it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  70%|   | 228/328 [01:12&lt;00:33,  2.97it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  70%|   | 229/328 [01:12&lt;00:32,  3.01it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  70%|   | 230/328 [01:12&lt;00:32,  2.99it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  70%|   | 231/328 [01:13&lt;00:32,  2.98it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  71%|   | 232/328 [01:13&lt;00:35,  2.72it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  71%|   | 233/328 [01:13&lt;00:33,  2.82it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  71%|  | 234/328 [01:14&lt;00:32,  2.86it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  72%|  | 235/328 [01:14&lt;00:32,  2.88it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  72%|  | 236/328 [01:14&lt;00:31,  2.90it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  72%|  | 237/328 [01:15&lt;00:31,  2.89it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  73%|  | 238/328 [01:15&lt;00:30,  2.92it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  73%|  | 239/328 [01:15&lt;00:30,  2.93it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  73%|  | 240/328 [01:16&lt;00:30,  2.92it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  73%|  | 241/328 [01:16&lt;00:29,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  74%|  | 242/328 [01:16&lt;00:29,  2.96it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  74%|  | 243/328 [01:17&lt;00:28,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  74%|  | 244/328 [01:17&lt;00:28,  2.97it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  75%|  | 245/328 [01:17&lt;00:27,  2.98it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  75%|  | 246/328 [01:18&lt;00:27,  2.96it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  75%|  | 247/328 [01:18&lt;00:27,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  76%|  | 248/328 [01:18&lt;00:27,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  76%|  | 249/328 [01:19&lt;00:26,  2.96it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  76%|  | 250/328 [01:19&lt;00:26,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  77%|  | 251/328 [01:19&lt;00:26,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  77%|  | 252/328 [01:20&lt;00:25,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  77%|  | 253/328 [01:20&lt;00:25,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  77%|  | 254/328 [01:21&lt;00:28,  2.58it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  78%|  | 255/328 [01:21&lt;00:27,  2.68it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  78%|  | 256/328 [01:21&lt;00:26,  2.76it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  78%|  | 257/328 [01:22&lt;00:25,  2.81it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  79%|  | 258/328 [01:22&lt;00:24,  2.85it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  79%|  | 259/328 [01:22&lt;00:23,  2.88it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  79%|  | 260/328 [01:23&lt;00:23,  2.90it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  80%|  | 261/328 [01:23&lt;00:23,  2.90it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  80%|  | 262/328 [01:23&lt;00:22,  2.92it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  80%|  | 263/328 [01:24&lt;00:22,  2.92it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  80%|  | 264/328 [01:24&lt;00:21,  2.93it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  81%|  | 265/328 [01:24&lt;00:23,  2.73it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  81%|  | 266/328 [01:25&lt;00:22,  2.77it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  81%| | 267/328 [01:25&lt;00:21,  2.81it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  82%| | 268/328 [01:26&lt;00:21,  2.83it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  82%| | 269/328 [01:26&lt;00:20,  2.86it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  82%| | 270/328 [01:26&lt;00:20,  2.89it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  83%| | 271/328 [01:27&lt;00:19,  2.91it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  83%| | 272/328 [01:27&lt;00:19,  2.91it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  83%| | 273/328 [01:27&lt;00:18,  2.91it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  84%| | 274/328 [01:28&lt;00:18,  2.93it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  84%| | 275/328 [01:28&lt;00:20,  2.63it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  84%| | 276/328 [01:28&lt;00:19,  2.72it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  84%| | 277/328 [01:29&lt;00:18,  2.77it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  85%| | 278/328 [01:29&lt;00:17,  2.83it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  85%| | 279/328 [01:29&lt;00:17,  2.87it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  85%| | 280/328 [01:30&lt;00:16,  2.89it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  86%| | 281/328 [01:30&lt;00:16,  2.92it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  86%| | 282/328 [01:30&lt;00:15,  2.93it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  86%| | 283/328 [01:31&lt;00:15,  2.93it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  87%| | 284/328 [01:31&lt;00:14,  2.94it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  87%| | 285/328 [01:31&lt;00:14,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  87%| | 286/328 [01:32&lt;00:14,  2.94it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  88%| | 287/328 [01:32&lt;00:14,  2.90it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  88%| | 288/328 [01:32&lt;00:13,  2.92it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  88%| | 289/328 [01:33&lt;00:13,  2.92it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  88%| | 290/328 [01:33&lt;00:12,  2.94it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  89%| | 291/328 [01:33&lt;00:12,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  89%| | 292/328 [01:34&lt;00:12,  2.93it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  89%| | 293/328 [01:34&lt;00:13,  2.68it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  90%| | 294/328 [01:35&lt;00:12,  2.75it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  90%| | 295/328 [01:35&lt;00:11,  2.80it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  90%| | 296/328 [01:35&lt;00:11,  2.85it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  91%| | 297/328 [01:36&lt;00:10,  2.88it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  91%| | 298/328 [01:36&lt;00:10,  2.89it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  91%| | 299/328 [01:36&lt;00:09,  2.91it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  91%|| 300/328 [01:37&lt;00:09,  2.92it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  92%|| 301/328 [01:37&lt;00:09,  2.92it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  92%|| 302/328 [01:37&lt;00:08,  2.94it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  92%|| 303/328 [01:38&lt;00:08,  2.94it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  93%|| 304/328 [01:38&lt;00:08,  2.94it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  93%|| 305/328 [01:38&lt;00:07,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  93%|| 306/328 [01:39&lt;00:07,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  94%|| 307/328 [01:39&lt;00:07,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  94%|| 308/328 [01:39&lt;00:06,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  94%|| 309/328 [01:40&lt;00:06,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  95%|| 310/328 [01:40&lt;00:06,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  95%|| 311/328 [01:40&lt;00:05,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  95%|| 312/328 [01:41&lt;00:05,  2.96it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  95%|| 313/328 [01:41&lt;00:05,  2.68it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  96%|| 314/328 [01:41&lt;00:05,  2.76it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  96%|| 315/328 [01:42&lt;00:04,  2.81it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  96%|| 316/328 [01:42&lt;00:04,  2.85it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  97%|| 317/328 [01:43&lt;00:03,  2.88it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  97%|| 318/328 [01:43&lt;00:03,  2.89it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  97%|| 319/328 [01:43&lt;00:03,  2.81it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  98%|| 320/328 [01:44&lt;00:02,  2.86it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  98%|| 321/328 [01:44&lt;00:02,  2.89it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  98%|| 322/328 [01:44&lt;00:02,  2.91it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  98%|| 323/328 [01:45&lt;00:01,  2.93it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  99%|| 324/328 [01:45&lt;00:01,  2.93it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  99%|| 325/328 [01:45&lt;00:01,  2.94it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders:  99%|| 326/328 [01:46&lt;00:00,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders: 100%|| 327/328 [01:46&lt;00:00,  2.95it/s]/tmp/ipykernel_1880/779803477.py:64: FutureWarning:

Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`

Matching cardholders: 100%|| 328/328 [01:46&lt;00:00,  2.95it/s]Matching cardholders: 100%|| 328/328 [01:46&lt;00:00,  3.07it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Percentage of clients with card issued: 8.33%
Percentage of clients with card issued after matching: 16.67%</code></pre>
</div>
</div>
<p>After each non-cardholder got the artifical card issued date assigned we drop the remaining non-cardholders without a match.</p>
<div id="fcddfe72" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>before_len <span class="op">=</span> <span class="bu">len</span>(matched_non_card_holders_w_issue_date_df)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="op">-</span>(before_len <span class="op">-</span> <span class="bu">len</span>(matched_non_card_holders_w_issue_date_df)))</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>matched_non_card_holders_w_issue_date_df <span class="op">=</span> matched_non_card_holders_w_issue_date_df.dropna(subset<span class="op">=</span>[<span class="st">'card_issued'</span>])</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>data_reduction[<span class="st">"Non-cardholders without match"</span>] <span class="op">=</span> <span class="op">-</span>(before_len <span class="op">-</span> <span class="bu">len</span>(matched_non_card_holders_w_issue_date_df))</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> before_len</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0</code></pre>
</div>
</div>
</section>
</section>
<section id="aggregate-transactions-on-a-monthly-basis" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-transactions-on-a-monthly-basis">Aggregate Transactions on a Monthly Basis</h2>
<p>Validating first transactions where the amount equals the balance is essential for the integrity of our aggregated data analysis. This specific assertion underpins the reliability of our subsequent aggregation operations by ensuring each accounts financial history starts from a verifiable point.</p>
<div id="25da7910" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>zero_amount_transactions_df <span class="op">=</span> transactions_df[transactions_df[<span class="st">'amount'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>zero_amount_transactions_info <span class="op">=</span> {</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'total_zero_amount_transactions'</span>: <span class="bu">len</span>(zero_amount_transactions_df),</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'unique_accounts_with_zero_amount'</span>: zero_amount_transactions_df[<span class="st">'account_id'</span>].nunique(),</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'transaction_type_distribution'</span>: zero_amount_transactions_df[<span class="st">'transaction_type'</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'operation_distribution'</span>: zero_amount_transactions_df[<span class="st">'operation'</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'k_symbol_distribution'</span>: zero_amount_transactions_df[<span class="st">'k_symbol'</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>zero_amount_transactions_info, <span class="bu">len</span>(zero_amount_transactions_info)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>({'total_zero_amount_transactions': 14,
  'unique_accounts_with_zero_amount': 12,
  'transaction_type_distribution': transaction_type
  Withdrawal    0.714286
  Credit        0.285714
  Name: proportion, dtype: float64,
  'operation_distribution': operation
  Withdrawal in Cash    0.714286
  NA                    0.285714
  Name: proportion, dtype: float64,
  'k_symbol_distribution': k_symbol
  Sanction Interest    0.714286
  Interest Credited    0.285714
  Name: proportion, dtype: float64},
 5)</code></pre>
</div>
</div>
<div id="83546f54" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>accounts_with_zero_amount_transactions <span class="op">=</span> accounts_df[accounts_df[<span class="st">'account_id'</span>].isin(zero_amount_transactions_df[<span class="st">'account_id'</span>].unique())]</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>accounts_with_zero_amount_transactions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">district_id</th>
<th data-quarto-table-cell-role="th">account_frequency</th>
<th data-quarto-table-cell-role="th">account_created</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">178</td>
<td>5369</td>
<td>54</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-02-25</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">289</td>
<td>5483</td>
<td>13</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-03-28</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">496</td>
<td>5129</td>
<td>68</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-06-08</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">513</td>
<td>1475</td>
<td>1</td>
<td>WEEKLY_ISSUANCE</td>
<td>1993-06-14</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">799</td>
<td>9337</td>
<td>30</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-09-13</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">896</td>
<td>102</td>
<td>11</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-10-16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">986</td>
<td>8957</td>
<td>1</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-11-13</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2033</td>
<td>5125</td>
<td>1</td>
<td>MONTHLY_ISSUANCE</td>
<td>1995-09-14</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2300</td>
<td>9051</td>
<td>5</td>
<td>WEEKLY_ISSUANCE</td>
<td>1996-01-17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2651</td>
<td>3859</td>
<td>53</td>
<td>MONTHLY_ISSUANCE</td>
<td>1996-04-23</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3212</td>
<td>6083</td>
<td>6</td>
<td>WEEKLY_ISSUANCE</td>
<td>1996-09-19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3342</td>
<td>1330</td>
<td>68</td>
<td>MONTHLY_ISSUANCE</td>
<td>1996-10-22</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="7d98a70a" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> accounts_with_zero_amount_transactions </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> zero_amount_transactions_df</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> zero_amount_transactions_info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f1863f34" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_first_transactions(transactions):</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Validates that for each account in the transactions DataFrame, there is at least</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="co">    one transaction where the amount equals the balance on the account's first transaction date.</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - transactions (pd.DataFrame): DataFrame containing transaction data with columns</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="co">      'account_id', 'date', 'amount', and 'balance'.</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - AssertionError: If not every account has a first transaction where the amount equals the balance.</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    first_dates <span class="op">=</span> transactions.groupby(<span class="st">'account_id'</span>)[<span class="st">'date'</span>].<span class="bu">min</span>().reset_index(name<span class="op">=</span><span class="st">'first_date'</span>)</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>    first_trans <span class="op">=</span> pd.merge(transactions, first_dates, how<span class="op">=</span><span class="st">'left'</span>, on<span class="op">=</span>[<span class="st">'account_id'</span>])</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>    first_trans_filtered <span class="op">=</span> first_trans[(first_trans[<span class="st">'date'</span>] <span class="op">==</span> first_trans[<span class="st">'first_date'</span>]) <span class="op">&amp;</span> (first_trans[<span class="st">'amount'</span>] <span class="op">==</span> first_trans[<span class="st">'balance'</span>])]</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>    first_trans_filtered <span class="op">=</span> first_trans_filtered.drop_duplicates(subset<span class="op">=</span>[<span class="st">'account_id'</span>])</span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>    unique_accounts <span class="op">=</span> transactions[<span class="st">'account_id'</span>].nunique()</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> unique_accounts <span class="op">==</span> first_trans_filtered[<span class="st">'account_id'</span>].nunique(), <span class="st">"Not every account has a first transaction where the amount equals the balance."</span></span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"Validation successful: Each account has a first transaction where the amount equals the balance."</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>validate_first_transactions(transactions_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>'Validation successful: Each account has a first transaction where the amount equals the balance.'</code></pre>
</div>
</div>
<p>We can confirm the truth of the assertions made. It is certain that there is a transaction with an amount equal to the balance in the transaction history of any account on the first date.</p>
<p>The function <code>aggregate_transactions_monthly</code> is designed to process and summarize financial transactions on a monthly basis for each account within a dataset. The explanation of its workings, step by step, is as follows:</p>
<ol type="1">
<li><p><strong>Sorting Transactions</strong>: Initially, the function sorts the transactions in the provided DataFrame <code>transactions_df</code> based on <code>account_id</code> and the transaction <code>date</code>. This ensures that all transactions for a given account are ordered chronologically, which is crucial for accurate monthly aggregation and cumulative balance calculation.</p></li>
<li><p><strong>Monthly Grouping</strong>: Each transactions date is then converted to a monthly period using <code>dt.to_period("M")</code>. This step categorizes each transaction by the month and year it occurred, facilitating the aggregation of transactions on a monthly basis.</p></li>
<li><p><strong>Aggregation of Monthly Data</strong>: The function groups the sorted transactions by <code>account_id</code> and the newly created <code>month</code> column. For each group, it calculates several metrics:</p>
<ul>
<li><code>volume</code>: The sum of all transactions amounts for the month, representing the total money flow.</li>
<li><code>total_abs_amount</code>: The sum of the absolute values of the transactions amounts, indicating the total amount of money moved, disregarding the direction.</li>
<li><code>transaction_count</code>: The count of transactions, providing a sense of activity level.</li>
<li><code>positive_transaction_count</code> and <code>negative_transaction_count</code>: The counts of positive (inflows) and negative (outflows) transactions, respectively. This distinction can help identify the balance between income and expenses.</li>
<li>Statistical measures like <code>average_amount</code>, <code>median_amount</code>, <code>min_amount</code>, <code>max_amount</code>, and <code>std_amount</code> offer insights into the distribution of transaction amounts.</li>
<li><code>type_count</code>, <code>operation_count</code>, and <code>k_symbol_count</code>: The counts of unique transaction types, operations, and transaction symbols (k_symbol), respectively, indicating the diversity of transaction characteristics.</li>
</ul></li>
<li><p><strong>Cumulative Balance Calculation</strong>: After aggregating the monthly data, the function computes a cumulative balance (<code>balance</code>) for each account by cumulatively summing the <code>volume</code> (total transaction amount) over time. This step provides insight into how the account balance evolves over the months.</p></li>
<li><p><strong>Validation of Aggregated Data</strong>: The <code>validate_monthly_aggregated_transactions</code> function is invoked to ensure the integrity and correctness of the aggregated data through several assertions:</p>
<ul>
<li>The balance should consistently increase or decrease based on whether the total monthly transaction volume is positive or negative, respectively.</li>
<li>For each account, the balance in the first month should equal the total transaction volume of that month.</li>
<li>The sum of positive and negative transaction counts must equal the total transaction count for each month.</li>
<li>The number of unique accounts in the aggregated data should match that in the original dataset.</li>
<li>The final balances of accounts in the aggregated data should closely match their last recorded transactions in the original dataset.</li>
</ul></li>
</ol>
<div id="23c4414d" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> aggregate_transactions_monthly(df):</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Aggregate financial transaction data on a monthly basis per account.</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="co">    - df (pd.DataFrame): DataFrame containing financial transaction data with 'account_id', 'date', and other relevant columns.</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - pd.DataFrame: Monthly aggregated financial transaction data per account.</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>    df_sorted <span class="op">=</span> df.sort_values(by<span class="op">=</span>[<span class="st">"account_id"</span>, <span class="st">"date"</span>])</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>    df_sorted[<span class="st">"month"</span>] <span class="op">=</span> df_sorted[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>)</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>    monthly_aggregated_data <span class="op">=</span> (</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>            df_sorted.groupby([<span class="st">"account_id"</span>, <span class="st">"month"</span>])</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>            .agg(</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>                volume<span class="op">=</span>(<span class="st">"amount"</span>, <span class="st">"sum"</span>),</span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>                total_abs_amount<span class="op">=</span>(<span class="st">"amount"</span>, <span class="kw">lambda</span> x: x.<span class="bu">abs</span>().<span class="bu">sum</span>()),</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>                transaction_count<span class="op">=</span>(<span class="st">"amount"</span>, <span class="st">"count"</span>),</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>                positive_transaction_count<span class="op">=</span>(<span class="st">"amount"</span>, <span class="kw">lambda</span> x: (x <span class="op">&gt;=</span> <span class="dv">0</span>).<span class="bu">sum</span>()), <span class="co"># </span><span class="al">TODO</span><span class="co">: it seems that there are some transactions with 0 amount, how to handle those?</span></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>                negative_transaction_count<span class="op">=</span>(<span class="st">"amount"</span>, <span class="kw">lambda</span> x: (x <span class="op">&lt;</span> <span class="dv">0</span>).<span class="bu">sum</span>()),</span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>                average_amount<span class="op">=</span>(<span class="st">"amount"</span>, <span class="st">"mean"</span>),</span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>                median_amount<span class="op">=</span>(<span class="st">"amount"</span>, <span class="st">"median"</span>),</span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>                min_amount<span class="op">=</span>(<span class="st">"amount"</span>, <span class="st">"min"</span>),</span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>                max_amount<span class="op">=</span>(<span class="st">"amount"</span>, <span class="st">"max"</span>),</span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>                std_amount<span class="op">=</span>(<span class="st">"amount"</span>, <span class="st">"std"</span>),</span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>                type_count<span class="op">=</span>(<span class="st">"transaction_type"</span>, <span class="st">"nunique"</span>),</span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>                operation_count<span class="op">=</span>(<span class="st">"operation"</span>, <span class="st">"nunique"</span>),</span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>                k_symbol_count<span class="op">=</span>(<span class="st">"k_symbol"</span>, <span class="st">"nunique"</span>),</span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>            .reset_index()</span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>            .sort_values(by<span class="op">=</span>[<span class="st">"account_id"</span>, <span class="st">"month"</span>])</span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a>    monthly_aggregated_data[<span class="st">"balance"</span>] <span class="op">=</span> monthly_aggregated_data.groupby(<span class="st">"account_id"</span>)[<span class="st">"volume"</span>].cumsum()</span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a>    validate_monthly_aggregated_transactions(monthly_aggregated_data, df)</span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly_aggregated_data</span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_monthly_aggregated_transactions(aggregated_data, original_df):</span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb95-43"><a href="#cb95-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Validate the integrity and correctness of aggregated monthly financial transactions.</span></span>
<span id="cb95-44"><a href="#cb95-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-45"><a href="#cb95-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb95-46"><a href="#cb95-46" aria-hidden="true" tabindex="-1"></a><span class="co">    - aggregated_data (pd.DataFrame): Aggregated monthly transaction data.</span></span>
<span id="cb95-47"><a href="#cb95-47" aria-hidden="true" tabindex="-1"></a><span class="co">    - original_df (pd.DataFrame): Original dataset of financial transactions.</span></span>
<span id="cb95-48"><a href="#cb95-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-49"><a href="#cb95-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb95-50"><a href="#cb95-50" aria-hidden="true" tabindex="-1"></a><span class="co">    - AssertionError: If validation conditions are not met.</span></span>
<span id="cb95-51"><a href="#cb95-51" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb95-52"><a href="#cb95-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-53"><a href="#cb95-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> (aggregated_data[<span class="st">"volume"</span>] <span class="op">&gt;=</span> <span class="dv">0</span>).<span class="bu">all</span>() <span class="op">==</span> (</span>
<span id="cb95-54"><a href="#cb95-54" aria-hidden="true" tabindex="-1"></a>        aggregated_data[<span class="st">"balance"</span>].diff() <span class="op">&gt;=</span> <span class="dv">0</span></span>
<span id="cb95-55"><a href="#cb95-55" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">all</span>(), <span class="st">"If the total amount is positive, the balance should go up."</span></span>
<span id="cb95-56"><a href="#cb95-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-57"><a href="#cb95-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> (aggregated_data[<span class="st">"volume"</span>] <span class="op">&lt;</span> <span class="dv">0</span>).<span class="bu">all</span>() <span class="op">==</span> (</span>
<span id="cb95-58"><a href="#cb95-58" aria-hidden="true" tabindex="-1"></a>        aggregated_data[<span class="st">"balance"</span>].diff() <span class="op">&lt;</span> <span class="dv">0</span></span>
<span id="cb95-59"><a href="#cb95-59" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">all</span>(), <span class="st">"If the total amount is negative, the balance should go down."</span></span>
<span id="cb95-60"><a href="#cb95-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-61"><a href="#cb95-61" aria-hidden="true" tabindex="-1"></a>    first_month <span class="op">=</span> aggregated_data.groupby(<span class="st">"account_id"</span>).nth(<span class="dv">0</span>)</span>
<span id="cb95-62"><a href="#cb95-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> (</span>
<span id="cb95-63"><a href="#cb95-63" aria-hidden="true" tabindex="-1"></a>        first_month[<span class="st">"volume"</span>] <span class="op">==</span> first_month[<span class="st">"balance"</span>]</span>
<span id="cb95-64"><a href="#cb95-64" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">all</span>(), <span class="st">"The balance should equal the volume for the first month."</span></span>
<span id="cb95-65"><a href="#cb95-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-66"><a href="#cb95-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> (</span>
<span id="cb95-67"><a href="#cb95-67" aria-hidden="true" tabindex="-1"></a>        aggregated_data[<span class="st">"positive_transaction_count"</span>]</span>
<span id="cb95-68"><a href="#cb95-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> aggregated_data[<span class="st">"negative_transaction_count"</span>]</span>
<span id="cb95-69"><a href="#cb95-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">==</span> aggregated_data[<span class="st">"transaction_count"</span>]</span>
<span id="cb95-70"><a href="#cb95-70" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">all</span>(), <span class="st">"The sum of positive and negative transaction counts should equal the total transaction count."</span></span>
<span id="cb95-71"><a href="#cb95-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-72"><a href="#cb95-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> (</span>
<span id="cb95-73"><a href="#cb95-73" aria-hidden="true" tabindex="-1"></a>        aggregated_data[<span class="st">"account_id"</span>].nunique() <span class="op">==</span> original_df[<span class="st">"account_id"</span>].nunique()</span>
<span id="cb95-74"><a href="#cb95-74" aria-hidden="true" tabindex="-1"></a>    ), <span class="st">"The number of unique account_ids in the aggregated DataFrame should be the same as the original DataFrame."</span></span>
<span id="cb95-75"><a href="#cb95-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-76"><a href="#cb95-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> (</span>
<span id="cb95-77"><a href="#cb95-77" aria-hidden="true" tabindex="-1"></a>        pd.merge(</span>
<span id="cb95-78"><a href="#cb95-78" aria-hidden="true" tabindex="-1"></a>            aggregated_data.groupby(<span class="st">"account_id"</span>)</span>
<span id="cb95-79"><a href="#cb95-79" aria-hidden="true" tabindex="-1"></a>            .last()</span>
<span id="cb95-80"><a href="#cb95-80" aria-hidden="true" tabindex="-1"></a>            .reset_index()[[<span class="st">"account_id"</span>, <span class="st">"balance"</span>]],</span>
<span id="cb95-81"><a href="#cb95-81" aria-hidden="true" tabindex="-1"></a>            original_df[original_df.groupby(<span class="st">"account_id"</span>)[<span class="st">"date"</span>].transform(<span class="st">"max"</span>) <span class="op">==</span> original_df[<span class="st">"date"</span>]][</span>
<span id="cb95-82"><a href="#cb95-82" aria-hidden="true" tabindex="-1"></a>                [<span class="st">"account_id"</span>, <span class="st">"balance"</span>]</span>
<span id="cb95-83"><a href="#cb95-83" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb95-84"><a href="#cb95-84" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">"account_id"</span>,</span>
<span id="cb95-85"><a href="#cb95-85" aria-hidden="true" tabindex="-1"></a>            suffixes<span class="op">=</span>(<span class="st">"_final"</span>, <span class="st">"_last"</span>),</span>
<span id="cb95-86"><a href="#cb95-86" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb95-87"><a href="#cb95-87" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(</span>
<span id="cb95-88"><a href="#cb95-88" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: np.isclose(x[<span class="st">"balance_final"</span>], x[<span class="st">"balance_last"</span>], atol<span class="op">=</span><span class="dv">5</span>), axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb95-89"><a href="#cb95-89" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb95-90"><a href="#cb95-90" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">any</span>()</span>
<span id="cb95-91"><a href="#cb95-91" aria-hidden="true" tabindex="-1"></a>    ), <span class="st">"Some accounts' final balances do not match their last transactions."</span></span>
<span id="cb95-92"><a href="#cb95-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-93"><a href="#cb95-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-94"><a href="#cb95-94" aria-hidden="true" tabindex="-1"></a>agg_transactions_monthly_df <span class="op">=</span> aggregate_transactions_monthly(transactions_df)</span>
<span id="cb95-95"><a href="#cb95-95" aria-hidden="true" tabindex="-1"></a>validate_monthly_aggregated_transactions(agg_transactions_monthly_df, transactions_df)</span>
<span id="cb95-96"><a href="#cb95-96" aria-hidden="true" tabindex="-1"></a>agg_transactions_monthly_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">total_abs_amount</th>
<th data-quarto-table-cell-role="th">transaction_count</th>
<th data-quarto-table-cell-role="th">positive_transaction_count</th>
<th data-quarto-table-cell-role="th">negative_transaction_count</th>
<th data-quarto-table-cell-role="th">average_amount</th>
<th data-quarto-table-cell-role="th">median_amount</th>
<th data-quarto-table-cell-role="th">min_amount</th>
<th data-quarto-table-cell-role="th">max_amount</th>
<th data-quarto-table-cell-role="th">std_amount</th>
<th data-quarto-table-cell-role="th">type_count</th>
<th data-quarto-table-cell-role="th">operation_count</th>
<th data-quarto-table-cell-role="th">k_symbol_count</th>
<th data-quarto-table-cell-role="th">balance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>176803.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
<td>185057.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2799.983292</td>
<td>1065.354397</td>
<td>33815.492309</td>
<td>5.708079</td>
<td>2.189017</td>
<td>3.519062</td>
<td>451.659265</td>
<td>-372.421445</td>
<td>-9607.378249</td>
<td>14756.009580</td>
<td>9030.305445</td>
<td>1.921181</td>
<td>3.568965</td>
<td>3.719649</td>
<td>34474.787632</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>2331.861909</td>
<td>12509.136299</td>
<td>37724.985550</td>
<td>2.417842</td>
<td>0.726115</td>
<td>2.173427</td>
<td>2479.100575</td>
<td>1933.445907</td>
<td>10746.883348</td>
<td>12958.692736</td>
<td>7402.806514</td>
<td>0.269457</td>
<td>0.832363</td>
<td>1.085701</td>
<td>19799.443508</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>-101550.300000</td>
<td>14.600000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>-37000.000000</td>
<td>-37000.000000</td>
<td>-87400.000000</td>
<td>-37000.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>1.000000</td>
<td>-41125.800000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>1172.000000</td>
<td>-2266.600000</td>
<td>9659.500000</td>
<td>4.000000</td>
<td>2.000000</td>
<td>2.000000</td>
<td>-379.566667</td>
<td>-785.000000</td>
<td>-13428.000000</td>
<td>4756.000000</td>
<td>3283.937059</td>
<td>2.000000</td>
<td>3.000000</td>
<td>3.000000</td>
<td>20405.600000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2375.000000</td>
<td>1058.100000</td>
<td>22933.100000</td>
<td>5.000000</td>
<td>2.000000</td>
<td>3.000000</td>
<td>220.260000</td>
<td>-14.600000</td>
<td>-6177.000000</td>
<td>10929.000000</td>
<td>6824.369949</td>
<td>2.000000</td>
<td>4.000000</td>
<td>4.000000</td>
<td>30000.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>3576.000000</td>
<td>4132.200000</td>
<td>43668.000000</td>
<td>7.000000</td>
<td>2.000000</td>
<td>5.000000</td>
<td>878.680000</td>
<td>44.700000</td>
<td>-2672.000000</td>
<td>21553.000000</td>
<td>12622.945077</td>
<td>2.000000</td>
<td>4.000000</td>
<td>4.000000</td>
<td>44540.500000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>11382.000000</td>
<td>115038.200000</td>
<td>609736.200000</td>
<td>23.000000</td>
<td>9.000000</td>
<td>16.000000</td>
<td>44708.000000</td>
<td>44708.000000</td>
<td>44708.000000</td>
<td>74812.000000</td>
<td>57782.701468</td>
<td>2.000000</td>
<td>6.000000</td>
<td>7.000000</td>
<td>138317.800000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<section id="monthly-balance-difference-and-volume" class="level3">
<h3 class="anchored" data-anchor-id="monthly-balance-difference-and-volume">Monthly Balance Difference and Volume</h3>
<p>This plot gives a clear picture of how money moves in and out of an account each month and how these movements affect the overall balance. It does this by showing two things:</p>
<ul>
<li><strong>Balance Difference</strong>: This line shows whether the account balance went up or down each month. If the line goes up, it means the account gained money that month. If it goes down, the account lost money.</li>
<li><strong>Volume</strong>: This line shows the total amount of money that moved in the account each month, regardless of whether it was coming in or going out.</li>
</ul>
<p><strong>What to Look For</strong>: - A direct link between the amount of money moved (volume) and changes in the account balance. High incoming money should lead to an uptick in the balance, and lots of outgoing money should lead to a downturn. - This visual check helps to understand how active the account is and whether its generally getting fuller or emptier over time.</p>
<div id="c97c67cc" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_monthly_balance_diff_and_volume(transactions_monthly, account_id, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>)):</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    account_transactions <span class="op">=</span> transactions_monthly[transactions_monthly[<span class="st">'account_id'</span>] <span class="op">==</span> account_id].sort_values(by<span class="op">=</span><span class="st">'month'</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    account_transactions[<span class="st">'balance_diff'</span>] <span class="op">=</span> account_transactions[<span class="st">'balance'</span>].diff()</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>figsize)</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>    plt.plot(account_transactions[<span class="st">'month'</span>].astype(<span class="bu">str</span>), account_transactions[<span class="st">'balance_diff'</span>], marker<span class="op">=</span><span class="st">'o'</span>, label<span class="op">=</span><span class="st">'Balance Difference'</span>)</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    plt.plot(account_transactions[<span class="st">'month'</span>].astype(<span class="bu">str</span>), account_transactions[<span class="st">'volume'</span>], marker<span class="op">=</span><span class="st">'x'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="st">'Volume'</span>)</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Monthly Balance Difference and Volume for Account </span><span class="sc">{</span>account_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Month'</span>)</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Value'</span>)</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>    plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>plot_monthly_balance_diff_and_volume(agg_transactions_monthly_df, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-75-output-1.png" width="1137" height="753" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="monthly-transactions-balance-and-volume-plot-explanation" class="level3">
<h3 class="anchored" data-anchor-id="monthly-transactions-balance-and-volume-plot-explanation">Monthly Transactions, Balance, and Volume Plot Explanation</h3>
<p>This visualization offers a snapshot of an accounts activity over time by comparing money movement each month with the overall account balance. It helps to understand:</p>
<ul>
<li><strong>Volume</strong>: How much money came in or went out of the account each month. Incoming money is shown as up, and outgoing money as down.</li>
<li><strong>Balance</strong>: The total money in the account at the end of each month, showing how its changed over time due to the monthly transactions.</li>
</ul>
<p><strong>What to Look For</strong>: - How the monthly money movement impacts the accounts growing or shrinking balance. For example, a few months of high income should visibly increase the balance. - This simple visual guide helps spot trends, like if the account is steadily growing, holding steady, or facing issues, giving quick insights into financial well-being and further validates the aggregation made in the previous step.</p>
<div id="5cf7ef6c" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_monthly_transactions_balance_and_volume(agg_transactions_monthly, account_id):</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>    account_transactions <span class="op">=</span> agg_transactions_monthly[agg_transactions_monthly[<span class="st">'account_id'</span>] <span class="op">==</span> account_id]</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>    plt.plot(account_transactions[<span class="st">'month'</span>].astype(<span class="bu">str</span>), account_transactions[<span class="st">'volume'</span>], marker<span class="op">=</span><span class="st">'o'</span>, label<span class="op">=</span><span class="st">'Volume'</span>)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>    plt.plot(account_transactions[<span class="st">'month'</span>].astype(<span class="bu">str</span>), account_transactions[<span class="st">'balance'</span>], marker<span class="op">=</span><span class="st">'x'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="st">'Balance'</span>)</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Monthly Transactions and Balance for Account </span><span class="sc">{</span>account_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Month'</span>)</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Value'</span>)</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>    plt.xticks(rotation<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>plot_monthly_transactions_balance_and_volume(agg_transactions_monthly_df, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-76-output-1.png" width="1425" height="945" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="delieverable-closer-look-at-account-14-and-18" class="level3">
<h3 class="anchored" data-anchor-id="delieverable-closer-look-at-account-14-and-18">Delieverable: Closer Look at account 14 and 18</h3>
<section id="account-14" class="level4">
<h4 class="anchored" data-anchor-id="account-14">Account 14</h4>
<div id="afb6534c" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>plot_monthly_transactions_balance_and_volume(agg_transactions_monthly_df, <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-77-output-1.png" width="1425" height="945" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Account 14 shows a rather conservative transaction history. The spending habits are all withing range of 10k to -10k per month. We can see little volatility, the account shows a slight trend of growing.</p>
</section>
<section id="account-18" class="level4">
<h4 class="anchored" data-anchor-id="account-18">Account 18</h4>
<div id="70cab1c8" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>plot_monthly_transactions_balance_and_volume(agg_transactions_monthly_df, <span class="dv">18</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-78-output-1.png" width="1425" height="945" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Account 18 paints a different picture in comparison to account 14.</p>
<p>The volatility here is a lot higher, indiciating a potential for a business account or high income household. Especially March 1994 to December 1994 show some volatile transaction habits.</p>
<section id="analysis" class="level5">
<h5 class="anchored" data-anchor-id="analysis">Analysis</h5>
<p>Looking at the balance and volume per month for the accounts 14 and 18 we can notice some interesting patterns.</p>
<section id="account-14-1" class="level6">
<h6 class="anchored" data-anchor-id="account-14-1">Account 14:</h6>
</section>
</section>
</section>
</section>
</section>
<section id="rolling-window-aggregations-for-card-holders" class="level2">
<h2 class="anchored" data-anchor-id="rolling-window-aggregations-for-card-holders">Rolling Window Aggregations for Card Holders</h2>
<p>We condense transaction data into a monthly aggregated format. This aggregation serves a multifaceted purpose:</p>
<ul>
<li>Monthly aggregation standardizes the time frame across which we analyze transactions, allowing us to compare transactional behaviors consistently across all accounts.</li>
<li>Aggregating data on a monthly level illuminates patterns that daily data might obscure. It enables us to discern trends over a broader time scale, capturing cyclical behaviors, seasonal effects, and response to macroeconomic events.</li>
<li>Daily transaction data can be noisy with random fluctuations. By considering monthly totals and averages, we reduce this noise, revealing underlying trends more clearly.</li>
<li>Our primary objective is to understand behaviors leading up to the issuance of a card. Aggregating transactions on a monthly basis helps focus on the crucial period preceding card issuance, enabling us to correlate transactional behaviors with the propensity to become a cardholder.</li>
</ul>
<div id="99ba3be5" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pivot_transactions(non_transactional, transactions_monthly, months_before_card_range<span class="op">=</span>(<span class="dv">2</span>, <span class="dv">13</span>)):</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Aggregate monthly transaction data and merge it with non-transactional account data, </span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="co">    focusing on the time frame leading up to the card issuance.</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="co">    This function merges monthly transaction data with non-transactional data to associate each</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="co">    transaction with the respective account and card issued date. It then filters transactions based</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="co">    on a specified range of months before card issuance and aggregates various transaction metrics.</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - non_transactional (pd.DataFrame): A DataFrame containing non-transactional account data.</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - transactions_monthly (pd.DataFrame): A DataFrame containing monthly transaction data.</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - months_before_card_range (tuple): A tuple specifying the inclusive range of months before card </span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a><span class="co">                                        issuance to filter the transactions for aggregation.</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a><span class="co">    The aggregation includes the sum of volume and transaction counts, as well as the mean and other</span></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a><span class="co">    statistical measures of transaction amounts, for each account within the specified months before </span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a><span class="co">    card issuance.</span></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a><span class="co">    The resulting DataFrame is pivoted to have 'account_id' as rows and the months before card </span></span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a><span class="co">    issuance as columns, with aggregated metrics as values. Column names are constructed to </span></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a><span class="co">    describe the month and the metric represented.</span></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a><span class="co">    - pd.DataFrame: The final aggregated and pivoted dataset ready for analysis, with each row </span></span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a><span class="co">                    representing an account and each column a specific metric in the months before </span></span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a><span class="co">                    card issuance.</span></span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>    merged_df <span class="op">=</span> transactions_monthly.merge(non_transactional[[<span class="st">'account_id'</span>]], on<span class="op">=</span><span class="st">'account_id'</span>)</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>    merged_df[<span class="st">'card_issued_date'</span>] <span class="op">=</span> merged_df[<span class="st">'account_id'</span>].<span class="bu">map</span>(non_transactional.set_index(<span class="st">'account_id'</span>)[<span class="st">'card_issued'</span>])</span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a>    merged_df[<span class="st">'months_before_card'</span>] <span class="op">=</span> merged_df.<span class="bu">apply</span>(<span class="kw">lambda</span> row: (row[<span class="st">'card_issued_date'</span>].to_period(<span class="st">'M'</span>) <span class="op">-</span> row[<span class="st">'month'</span>]).n, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>    start_month, end_month <span class="op">=</span> months_before_card_range</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a>    filtered_df <span class="op">=</span> merged_df.query(<span class="ss">f"</span><span class="sc">{</span>start_month<span class="sc">}</span><span class="ss"> &lt;= months_before_card &lt;= </span><span class="sc">{</span>end_month<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a>    aggregated_data <span class="op">=</span> filtered_df.groupby([<span class="st">'account_id'</span>, <span class="st">'months_before_card'</span>]).agg({</span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">'volume'</span>: <span class="st">'sum'</span>,</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_abs_amount'</span>: <span class="st">'sum'</span>,</span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'transaction_count'</span>: <span class="st">'sum'</span>,</span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'positive_transaction_count'</span>: <span class="st">'sum'</span>,</span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'negative_transaction_count'</span>: <span class="st">'sum'</span>,</span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'average_amount'</span>: <span class="st">'mean'</span>,</span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'median_amount'</span>: <span class="st">'median'</span>,</span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">'min_amount'</span>: <span class="st">'min'</span>,</span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">'max_amount'</span>: <span class="st">'max'</span>,</span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'std_amount'</span>: <span class="st">'std'</span>,</span>
<span id="cb100-48"><a href="#cb100-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'type_count'</span>: <span class="st">'sum'</span>,</span>
<span id="cb100-49"><a href="#cb100-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'operation_count'</span>: <span class="st">'sum'</span>,</span>
<span id="cb100-50"><a href="#cb100-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'k_symbol_count'</span>: <span class="st">'sum'</span>,</span>
<span id="cb100-51"><a href="#cb100-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">'balance'</span>: <span class="st">'mean'</span></span>
<span id="cb100-52"><a href="#cb100-52" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb100-53"><a href="#cb100-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-54"><a href="#cb100-54" aria-hidden="true" tabindex="-1"></a>    pivoted_data <span class="op">=</span> aggregated_data.pivot(index<span class="op">=</span><span class="st">'account_id'</span>, columns<span class="op">=</span><span class="st">'months_before_card'</span>)</span>
<span id="cb100-55"><a href="#cb100-55" aria-hidden="true" tabindex="-1"></a>    pivoted_data.columns <span class="op">=</span> [<span class="st">'_'</span>.join([<span class="st">'M'</span>, <span class="bu">str</span>(col[<span class="dv">1</span>]), col[<span class="dv">0</span>]]) <span class="cf">for</span> col <span class="kw">in</span> pivoted_data.columns.values]</span>
<span id="cb100-56"><a href="#cb100-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-57"><a href="#cb100-57" aria-hidden="true" tabindex="-1"></a>    final_dataset <span class="op">=</span> pivoted_data.reset_index()</span>
<span id="cb100-58"><a href="#cb100-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_dataset</span>
<span id="cb100-59"><a href="#cb100-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-60"><a href="#cb100-60" aria-hidden="true" tabindex="-1"></a>transactions_pivoted_df <span class="op">=</span> pivot_transactions(matched_non_card_holders_w_issue_date_df, agg_transactions_monthly_df)</span>
<span id="cb100-61"><a href="#cb100-61" aria-hidden="true" tabindex="-1"></a>transactions_pivoted_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">M_2_volume</th>
<th data-quarto-table-cell-role="th">M_3_volume</th>
<th data-quarto-table-cell-role="th">M_4_volume</th>
<th data-quarto-table-cell-role="th">M_5_volume</th>
<th data-quarto-table-cell-role="th">M_6_volume</th>
<th data-quarto-table-cell-role="th">M_7_volume</th>
<th data-quarto-table-cell-role="th">M_8_volume</th>
<th data-quarto-table-cell-role="th">M_9_volume</th>
<th data-quarto-table-cell-role="th">M_10_volume</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">M_4_balance</th>
<th data-quarto-table-cell-role="th">M_5_balance</th>
<th data-quarto-table-cell-role="th">M_6_balance</th>
<th data-quarto-table-cell-role="th">M_7_balance</th>
<th data-quarto-table-cell-role="th">M_8_balance</th>
<th data-quarto-table-cell-role="th">M_9_balance</th>
<th data-quarto-table-cell-role="th">M_10_balance</th>
<th data-quarto-table-cell-role="th">M_11_balance</th>
<th data-quarto-table-cell-role="th">M_12_balance</th>
<th data-quarto-table-cell-role="th">M_13_balance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.00000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>...</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>655.000000</td>
<td>656.000000</td>
<td>656.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2957.942073</td>
<td>-20.828506</td>
<td>1495.61875</td>
<td>393.974543</td>
<td>761.680488</td>
<td>-93.054268</td>
<td>1075.282622</td>
<td>772.085823</td>
<td>1141.034299</td>
<td>-853.279726</td>
<td>...</td>
<td>44487.000457</td>
<td>44093.025915</td>
<td>43331.345427</td>
<td>43424.399695</td>
<td>42349.117073</td>
<td>41577.031250</td>
<td>40435.996951</td>
<td>41314.112366</td>
<td>40707.426829</td>
<td>40562.734909</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>2497.157337</td>
<td>12215.814862</td>
<td>13483.44255</td>
<td>13395.706005</td>
<td>14071.045677</td>
<td>14585.023261</td>
<td>14686.920565</td>
<td>14167.201470</td>
<td>13022.355049</td>
<td>15669.345082</td>
<td>...</td>
<td>20862.899811</td>
<td>20895.453122</td>
<td>20892.297089</td>
<td>20645.878662</td>
<td>20887.157789</td>
<td>20045.315178</td>
<td>19791.385435</td>
<td>20209.080591</td>
<td>19590.811006</td>
<td>20328.581625</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>11.000000</td>
<td>-53499.900000</td>
<td>-54322.50000</td>
<td>-61462.100000</td>
<td>-62718.000000</td>
<td>-67190.700000</td>
<td>-63346.100000</td>
<td>-84970.900000</td>
<td>-70096.100000</td>
<td>-70192.000000</td>
<td>...</td>
<td>-1894.000000</td>
<td>-2081.600000</td>
<td>677.800000</td>
<td>191.200000</td>
<td>-3323.500000</td>
<td>-7.900000</td>
<td>-1047.800000</td>
<td>-1022.500000</td>
<td>-4557.100000</td>
<td>-4472.700000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>1216.000000</td>
<td>-2971.800000</td>
<td>-2742.90000</td>
<td>-2446.525000</td>
<td>-2326.750000</td>
<td>-3516.575000</td>
<td>-2890.675000</td>
<td>-2104.200000</td>
<td>-2365.225000</td>
<td>-4265.650000</td>
<td>...</td>
<td>28419.600000</td>
<td>27667.200000</td>
<td>27119.000000</td>
<td>27351.450000</td>
<td>25553.250000</td>
<td>25851.725000</td>
<td>25130.475000</td>
<td>25493.650000</td>
<td>25199.250000</td>
<td>24986.325000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>2422.500000</td>
<td>750.250000</td>
<td>1118.30000</td>
<td>1156.050000</td>
<td>1121.200000</td>
<td>1028.800000</td>
<td>1083.650000</td>
<td>1361.650000</td>
<td>1141.950000</td>
<td>720.250000</td>
<td>...</td>
<td>43003.000000</td>
<td>42421.850000</td>
<td>41417.900000</td>
<td>42026.950000</td>
<td>40233.550000</td>
<td>39561.250000</td>
<td>37971.150000</td>
<td>38809.200000</td>
<td>38307.800000</td>
<td>37939.250000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>3716.750000</td>
<td>3754.175000</td>
<td>4716.10000</td>
<td>4441.225000</td>
<td>4694.425000</td>
<td>4784.450000</td>
<td>4565.500000</td>
<td>4763.200000</td>
<td>4859.600000</td>
<td>4196.525000</td>
<td>...</td>
<td>57002.550000</td>
<td>56559.625000</td>
<td>54945.550000</td>
<td>57244.150000</td>
<td>54951.900000</td>
<td>54563.500000</td>
<td>52248.425000</td>
<td>51831.250000</td>
<td>52188.700000</td>
<td>51449.450000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>11382.000000</td>
<td>61141.900000</td>
<td>68063.70000</td>
<td>64240.000000</td>
<td>64321.400000</td>
<td>78147.800000</td>
<td>88209.200000</td>
<td>69456.400000</td>
<td>72059.700000</td>
<td>98041.500000</td>
<td>...</td>
<td>116346.100000</td>
<td>112335.700000</td>
<td>109395.200000</td>
<td>111264.300000</td>
<td>106472.800000</td>
<td>108358.900000</td>
<td>132286.300000</td>
<td>108202.400000</td>
<td>112159.300000</td>
<td>111050.900000</td>
</tr>
</tbody>
</table>

<p>8 rows  169 columns</p>
</div>
</div>
</div>
</div>
<div id="bef5ee26" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>matched_non_card_holders_w_issue_date_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">account_district_id</th>
<th data-quarto-table-cell-role="th">account_frequency</th>
<th data-quarto-table-cell-role="th">account_created</th>
<th data-quarto-table-cell-role="th">account_district_name</th>
<th data-quarto-table-cell-role="th">account_region</th>
<th data-quarto-table-cell-role="th">account_inhabitants</th>
<th data-quarto-table-cell-role="th">account_small_municipalities</th>
<th data-quarto-table-cell-role="th">account_medium_municipalities</th>
<th data-quarto-table-cell-role="th">account_large_municipalities</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">loan_amount</th>
<th data-quarto-table-cell-role="th">loan_duration</th>
<th data-quarto-table-cell-role="th">loan_monthly_payments</th>
<th data-quarto-table-cell-role="th">loan_status</th>
<th data-quarto-table-cell-role="th">has_card</th>
<th data-quarto-table-cell-role="th">age_at_card_issuance</th>
<th data-quarto-table-cell-role="th">client_tenure_years_relative</th>
<th data-quarto-table-cell-role="th">age_group</th>
<th data-quarto-table-cell-role="th">loan_status_simplified</th>
<th data-quarto-table-cell-role="th">months_since_account_to_card</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>576</td>
<td>55</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-01</td>
<td>Brno - venkov</td>
<td>south Moravia</td>
<td>157042</td>
<td>49</td>
<td>70</td>
<td>18</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>5.990418</td>
<td>55-70</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>1695</td>
<td>76</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-03</td>
<td>Sumperk</td>
<td>north Moravia</td>
<td>127369</td>
<td>31</td>
<td>32</td>
<td>13</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>True</td>
<td>27.0</td>
<td>5.984942</td>
<td>25-40</td>
<td>NaN</td>
<td>67.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">35</td>
<td>866</td>
<td>9</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-10</td>
<td>Nymburk</td>
<td>central Bohemia</td>
<td>81344</td>
<td>61</td>
<td>23</td>
<td>4</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>5.965777</td>
<td>25-40</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">37</td>
<td>2379</td>
<td>44</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-10</td>
<td>Chrudim</td>
<td>east Bohemia</td>
<td>105606</td>
<td>77</td>
<td>26</td>
<td>7</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>5.965777</td>
<td>25-40</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>1979</td>
<td>26</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-11</td>
<td>Plzen - mesto</td>
<td>west Bohemia</td>
<td>170449</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>5.963039</td>
<td>&lt;25</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3350</td>
<td>5912</td>
<td>45</td>
<td>MONTHLY_ISSUANCE</td>
<td>1996-10-25</td>
<td>Jicin</td>
<td>east Bohemia</td>
<td>77917</td>
<td>85</td>
<td>19</td>
<td>6</td>
<td>...</td>
<td>184620.0</td>
<td>60.0</td>
<td>3077.0</td>
<td>Contract running, OK thus-far</td>
<td>False</td>
<td>NaN</td>
<td>2.176591</td>
<td>25-40</td>
<td>Running</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3356</td>
<td>281</td>
<td>1</td>
<td>MONTHLY_ISSUANCE</td>
<td>1996-10-27</td>
<td>Hl.m. Praha</td>
<td>Prague</td>
<td>1204953</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>True</td>
<td>32.0</td>
<td>2.171116</td>
<td>25-40</td>
<td>NaN</td>
<td>25.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3360</td>
<td>3956</td>
<td>6</td>
<td>MONTHLY_ISSUANCE</td>
<td>1996-10-28</td>
<td>Kutna Hora</td>
<td>central Bohemia</td>
<td>77963</td>
<td>60</td>
<td>23</td>
<td>4</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>True</td>
<td>48.0</td>
<td>2.168378</td>
<td>40-55</td>
<td>NaN</td>
<td>26.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3416</td>
<td>993</td>
<td>6</td>
<td>MONTHLY_ISSUANCE</td>
<td>1996-11-14</td>
<td>Kutna Hora</td>
<td>central Bohemia</td>
<td>77963</td>
<td>60</td>
<td>23</td>
<td>4</td>
<td>...</td>
<td>108720.0</td>
<td>60.0</td>
<td>1812.0</td>
<td>Contract running, OK thus-far</td>
<td>True</td>
<td>32.0</td>
<td>2.121834</td>
<td>25-40</td>
<td>Running</td>
<td>25.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3457</td>
<td>2303</td>
<td>41</td>
<td>MONTHLY_ISSUANCE</td>
<td>1996-11-24</td>
<td>Usti nad Labem</td>
<td>north Bohemia</td>
<td>118650</td>
<td>8</td>
<td>8</td>
<td>5</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>2.094456</td>
<td>&lt;25</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>656 rows  64 columns</p>
</div>
</div>
</div>
</div>
<div id="153c1133" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>agg_transactions_monthly_df.to_csv(<span class="st">"./data/transactions_monthly.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="merge-everything-together" class="level1">
<h1>Merge everything together</h1>
<div id="9ee6eb44" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>golden_record_df <span class="op">=</span> matched_non_card_holders_w_issue_date_df.merge(transactions_pivoted_df, on<span class="op">=</span><span class="st">'account_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> golden_record_df[<span class="st">'client_id'</span>].is_unique, <span class="st">"Each client_id should appear exactly once in the final DataFrame."</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> golden_record_df[<span class="st">'account_id'</span>].is_unique, <span class="st">"Each account_id should appear exactly once in the final DataFrame."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a50fa225" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>golden_record_df.to_csv(<span class="st">"data/bronze_record.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f86ee91d" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>golden_record_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">account_district_id</th>
<th data-quarto-table-cell-role="th">account_created</th>
<th data-quarto-table-cell-role="th">account_inhabitants</th>
<th data-quarto-table-cell-role="th">account_small_municipalities</th>
<th data-quarto-table-cell-role="th">account_medium_municipalities</th>
<th data-quarto-table-cell-role="th">account_large_municipalities</th>
<th data-quarto-table-cell-role="th">account_huge_municipalities</th>
<th data-quarto-table-cell-role="th">account_cities</th>
<th data-quarto-table-cell-role="th">account_ratio_urban_inhabitants</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">M_4_balance</th>
<th data-quarto-table-cell-role="th">M_5_balance</th>
<th data-quarto-table-cell-role="th">M_6_balance</th>
<th data-quarto-table-cell-role="th">M_7_balance</th>
<th data-quarto-table-cell-role="th">M_8_balance</th>
<th data-quarto-table-cell-role="th">M_9_balance</th>
<th data-quarto-table-cell-role="th">M_10_balance</th>
<th data-quarto-table-cell-role="th">M_11_balance</th>
<th data-quarto-table-cell-role="th">M_12_balance</th>
<th data-quarto-table-cell-role="th">M_13_balance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656</td>
<td>6.560000e+02</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>...</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>656.000000</td>
<td>655.000000</td>
<td>656.000000</td>
<td>656.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>2957.942073</td>
<td>37.193598</td>
<td>1994-08-10 07:51:57.073170688</td>
<td>2.580727e+05</td>
<td>39.396341</td>
<td>21.100610</td>
<td>5.704268</td>
<td>1.666159</td>
<td>5.608232</td>
<td>68.719970</td>
<td>...</td>
<td>44487.000457</td>
<td>44093.025915</td>
<td>43331.345427</td>
<td>43424.399695</td>
<td>42349.117073</td>
<td>41577.031250</td>
<td>40435.996951</td>
<td>41314.112366</td>
<td>40707.426829</td>
<td>40562.734909</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">min</td>
<td>11.000000</td>
<td>1.000000</td>
<td>1993-01-01 00:00:00</td>
<td>4.282100e+04</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>33.900000</td>
<td>...</td>
<td>-1894.000000</td>
<td>-2081.600000</td>
<td>677.800000</td>
<td>191.200000</td>
<td>-3323.500000</td>
<td>-7.900000</td>
<td>-1047.800000</td>
<td>-1022.500000</td>
<td>-4557.100000</td>
<td>-4472.700000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25%</td>
<td>1216.000000</td>
<td>14.000000</td>
<td>1993-08-02 12:00:00</td>
<td>8.875700e+04</td>
<td>9.000000</td>
<td>11.000000</td>
<td>3.000000</td>
<td>1.000000</td>
<td>4.000000</td>
<td>52.700000</td>
<td>...</td>
<td>28419.600000</td>
<td>27667.200000</td>
<td>27119.000000</td>
<td>27351.450000</td>
<td>25553.250000</td>
<td>25851.725000</td>
<td>25130.475000</td>
<td>25493.650000</td>
<td>25199.250000</td>
<td>24986.325000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50%</td>
<td>2422.500000</td>
<td>37.000000</td>
<td>1994-05-05 00:00:00</td>
<td>1.198950e+05</td>
<td>34.000000</td>
<td>22.000000</td>
<td>5.000000</td>
<td>1.000000</td>
<td>6.000000</td>
<td>62.600000</td>
<td>...</td>
<td>43003.000000</td>
<td>42421.850000</td>
<td>41417.900000</td>
<td>42026.950000</td>
<td>40233.550000</td>
<td>39561.250000</td>
<td>37971.150000</td>
<td>38809.200000</td>
<td>38307.800000</td>
<td>37939.250000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75%</td>
<td>3716.750000</td>
<td>60.000000</td>
<td>1995-09-17 12:00:00</td>
<td>1.970990e+05</td>
<td>63.000000</td>
<td>30.000000</td>
<td>8.000000</td>
<td>2.000000</td>
<td>8.000000</td>
<td>85.200000</td>
<td>...</td>
<td>57002.550000</td>
<td>56559.625000</td>
<td>54945.550000</td>
<td>57244.150000</td>
<td>54951.900000</td>
<td>54563.500000</td>
<td>52248.425000</td>
<td>51831.250000</td>
<td>52188.700000</td>
<td>51449.450000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">max</td>
<td>11382.000000</td>
<td>77.000000</td>
<td>1996-11-24 00:00:00</td>
<td>1.204953e+06</td>
<td>151.000000</td>
<td>70.000000</td>
<td>20.000000</td>
<td>5.000000</td>
<td>11.000000</td>
<td>100.000000</td>
<td>...</td>
<td>116346.100000</td>
<td>112335.700000</td>
<td>109395.200000</td>
<td>111264.300000</td>
<td>106472.800000</td>
<td>108358.900000</td>
<td>132286.300000</td>
<td>108202.400000</td>
<td>112159.300000</td>
<td>111050.900000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>2497.157337</td>
<td>24.974381</td>
<td>NaN</td>
<td>3.501422e+05</td>
<td>33.780046</td>
<td>14.910694</td>
<td>4.527208</td>
<td>1.023308</td>
<td>2.894141</td>
<td>19.501927</td>
<td>...</td>
<td>20862.899811</td>
<td>20895.453122</td>
<td>20892.297089</td>
<td>20645.878662</td>
<td>20887.157789</td>
<td>20045.315178</td>
<td>19791.385435</td>
<td>20209.080591</td>
<td>19590.811006</td>
<td>20328.581625</td>
</tr>
</tbody>
</table>

<p>8 rows  220 columns</p>
</div>
</div>
</div>
</div>
<div id="fed7a05b" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Number of Clients by Card Issuance Status'</span>)</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>sns.countplot(x<span class="op">=</span><span class="st">'has_card'</span>, data<span class="op">=</span>golden_record_df)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Card Issued'</span>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Count'</span>)</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-85-output-1.png" width="825" height="530" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1611855c" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Distribution of Card Issuance Dates'</span>)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(golden_record_df, x<span class="op">=</span><span class="st">'card_issued'</span>, hue<span class="op">=</span><span class="st">'has_card'</span>, kde<span class="op">=</span><span class="va">True</span>, bins<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Card Issuance Date'</span>)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Count'</span>)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="main_files/figure-html/cell-86-output-1.png" width="815" height="530" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="47a155b1" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>data_reduction</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>OrderedDict([('Total number of accounts', 4500),
             ('Junior Card Holders', -145),
             ('Clients without sufficient history', -419),
             ('Non-cardholders without match', -3280)])</code></pre>
</div>
</div>
<div id="f5f10d1e" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>golden_record_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">account_id</th>
<th data-quarto-table-cell-role="th">account_district_id</th>
<th data-quarto-table-cell-role="th">account_frequency</th>
<th data-quarto-table-cell-role="th">account_created</th>
<th data-quarto-table-cell-role="th">account_district_name</th>
<th data-quarto-table-cell-role="th">account_region</th>
<th data-quarto-table-cell-role="th">account_inhabitants</th>
<th data-quarto-table-cell-role="th">account_small_municipalities</th>
<th data-quarto-table-cell-role="th">account_medium_municipalities</th>
<th data-quarto-table-cell-role="th">account_large_municipalities</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">M_4_balance</th>
<th data-quarto-table-cell-role="th">M_5_balance</th>
<th data-quarto-table-cell-role="th">M_6_balance</th>
<th data-quarto-table-cell-role="th">M_7_balance</th>
<th data-quarto-table-cell-role="th">M_8_balance</th>
<th data-quarto-table-cell-role="th">M_9_balance</th>
<th data-quarto-table-cell-role="th">M_10_balance</th>
<th data-quarto-table-cell-role="th">M_11_balance</th>
<th data-quarto-table-cell-role="th">M_12_balance</th>
<th data-quarto-table-cell-role="th">M_13_balance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>576</td>
<td>55</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-01</td>
<td>Brno - venkov</td>
<td>south Moravia</td>
<td>157042</td>
<td>49</td>
<td>70</td>
<td>18</td>
<td>...</td>
<td>27126.7</td>
<td>35312.4</td>
<td>35433.9</td>
<td>32763.3</td>
<td>30103.6</td>
<td>27455.2</td>
<td>39623.2</td>
<td>41346.8</td>
<td>40646.7</td>
<td>37953.8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1695</td>
<td>76</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-03</td>
<td>Sumperk</td>
<td>north Moravia</td>
<td>127369</td>
<td>31</td>
<td>32</td>
<td>13</td>
<td>...</td>
<td>98674.9</td>
<td>97326.2</td>
<td>105257.0</td>
<td>68223.8</td>
<td>101761.7</td>
<td>62686.1</td>
<td>55853.1</td>
<td>81933.7</td>
<td>79168.4</td>
<td>99457.9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>866</td>
<td>9</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-10</td>
<td>Nymburk</td>
<td>central Bohemia</td>
<td>81344</td>
<td>61</td>
<td>23</td>
<td>4</td>
<td>...</td>
<td>44557.8</td>
<td>43400.0</td>
<td>46437.7</td>
<td>38284.0</td>
<td>30464.7</td>
<td>38555.5</td>
<td>26915.8</td>
<td>33208.3</td>
<td>33189.4</td>
<td>30079.9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2379</td>
<td>44</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-10</td>
<td>Chrudim</td>
<td>east Bohemia</td>
<td>105606</td>
<td>77</td>
<td>26</td>
<td>7</td>
<td>...</td>
<td>26694.2</td>
<td>27584.7</td>
<td>29892.7</td>
<td>30093.1</td>
<td>31091.8</td>
<td>29588.7</td>
<td>31988.2</td>
<td>27748.8</td>
<td>24161.5</td>
<td>21086.2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1979</td>
<td>26</td>
<td>MONTHLY_ISSUANCE</td>
<td>1993-01-11</td>
<td>Plzen - mesto</td>
<td>west Bohemia</td>
<td>170449</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>23144.1</td>
<td>22056.9</td>
<td>20974.1</td>
<td>20795.2</td>
<td>22080.4</td>
<td>20997.5</td>
<td>20768.4</td>
<td>19690.9</td>
<td>18617.9</td>
<td>17968.5</td>
</tr>
</tbody>
</table>

<p>5 rows  232 columns</p>
</div>
</div>
</div>
</div>
<div id="0e9efc3a" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>data_reduction[<span class="st">"Final Golden Record"</span>] <span class="op">=</span> <span class="bu">len</span>(golden_record_df)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>data_reduction</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>OrderedDict([('Total number of accounts', 4500),
             ('Junior Card Holders', -145),
             ('Clients without sufficient history', -419),
             ('Non-cardholders without match', -3280),
             ('Final Golden Record', 656)])</code></pre>
</div>
</div>
<div id="76054e9b" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>data_reduction_df <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(data_reduction.items()), columns<span class="op">=</span>[<span class="st">'Category'</span>, <span class="st">'Amount'</span>])</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'skyblue'</span> <span class="cf">if</span> amt <span class="op">&gt;=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'orange'</span> <span class="cf">for</span> amt <span class="kw">in</span> data_reduction_df[<span class="st">'Amount'</span>]]</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure(go.Waterfall(</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"20"</span>, orientation<span class="op">=</span><span class="st">"v"</span>,</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    measure<span class="op">=</span>[<span class="st">"relative"</span>] <span class="op">*</span> (<span class="bu">len</span>(data_reduction_df) <span class="op">-</span> <span class="dv">1</span>) <span class="op">+</span> [<span class="st">"total"</span>],</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>data_reduction_df[<span class="st">'Category'</span>],</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>    textposition<span class="op">=</span><span class="st">"outside"</span>,</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span>[<span class="ss">f'</span><span class="sc">{</span>amt<span class="sc">:,.0f}</span><span class="ss">'</span> <span class="cf">for</span> amt <span class="kw">in</span> data_reduction_df[<span class="st">'Amount'</span>]],</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>data_reduction_df[<span class="st">'Amount'</span>],</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>    connector<span class="op">=</span>{<span class="st">"line"</span>:{<span class="st">"color"</span>:<span class="st">"black"</span>, <span class="st">"width"</span>:<span class="dv">2</span>}},</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>    decreasing<span class="op">=</span>{<span class="st">"marker"</span>:{<span class="st">"color"</span>:<span class="st">"orange"</span>}},</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>    increasing<span class="op">=</span>{<span class="st">"marker"</span>:{<span class="st">"color"</span>:<span class="st">"skyblue"</span>}},</span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>    totals<span class="op">=</span>{<span class="st">"marker"</span>:{<span class="st">"color"</span>:<span class="st">"skyblue"</span>}},</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Enhanced Data Reduction Waterfall Chart"</span>,</span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>    xaxis<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">"Category"</span>),</span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">"Amount"</span>, <span class="bu">range</span><span class="op">=</span>[<span class="dv">0</span>, <span class="dv">5500</span>]),</span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>    waterfallgap<span class="op">=</span><span class="fl">0.3</span></span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>                            <div id="321d6ca8-e36d-459f-9d10-e695c3334263" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("321d6ca8-e36d-459f-9d10-e695c3334263")) {                    Plotly.newPlot(                        "321d6ca8-e36d-459f-9d10-e695c3334263",                        [{"connector":{"line":{"color":"black","width":2}},"decreasing":{"marker":{"color":"orange"}},"increasing":{"marker":{"color":"skyblue"}},"measure":["relative","relative","relative","relative","total"],"name":"20","orientation":"v","text":["4,500","-145","-419","-3,280","656"],"textposition":"outside","totals":{"marker":{"color":"skyblue"}},"x":["Total number of accounts","Junior Card Holders","Clients without sufficient history","Non-cardholders without match","Final Golden Record"],"y":[4500,-145,-419,-3280,656],"type":"waterfall"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"},"margin":{"b":0,"l":0,"r":0,"t":30}}},"yaxis":{"title":{"text":"Amount"},"range":[0,5500]},"title":{"text":"Enhanced Data Reduction Waterfall Chart"},"xaxis":{"title":{"text":"Category"}},"waterfallgap":0.3},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('321d6ca8-e36d-459f-9d10-e695c3334263');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
</div>
</div>
</section>
<section id="model-construction" class="level1">
<h1>Model Construction</h1>
<div id="68e21d8d" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_validate</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> make_scorer, f1_score, roc_auc_score, precision_score, recall_score</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler, OneHotEncoder</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_evaluate_model(golden_record_df, feature_columns, model, target_column<span class="op">=</span><span class="st">'has_card'</span>, cv<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Trains and evaluates a given model based on specified feature columns using cross-validation.</span></span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a><span class="co">    - golden_record_df: DataFrame containing the Golden Record dataset.</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a><span class="co">    - feature_columns: List of column names to be used as features.</span></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a><span class="co">    - model: The machine learning model to be trained and evaluated.</span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a><span class="co">    - target_column: Name of the target column.</span></span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a><span class="co">    - metrics_summary: Summary of evaluation metrics including mean and standard deviation for accuracy, F1, AUC-ROC, precision, recall.</span></span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> golden_record_df[feature_columns]</span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> golden_record_df[target_column]</span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a>    numerical_features <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> feature_columns <span class="cf">if</span> golden_record_df[col].dtype <span class="kw">in</span> [<span class="st">'int64'</span>, <span class="st">'float64'</span>]]</span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a>    categorical_features <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> feature_columns <span class="cf">if</span> golden_record_df[col].dtype <span class="op">==</span> <span class="st">'object'</span>]</span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a>    numerical_pipeline <span class="op">=</span> Pipeline([</span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'imputer'</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">'mean'</span>)),</span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'scaler'</span>, StandardScaler())</span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb114-33"><a href="#cb114-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-34"><a href="#cb114-34" aria-hidden="true" tabindex="-1"></a>    categorical_pipeline <span class="op">=</span> Pipeline([</span>
<span id="cb114-35"><a href="#cb114-35" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'imputer'</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">'most_frequent'</span>)),</span>
<span id="cb114-36"><a href="#cb114-36" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'onehot'</span>, OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">'ignore'</span>))</span>
<span id="cb114-37"><a href="#cb114-37" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb114-38"><a href="#cb114-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-39"><a href="#cb114-39" aria-hidden="true" tabindex="-1"></a>    preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb114-40"><a href="#cb114-40" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>[</span>
<span id="cb114-41"><a href="#cb114-41" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'num'</span>, numerical_pipeline, numerical_features),</span>
<span id="cb114-42"><a href="#cb114-42" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'cat'</span>, categorical_pipeline, categorical_features)</span>
<span id="cb114-43"><a href="#cb114-43" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb114-44"><a href="#cb114-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-45"><a href="#cb114-45" aria-hidden="true" tabindex="-1"></a>    pipeline <span class="op">=</span> Pipeline([</span>
<span id="cb114-46"><a href="#cb114-46" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb114-47"><a href="#cb114-47" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'model'</span>, model)</span>
<span id="cb114-48"><a href="#cb114-48" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb114-49"><a href="#cb114-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-50"><a href="#cb114-50" aria-hidden="true" tabindex="-1"></a>    scoring <span class="op">=</span> {</span>
<span id="cb114-51"><a href="#cb114-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">'accuracy'</span>: <span class="st">'accuracy'</span>,</span>
<span id="cb114-52"><a href="#cb114-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">'f1'</span>: make_scorer(f1_score),</span>
<span id="cb114-53"><a href="#cb114-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">'roc_auc'</span>: <span class="st">'roc_auc'</span>,</span>
<span id="cb114-54"><a href="#cb114-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">'precision'</span>: make_scorer(precision_score),</span>
<span id="cb114-55"><a href="#cb114-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">'recall'</span>: make_scorer(recall_score)</span>
<span id="cb114-56"><a href="#cb114-56" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb114-57"><a href="#cb114-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-58"><a href="#cb114-58" aria-hidden="true" tabindex="-1"></a>    metrics_summary <span class="op">=</span> cross_validate(pipeline, X, y, scoring<span class="op">=</span>scoring, cv<span class="op">=</span>cv, return_train_score<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb114-59"><a href="#cb114-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-60"><a href="#cb114-60" aria-hidden="true" tabindex="-1"></a>    metrics_report <span class="op">=</span> {}</span>
<span id="cb114-61"><a href="#cb114-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> metric <span class="kw">in</span> scoring.keys():</span>
<span id="cb114-62"><a href="#cb114-62" aria-hidden="true" tabindex="-1"></a>        metrics_report[metric] <span class="op">=</span> {</span>
<span id="cb114-63"><a href="#cb114-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean'</span>: metrics_summary[<span class="ss">f'test_</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">'</span>].mean(),</span>
<span id="cb114-64"><a href="#cb114-64" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std'</span>: metrics_summary[<span class="ss">f'test_</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">'</span>].std()</span>
<span id="cb114-65"><a href="#cb114-65" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb114-66"><a href="#cb114-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">: mean = </span><span class="sc">{</span>metrics_report[metric][<span class="st">'mean'</span>]<span class="sc">:.2f}</span><span class="ss">, std = </span><span class="sc">{</span>metrics_report[metric][<span class="st">'std'</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb114-67"><a href="#cb114-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-68"><a href="#cb114-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> metrics_report</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8f82ee27" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> LogisticRegression(random_state<span class="op">=</span><span class="dv">42</span>, max_iter<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>feature_columns <span class="op">=</span> [</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'age'</span>,</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'client_region'</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>] <span class="op">+</span> [col <span class="cf">for</span> col <span class="kw">in</span> golden_record_df.columns <span class="cf">if</span> <span class="st">'M_'</span> <span class="kw">in</span> col <span class="kw">and</span> (<span class="st">'_balance'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'_volume'</span> <span class="kw">in</span> col)]</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>train_evaluate_model(golden_record_df, feature_columns, model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>accuracy: mean = 0.79, std = 0.06
f1: mean = 0.79, std = 0.06
roc_auc: mean = 0.88, std = 0.04
precision: mean = 0.79, std = 0.06
recall: mean = 0.79, std = 0.07</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>{'accuracy': {'mean': 0.7909090909090909, 'std': 0.05508558502710415},
 'f1': {'mean': 0.7911739310692913, 'std': 0.055562935941218604},
 'roc_auc': {'mean': 0.8753500918273645, 'std': 0.043519879082995275},
 'precision': {'mean': 0.7917767150452161, 'std': 0.06043180966587572},
 'recall': {'mean': 0.7928030303030303, 'std': 0.06608844457911726}}</code></pre>
</div>
</div>
</section>
<section id="model-engineering" class="level1">
<h1>Model Engineering</h1>
</section>
<section id="model-comparison-selection" class="level1">
<h1>Model Comparison &amp; Selection</h1>
<div id="5fbc5d95" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> RandomForestClassifier(random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>train_evaluate_model(golden_record_df, feature_columns, model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>accuracy: mean = 0.83, std = 0.05
f1: mean = 0.84, std = 0.04
roc_auc: mean = 0.88, std = 0.04
precision: mean = 0.78, std = 0.05
recall: mean = 0.91, std = 0.05</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>{'accuracy': {'mean': 0.8259906759906761, 'std': 0.04852498002927482},
 'f1': {'mean': 0.8401283556501674, 'std': 0.04356615352241835},
 'roc_auc': {'mean': 0.8834825528007346, 'std': 0.044855499082503594},
 'precision': {'mean': 0.7806318671787221, 'std': 0.052030365364675805},
 'recall': {'mean': 0.9114583333333334, 'std': 0.04835900824313781}}</code></pre>
</div>
</div>
</section>
<section id="workbench---remove-later" class="level1">
<h1>WORKBENCH - remove later</h1>
<section id="some-older-input" class="level3">
<h3 class="anchored" data-anchor-id="some-older-input">Some older input</h3>
<p>We need some categorical indicator wheter a transactions is a transactions incoming or outgoing from the perspective of the account holder. This will be important for the feature engineering later on. We will create a column called <code>transaction_direction</code> using the amount to engineer this feature.</p>
<p>Balance is the wealth on the account after the transaction.</p>
<p>k_symbol is the purpose of the transaction. This is often use in the context of budgeting in E-Banking applications or just personal finance management. A lot of NA values are present in this column. We will have to deal with this later on and weigh the importance of this column.</p>
<p>Track the time series of a given account to get a better understanding of the datasets nature.</p>
<p>It seems that there can be multiple transactions on the same day. We will have to aggregate the transactions on the same day to get a better understanding of the transactions as the timestamp resolution is not high enough to track the transactions on a daily basis.</p>
<p>We need some handling for this as the ID is not informative as well (Dani).</p>
<p>For the feature enginnering a per month evaluation of the transactions is sufficient (Dani).</p>
<p>We need to make sure across the board that for the prediction we only use the data that is available at the time of the prediction. This means that we can only use the data from the past to predict the future. This is important to keep in mind when we engineer the features as some entities do not have any information about the date and therefore we cannot use them for the prediction as we cannot rule out that they are not from the future.</p>
<p>Frequency analysis of the transactions could be interesting as the hypothesis might be that the more frequent the transactions the more likely the account holder is to be interested in a credit card. Fourier transformation could be used to get a better understanding of the frequency of the transactions.</p>
</section>
<section id="jitt-05.03.24" class="level3">
<h3 class="anchored" data-anchor-id="jitt-05.03.24">JITT 05.03.24</h3>
<ul>
<li>New customers are handled differently</li>
<li>Customer without the required history should be ignored otherwise they are treated as irrelevant</li>
<li>Lag is ignored like (12 + 1) months</li>
<li>Age should be in relation to the time of the event (card issued / reference date for refrence clients)</li>
<li>How old are customers with a Junior Card? This should be evaluated based on the data
<ul>
<li>Example with Junior Card model with Age as most important feature as a negative example</li>
</ul></li>
<li>Reference clients
<ul>
<li>They should not be as similar as possible (Twin brother problem)</li>
<li>Same external market conditions</li>
<li>Same environment</li>
<li>See slide 6</li>
</ul></li>
<li>Owner and disponents cannot be distinguished directly and assumptions are required
<ul>
<li>MasterCards vs Visa war: as much cards as possible for both client of an account</li>
<li>AGain the Twin brother problem as features are too similar possibly</li>
</ul></li>
</ul>
<section id="general-notes-to-self" class="level4">
<h4 class="anchored" data-anchor-id="general-notes-to-self">General notes to self</h4>
<ul>
<li>Visualise monthly product puchases</li>
<li>Viz environment of selected client and reference clients and answer the questions are they from a comparable environment</li>
</ul>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>